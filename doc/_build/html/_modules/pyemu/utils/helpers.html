<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyemu.utils.helpers &#8212; pyEMU 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyemu.utils.helpers</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_colwidth</span> <span class="o">=</span> <span class="mi">100</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">flopy</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">pyemu</span>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span><span class="n">cwd</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
    <span class="n">bwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exe_name</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;window&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exe_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;exe&quot;</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">cmd_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">exe_name</span> <span class="o">+</span> <span class="s2">&quot;.exe&quot;</span>
                <span class="n">cmd_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exe_name</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exe_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
                <span class="n">cmd_str</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span> <span class="o">+</span> <span class="n">cmd_str</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bwd</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;run() raise :</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;run():</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ret_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bwd</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;run() raise :</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bwd</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;window&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;run() returned non-zero&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pilotpoint_prior_builder"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.pilotpoint_prior_builder">[docs]</a><span class="k">def</span> <span class="nf">pilotpoint_prior_builder</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">struct_dict</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;pilotpoint_prior_builder&#39; has been renamed to &quot;</span><span class="o">+</span>\
                  <span class="s2">&quot;&#39;geostatistical_prior_builder&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">geostatistical_prior_builder</span><span class="p">(</span><span class="n">pst</span><span class="o">=</span><span class="n">pst</span><span class="p">,</span><span class="n">struct_dict</span><span class="o">=</span><span class="n">struct_dict</span><span class="p">,</span>
                                        <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span></div>

<div class="viewcode-block" id="geostatistical_prior_builder"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.geostatistical_prior_builder">[docs]</a><span class="k">def</span> <span class="nf">geostatistical_prior_builder</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">struct_dict</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a helper function to construct a full prior covariance matrix using</span>
<span class="sd">    a mixture of geostastical structures an parameter bounds information.</span>
<span class="sd">    Parameters</span>
<span class="sd">        pst : pyemu.Pst instance (or the name of a pst file)</span>
<span class="sd">        struct_dict : a python dict of geostat structure file : list of pp tpl files</span>
<span class="sd">            if the values in the dict are pd.DataFrames, then they must have an</span>
<span class="sd">            &#39;x&#39;,&#39;y&#39;, and &#39;parnme&#39; column.  If the filename ends in &#39;.csv&#39;,</span>
<span class="sd">            then a pd.DataFrame is loaded.</span>
<span class="sd">        sigma_range : float representing the number of standard deviations implied by parameter bounds</span>
<span class="sd">    Returns</span>
<span class="sd">        Cov : pyemu.Cov instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">),</span><span class="s2">&quot;pst arg must be a Pst instance, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
        <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pst</span><span class="p">))</span>
    <span class="n">full_cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="k">for</span> <span class="n">gs</span><span class="p">,</span><span class="n">items</span> <span class="ow">in</span> <span class="n">struct_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">gss</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gss</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using first geostat structure in file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="n">gs</span><span class="p">))</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">pp_tpl_to_dataframe</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;parnme&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not in the columns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="p">),</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the following parameters are not &quot;</span> <span class="o">+</span> \
                              <span class="s2">&quot;in the control file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s2">&quot;zone&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">zones</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
                <span class="n">df_zone</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">zone</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_zone</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">df_zone</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">)</span>
                <span class="c1"># find the variance in the diagonal cov</span>
                <span class="n">tpl_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">),</span>
                                               <span class="nb">list</span><span class="p">(</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">))</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tpl_var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-6</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pilot points pars have different ranges&quot;</span> <span class="o">+</span>\
                                  <span class="s2">&quot; , using max range as variance for all pars&quot;</span><span class="p">)</span>
                <span class="n">tpl_var</span> <span class="o">=</span> <span class="n">tpl_var</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">cov</span> <span class="o">*=</span> <span class="n">tpl_var</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ci</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">inv</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">df_zone</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;prior_builder_crash.csv&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error inverting cov </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">full_cov</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">full_cov</span></div>


<div class="viewcode-block" id="kl_setup"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.kl_setup">[docs]</a><span class="k">def</span> <span class="nf">kl_setup</span><span class="p">(</span><span class="n">num_eig</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="n">struct_file</span><span class="p">,</span><span class="n">array_dict</span><span class="p">,</span><span class="n">basis_file</span><span class="o">=</span><span class="s2">&quot;basis.dat&quot;</span><span class="p">,</span>
             <span class="n">tpl_file</span><span class="o">=</span><span class="s2">&quot;kl.tpl&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup a karhuenen-Loeve based parameterization for a given</span>
<span class="sd">    geostatistical structure.</span>
<span class="sd">    Parameters</span>
<span class="sd">        num_eig (int) : number of basis vectors to retain in the reduced basis</span>

<span class="sd">        struct_file (str) : a pest-style geostatistical structure file</span>

<span class="sd">        array_dict (dict(str:ndarray)): a dict of arrays to setup as KL-based</span>
<span class="sd">                                        parameters.  The key becomes the</span>
<span class="sd">                                        parameter name prefix. The total</span>
<span class="sd">                                        number of parameters is</span>
<span class="sd">                                        len(array_dict) * num_eig</span>

<span class="sd">        basis_file (str) : the name of the binary file where the reduced</span>
<span class="sd">                           basis will be saved</span>

<span class="sd">        tpl_file (str) : the name of the template file to make.  The template</span>
<span class="sd">                         file is a csv file with the parameter names, the</span>
<span class="sd">                         original factor values,and the template entries.</span>
<span class="sd">                         The original values can be used to set the parval1</span>
<span class="sd">                         entries in the control file</span>
<span class="sd">    Returns</span>
<span class="sd">        back_array_dict (dict(str:ndarray)) : a dictionary of back transformed</span>
<span class="sd">                                              arrays.  This is useful to see</span>
<span class="sd">                                              how much &quot;smoothing&quot; is taking</span>
<span class="sd">                                              place compared to the original</span>
<span class="sd">                                              arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error import flopy: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">array</span> <span class="ow">in</span> <span class="n">array_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sr</span><span class="o">.</span><span class="n">nrow</span>
        <span class="k">assert</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sr</span><span class="o">.</span><span class="n">ncol</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num_eig</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">,</span><span class="s2">&quot;name too long:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">struct_file</span><span class="p">)</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">struct_file</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
        <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;i</span><span class="si">{0:04d}</span><span class="s2">j</span><span class="si">{1:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">ncol</span><span class="p">)])</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                               <span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                               <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>

    <span class="n">trunc_basis</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">u</span><span class="p">[:,:</span><span class="n">num_eig</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="c1">#for i in range(num_eig):</span>
    <span class="c1">#    trunc_basis.x[i,:] *= cov.s.x[i]</span>
    <span class="n">trunc_basis</span><span class="o">.</span><span class="n">to_binary</span><span class="p">(</span><span class="n">basis_file</span><span class="p">)</span>
    <span class="c1">#trunc_basis = trunc_basis.T</span>

    <span class="n">back_array_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;name,org_val,new_val</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">array</span> <span class="ow">in</span> <span class="n">array_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mname</span> <span class="o">=</span> <span class="n">name</span><span class="o">+</span><span class="s2">&quot;mean&quot;</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1:20.8E}</span><span class="s2">,~   </span><span class="si">{2}</span><span class="s2">    ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">mname</span><span class="p">))</span>
        <span class="c1">#array -= array.mean()</span>
        <span class="n">array_flat</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
                                  <span class="p">,</span><span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flat&quot;</span><span class="p">],</span><span class="n">row_names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
                                  <span class="n">isdiagonal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">trunc_basis</span> <span class="o">*</span> <span class="n">array_flat</span>
        <span class="n">enames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0}{1:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_eig</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">enames</span><span class="p">,</span><span class="n">factors</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1:20.8E}</span><span class="s2">,~    </span><span class="si">{0}</span><span class="s2">    ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">back_array_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">trunc_basis</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1">#print(array_back)</span>
        <span class="c1">#print(factors.shape)</span>

    <span class="k">return</span> <span class="n">back_array_dict</span></div>


<div class="viewcode-block" id="kl_apply"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.kl_apply">[docs]</a><span class="k">def</span> <span class="nf">kl_apply</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="n">basis_file</span><span class="p">,</span><span class="n">par_to_file_dict</span><span class="p">,</span><span class="n">arr_shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Applies a KL parameterization transform from basis factors to model</span>
<span class="sd">     input arrays</span>
<span class="sd">     Parameters</span>
<span class="sd">        par_file (str) : the csv file to get factor values from.  Must contain</span>
<span class="sd">                        the following columns: name, new_val, org_val</span>
<span class="sd">        basis_file (str): the binary file that contains the reduced basis</span>

<span class="sd">        par_to_file_dict (dict(str:str)): a mapping from KL parameter prefixes</span>
<span class="sd">                                          to array file names.</span>
<span class="sd">    Returns</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">assert</span> <span class="s2">&quot;org_val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">assert</span> <span class="s2">&quot;new_val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">par_to_file_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="s2">&quot;missing prefix:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_binary</span><span class="p">(</span><span class="n">basis_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">arr_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">arr_min</span> <span class="o">=</span> <span class="mf">1.0e-10</span> <span class="c1"># a temp hack</span>

    <span class="n">means</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)),:]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)),:]</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="n">par_to_file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,[</span><span class="s2">&quot;new_val&quot;</span><span class="p">]])</span>
        <span class="n">factors</span><span class="o">.</span><span class="n">autoalign</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">#assert df_pre.shape[0] == arr_shape[0] * arr_shape[1]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">basis</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arr_shape</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">+=</span> <span class="n">means</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">means</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;new_val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">arr</span><span class="o">&lt;</span><span class="n">arr_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_min</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%20.8E</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="zero_order_tikhonov"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.zero_order_tikhonov">[docs]</a><span class="k">def</span> <span class="nf">zero_order_tikhonov</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">parbounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">par_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup preferred-value regularization</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            pst (Pst instance) : the control file instance</span>
<span class="sd">            parbounds (bool) : weight the prior information equations according</span>
<span class="sd">                to parameter bound width - approx the KL transform</span>
<span class="sd">            par_groups (list(str)) : parameter groups to build PI equations</span>
<span class="sd">               for.  If None, all adjustable parameters are used</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">par_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">par_groups</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">par_groups</span>

        <span class="n">pilbl</span><span class="p">,</span> <span class="n">obgnme</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">equation</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;partrans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tied&quot;</span><span class="p">,</span> <span class="s2">&quot;fixed&quot;</span><span class="p">]</span> <span class="ow">and</span>\
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">par_groups</span><span class="p">:</span>
                <span class="n">pilbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;parnme&quot;</span><span class="p">])</span>
                <span class="n">weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">ogp_name</span> <span class="o">=</span> <span class="s2">&quot;regul&quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span>
                <span class="n">obgnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ogp_name</span><span class="p">[:</span><span class="mi">12</span><span class="p">])</span>
                <span class="n">parnme</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
                <span class="n">parval1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parval1&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pt</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                    <span class="n">parnme</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span> <span class="o">+</span> <span class="n">parnme</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                    <span class="n">parval1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">parval1</span><span class="p">)</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="s2">&quot;1.0 * &quot;</span> <span class="o">+</span> <span class="n">parnme</span> <span class="o">+</span> <span class="s2">&quot; =</span><span class="si">{0:15.6E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parval1</span><span class="p">)</span>
                <span class="n">equation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>

        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pilbl&quot;</span><span class="p">:</span> <span class="n">pilbl</span><span class="p">,</span>
                                               <span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="n">equation</span><span class="p">,</span>
                                               <span class="s2">&quot;obgnme&quot;</span><span class="p">:</span> <span class="n">obgnme</span><span class="p">,</span>
                                               <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">parbounds</span><span class="p">:</span>
            <span class="n">regweight_from_parbound</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span></div>


<div class="viewcode-block" id="regweight_from_parbound"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.regweight_from_parbound">[docs]</a><span class="k">def</span> <span class="nf">regweight_from_parbound</span><span class="p">(</span><span class="n">pst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;sets regularization weights from parameter bounds</span>
<span class="sd">        which approximates the KL expansion</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        pst (Pst) : a control file instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">parnme</span>
    <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">pilbl</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">parnme</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">pilbl</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parnme</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parnme</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">lbnd</span><span class="p">,</span><span class="n">ubnd</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;partrans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ubnd</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lbnd</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">ubnd</span> <span class="o">-</span> <span class="n">lbnd</span><span class="p">)</span>
            <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parnme</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;prior information name does not correspond&quot;</span> <span class="o">+</span>\
                  <span class="s2">&quot; to a parameter: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">parnme</span><span class="p">))</span></div>


<div class="viewcode-block" id="first_order_pearson_tikhonov"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.first_order_pearson_tikhonov">[docs]</a><span class="k">def</span> <span class="nf">first_order_pearson_tikhonov</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">abs_drop_tol</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup preferred-difference regularization from a covariance matrix.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            pst (pyemu.Pst) : pst instance</span>
<span class="sd">            cov (pyemu.Cov) : covariance matrix instance</span>
<span class="sd">            reset (bool) : drop all other pi equations.  If False, append to</span>
<span class="sd">                existing pi equations</span>
<span class="sd">            abs_drop_tol (float) : tolerance to control how many pi</span>
<span class="sd">                equations are written.  If the pearson cc is less than</span>
<span class="sd">                abs_drop_tol, it will not be included in the pi equations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="p">)</span>
        <span class="n">cc_mat</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">to_pearson</span><span class="p">()</span>
        <span class="c1">#print(pst.parameter_data.dtypes)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ptrans</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ptrans</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">pi_num</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">pilbl</span><span class="p">,</span> <span class="n">obgnme</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">equation</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">iname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cc_mat</span><span class="o">.</span><span class="n">row_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">iname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">jname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cc_mat</span><span class="o">.</span><span class="n">row_names</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="n">jname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1">#print(i,iname,i+j+1,jname)</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">cc_mat</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="n">abs_drop_tol</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">pilbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pcc_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pi_num</span><span class="p">))</span>
                <span class="n">iiname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptrans</span><span class="p">[</span><span class="n">iname</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                    <span class="n">iiname</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span><span class="o">+</span><span class="n">iname</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                <span class="n">jjname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptrans</span><span class="p">[</span><span class="n">jname</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                    <span class="n">jjname</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span><span class="o">+</span><span class="n">jname</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                <span class="n">equation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;1.0 * </span><span class="si">{0}</span><span class="s2"> - 1.0 * </span><span class="si">{1}</span><span class="s2"> = 0.0&quot;</span><span class="o">.</span>\
                                <span class="nb">format</span><span class="p">(</span><span class="n">iiname</span><span class="p">,</span><span class="n">jjname</span><span class="p">))</span>
                <span class="n">weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                <span class="n">obgnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;regul_cc&quot;</span><span class="p">)</span>
                <span class="n">pi_num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pilbl&quot;</span><span class="p">:</span> <span class="n">pilbl</span><span class="p">,</span><span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="n">equation</span><span class="p">,</span>
                           <span class="s2">&quot;obgnme&quot;</span><span class="p">:</span> <span class="n">obgnme</span><span class="p">,</span><span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pilbl</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>


<div class="viewcode-block" id="start_slaves"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.start_slaves">[docs]</a><span class="k">def</span> <span class="nf">start_slaves</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">exe_rel_path</span><span class="p">,</span><span class="n">pst_rel_path</span><span class="p">,</span><span class="n">num_slaves</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">slave_root</span><span class="o">=</span><span class="s2">&quot;..&quot;</span><span class="p">,</span>
                 <span class="n">port</span><span class="o">=</span><span class="mi">4004</span><span class="p">,</span><span class="n">rel_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">master_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; start a group of pest(++) slaves on the local machine</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        slave_dir : (str) the path to a complete set of input files</span>

<span class="sd">        exe_rel_path : (str) the relative path to the pest(++)</span>
<span class="sd">                        executable from within the slave_dir</span>
<span class="sd">        pst_rel_path : (str) the relative path to the pst file</span>
<span class="sd">                        from within the slave_dir</span>

<span class="sd">        num_slaves : (int) number of slaves to start. defaults to number of cores</span>

<span class="sd">        slave_root : (str) the root to make the new slave directories in</span>

<span class="sd">        rel_path: (str) the relative path to where pest(++) should be run</span>
<span class="sd">                  from within the slave_dir, defaults to the uppermost level of the slave dir</span>
<span class="sd">        local: (bool) flag for using &quot;localhost&quot; instead of hostname on slave command line</span>
<span class="sd">        cleanup: (bool) flag to remove slave directories once processes exit</span>
<span class="sd">        master_dir: (str) name of directory for master instance.  If master_dir</span>
<span class="sd">                    exists, then it will be removed.  If master_dir is None,</span>
<span class="sd">                    no master instance will be started</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">slave_root</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_slaves</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_slaves</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_slaves</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_slaves</span><span class="p">)</span>
    <span class="c1">#assert os.path.exists(os.path.join(slave_dir,rel_path,exe_rel_path))</span>
    <span class="n">exe_verf</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">rel_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">rel_path</span><span class="p">,</span><span class="n">exe_rel_path</span><span class="p">)):</span>
            <span class="c1">#print(&quot;warning: exe_rel_path not verified...hopefully exe is in the PATH var&quot;)</span>
            <span class="n">exe_verf</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">exe_rel_path</span><span class="p">)):</span>
            <span class="c1">#print(&quot;warning: exe_rel_path not verified...hopefully exe is in the PATH var&quot;)</span>
            <span class="n">exe_verf</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">rel_path</span><span class="p">,</span><span class="n">pst_rel_path</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">pst_rel_path</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">exe_rel_path</span><span class="p">)):</span>
        <span class="k">if</span> <span class="s2">&quot;window&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exe_rel_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;exe&quot;</span><span class="p">):</span>
                <span class="n">exe_rel_path</span> <span class="o">=</span> <span class="n">exe_rel_path</span> <span class="o">+</span> <span class="s2">&quot;.exe&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exe_rel_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">):</span>
                <span class="n">exe_rel_path</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span> <span class="o">+</span> <span class="n">exe_rel_path</span>

    <span class="k">if</span> <span class="n">master_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">master_dir</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">master_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">master_dir</span><span class="p">)</span><span class="c1">#, onerror=del_rw)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unable to remove existing master dir:&quot;</span> <span class="o">+</span> \
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master_dir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">master_dir</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">master_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unable to copy files from slave dir: &quot;</span> <span class="o">+</span> \
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> to new slave dir: </span><span class="si">{1}</span><span class="se">\n</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                <span class="nb">format</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">master_dir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">exe_rel_path</span><span class="p">,</span> <span class="n">pst_rel_path</span><span class="p">,</span> <span class="s2">&quot;/h&quot;</span><span class="p">,</span> <span class="s2">&quot;:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">master_dir</span><span class="p">,</span><span class="n">rel_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">master_dir</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;master:</span><span class="si">{0}</span><span class="s2"> in </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">),</span><span class="n">cwd</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
            <span class="n">master_p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="c1">#,stdout=sp.PIPE,stderr=sp.PIPE)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error starting master instance: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span> <span class="c1"># a few cycles to let the master get ready</span>


    <span class="n">tcp_arg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">slave_dirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_slaves</span><span class="p">):</span>
        <span class="n">new_slave_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slave_root</span><span class="p">,</span><span class="s2">&quot;slave_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_slave_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_slave_dir</span><span class="p">)</span><span class="c1">#, onerror=del_rw)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unable to remove existing slave dir:&quot;</span> <span class="o">+</span> \
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_slave_dir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">new_slave_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unable to copy files from slave dir: &quot;</span> <span class="o">+</span> \
                            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> to new slave dir: </span><span class="si">{1}</span><span class="se">\n</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">new_slave_dir</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exe_verf</span><span class="p">:</span>
                <span class="c1"># if rel_path is not None:</span>
                <span class="c1">#     exe_path = os.path.join(rel_path,exe_rel_path)</span>
                <span class="c1"># else:</span>
                <span class="n">exe_path</span> <span class="o">=</span> <span class="n">exe_rel_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exe_path</span> <span class="o">=</span> <span class="n">exe_rel_path</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">exe_path</span><span class="p">,</span> <span class="n">pst_rel_path</span><span class="p">,</span> <span class="s2">&quot;/h&quot;</span><span class="p">,</span> <span class="n">tcp_arg</span><span class="p">]</span>
            <span class="c1">#print(&quot;starting slave in {0} with args: {1}&quot;.format(new_slave_dir,args))</span>
            <span class="k">if</span> <span class="n">rel_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_slave_dir</span><span class="p">,</span><span class="n">rel_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cwd</span> <span class="o">=</span> <span class="n">new_slave_dir</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;slave:</span><span class="si">{0}</span><span class="s2"> in </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">),</span><span class="n">cwd</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">f</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="n">procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error starting slave: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">slave_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_slave_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">master_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># while True:</span>
        <span class="c1">#     line = master_p.stdout.readline()</span>
        <span class="c1">#     if line != &#39;&#39;:</span>
        <span class="c1">#         print(str(line.strip())+&#39;\r&#39;,end=&#39;&#39;)</span>
        <span class="c1">#     if master_p.poll() is not None:</span>
        <span class="c1">#         print(master_p.stdout.readlines())</span>
        <span class="c1">#         break</span>
        <span class="n">master_p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span> <span class="c1"># a few cycles to let the slaves end gracefully</span>
        <span class="c1"># kill any remaining slaves</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cleanup</span><span class="p">:</span>
        <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">slave_dirs</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_summary_distributions"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.plot_summary_distributions">[docs]</a><span class="k">def</span> <span class="nf">plot_summary_distributions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">label_post</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">label_prior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">subplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mf">8.5</span><span class="p">),</span><span class="n">pt_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper function to plot gaussian distrbutions from prior and posterior</span>
<span class="sd">    means and standard deviations</span>
<span class="sd">    :param df: a dataframe and csv file.  Must have columns named:</span>
<span class="sd">    &#39;prior_mean&#39;,&#39;prior_stdev&#39;,&#39;post_mean&#39;,&#39;post_stdev&#39;.  If loaded</span>
<span class="sd">    from a csv file, column 0 is assumed to tbe the index</span>
<span class="sd">    :param ax: matplotlib axis.  If None, and not subplots, then one is created</span>
<span class="sd">    and all distributions are plotted on a single plot</span>
<span class="sd">    :param label_post: flag to add text labels to the peak of the posterior</span>
<span class="sd">    :param label_prior: flag to add text labels to the peak of the prior</span>
<span class="sd">    :param subplots: flag to use subplots.  If True, then 6 axes per page</span>
<span class="sd">    are used and a single prior and posterior is plotted on each</span>
<span class="sd">    :param figsize: matplotlib figure size</span>
<span class="sd">    :return: if subplots, list of figs, list of axes, else, a single axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">subplots</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>


    <span class="k">if</span> <span class="s2">&quot;post_stdev&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;post_var&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;post_stdev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">post_var</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;prior_stdev&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;prior_var&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prior_stdev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">prior_var</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;prior_expt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;prior_mean&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prior_expt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">prior_mean</span>
    <span class="k">if</span> <span class="s2">&quot;post_expt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;post_mean&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;post_expt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">post_mean</span>

    <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_per_page</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">gaussian_distribution</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;post_expt&quot;</span><span class="p">],</span>
                                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;post_stdev&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">pt_color</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label_post</span><span class="p">:</span>
            <span class="n">mx_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">xtxt</span><span class="p">,</span><span class="n">ytxt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mx_idx</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">mx_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.001</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xtxt</span><span class="p">,</span><span class="n">ytxt</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">gaussian_distribution</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;prior_expt&quot;</span><span class="p">],</span>
                                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;prior_stdev&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">label_prior</span><span class="p">:</span>
            <span class="n">mx_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">xtxt</span><span class="p">,</span><span class="n">ytxt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mx_idx</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">mx_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.001</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xtxt</span><span class="p">,</span><span class="n">ytxt</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c1">#ylim = list(ax.get_ylim())</span>
        <span class="c1">#ylim[1] *= 1.2</span>
        <span class="c1">#ylim[0] = 0.0</span>
        <span class="c1">#ax.set_ylim(ylim)</span>
        <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">ax_count</span> <span class="o">&gt;=</span> <span class="n">ax_per_page</span><span class="p">:</span>
                <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">ax_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span>
        <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span><span class="p">,</span> <span class="n">axes</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
    <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.2</span>
    <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="gaussian_distribution"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.gaussian_distribution">[docs]</a><span class="k">def</span> <span class="nf">gaussian_distribution</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="n">stdev</span><span class="p">,</span><span class="n">num_pts</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;for plotting</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xstart</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">stdev</span><span class="p">)</span>
    <span class="n">xend</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">stdev</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xstart</span><span class="p">,</span><span class="n">xend</span><span class="p">,</span><span class="n">num_pts</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">stdev</span><span class="o">*</span><span class="n">stdev</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stdev</span><span class="o">*</span><span class="n">stdev</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span></div>


<div class="viewcode-block" id="read_pestpp_runstorage"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.read_pestpp_runstorage">[docs]</a><span class="k">def</span> <span class="nf">read_pestpp_runstorage</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">irun</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read pars and obs from a specific run in a pest++ serialized run storage file&quot;&quot;&quot;</span>
    <span class="n">header_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s2">&quot;n_runs&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;run_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;p_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;o_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">header_dtype</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p_name_size</span><span class="p">,</span><span class="n">o_name_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;p_name_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;o_name_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">par_names</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_name_size</span><span class="p">),</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">p_name_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">obs_names</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_name_size</span><span class="p">),</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">o_name_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n_runs</span><span class="p">,</span><span class="n">run_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;n_runs&quot;</span><span class="p">],</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;run_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">irun</span> <span class="o">&lt;=</span> <span class="n">n_runs</span>
        <span class="n">run_start</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">run_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">irun</span> <span class="o">*</span> <span class="n">run_size</span><span class="p">))</span>
        <span class="n">r_status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">info_txt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;41s&quot;</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">41</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">par_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">obs_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_names</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">par_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">par_names</span><span class="p">,</span><span class="s2">&quot;parval1&quot;</span><span class="p">:</span><span class="n">par_vals</span><span class="p">})</span>

    <span class="n">par_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">par_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
    <span class="n">obs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;obsnme&quot;</span><span class="p">:</span><span class="n">obs_names</span><span class="p">,</span><span class="s2">&quot;obsval&quot;</span><span class="p">:</span><span class="n">obs_vals</span><span class="p">})</span>
    <span class="n">obs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;obsnme&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">par_df</span><span class="p">,</span><span class="n">obs_df</span></div>


<div class="viewcode-block" id="parse_dir_for_io_files"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.parse_dir_for_io_files">[docs]</a><span class="k">def</span> <span class="nf">parse_dir_for_io_files</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)]</span>
    <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">]</span>
    <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">)]</span>
    <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">,</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span></div>


<div class="viewcode-block" id="pst_from_io_files"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.pst_from_io_files">[docs]</a><span class="k">def</span> <span class="nf">pst_from_io_files</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">,</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span><span class="p">,</span><span class="n">pst_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;generate a Pst instance from the model io files.  If &#39;inschek&#39;</span>
<span class="sd">    is available (either in the current directory or registered</span>
<span class="sd">    with the system variables) and the model output files are available</span>
<span class="sd">    , then the observation values in the control file will be set to the</span>
<span class="sd">    values of the model-simulated equivalents to observations.  This can be</span>
<span class="sd">    useful for testing</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        tpl_files : list[str]</span>
<span class="sd">            list of pest template files</span>
<span class="sd">        in_files : list[str]</span>
<span class="sd">            list of corresponding model input files</span>
<span class="sd">        ins_files : list[str]</span>
<span class="sd">            list of pest instruction files</span>
<span class="sd">        out_files: list[str]</span>
<span class="sd">            list of corresponding model output files</span>
<span class="sd">        pst_filename : str (optional)</span>
<span class="sd">            name of file to write the control file to</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Pst instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">par_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">tpl_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_files</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">),</span><span class="s2">&quot;len(in_files) != len(tpl_files)&quot;</span>

    <span class="k">for</span> <span class="n">tpl_file</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">),</span><span class="s2">&quot;template file not found: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">parse_tpl_file</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">]</span>
        <span class="n">par_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ins_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">ins_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_files</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_files</span><span class="p">),</span><span class="s2">&quot;len(out_files) != len(out_files)&quot;</span>


    <span class="n">obs_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ins_file</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ins_file</span><span class="p">),</span><span class="s2">&quot;instruction file not found: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)</span>
        <span class="n">obs_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">parse_ins_file</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>

    <span class="n">new_pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">generic_pst</span><span class="p">(</span><span class="n">par_names</span><span class="p">,</span><span class="n">obs_names</span><span class="p">)</span>

    <span class="n">new_pst</span><span class="o">.</span><span class="n">template_files</span> <span class="o">=</span> <span class="n">tpl_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span> <span class="n">in_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">instruction_files</span> <span class="o">=</span> <span class="n">ins_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">output_files</span> <span class="o">=</span> <span class="n">out_files</span>

    <span class="c1">#try to run inschek to find the observtion values</span>
    <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">try_run_inschek</span><span class="p">(</span><span class="n">new_pst</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pst_filename</span><span class="p">:</span>
        <span class="n">new_pst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pst_filename</span><span class="p">,</span><span class="n">update_regul</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_pst</span></div>


<span class="n">wildass_guess_par_bounds_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hk&quot;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span><span class="s2">&quot;vka&quot;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span>
                                   <span class="s2">&quot;sy&quot;</span><span class="p">:[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.75</span><span class="p">],</span><span class="s2">&quot;ss&quot;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span>
                                   <span class="s2">&quot;cond&quot;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span><span class="s2">&quot;flux&quot;</span><span class="p">:[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.75</span><span class="p">],</span>
                                   <span class="s2">&quot;rech&quot;</span><span class="p">:[</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">1.25</span><span class="p">],</span><span class="s2">&quot;stage&quot;</span><span class="p">:[</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.1</span><span class="p">],</span>
                                   <span class="p">}</span>

<div class="viewcode-block" id="PstFromFlopyModel"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel">[docs]</a><span class="k">class</span> <span class="nc">PstFromFlopyModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nam_file</span><span class="p">,</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">new_model_ws</span><span class="p">,</span><span class="n">pp_props</span><span class="o">=</span><span class="p">[],</span><span class="n">const_props</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">bc_props</span><span class="o">=</span><span class="p">[],</span><span class="n">grid_props</span><span class="o">=</span><span class="p">[],</span><span class="n">grid_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">zone_props</span><span class="o">=</span><span class="p">[],</span><span class="n">pp_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">par_bounds_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">bc_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">remove_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">k_zone_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mflist_waterbudget</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mfhyd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">hds_kperk</span><span class="o">=</span><span class="p">[],</span><span class="n">use_pp_zones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">obssim_smp_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">external_tpl_in_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">external_ins_out_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">extra_pre_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">extra_model_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">extra_post_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; a monster helper class to setup multiplier parameters for an</span>
<span class="sd">        existing MODFLOW model.  does all kinds of coolness like building a</span>
<span class="sd">        meaningful prior, assigning somewhat meaningful parameter groups and</span>
<span class="sd">        bounds, writes a forward_run.py script with all the calls need to</span>
<span class="sd">        implement multiplier parameters, run MODFLOW and post-process.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;PstFromFlopyModel.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span> <span class="o">=</span> <span class="s2">&quot;_zn&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="o">=</span> <span class="s2">&quot;_gr&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="o">=</span> <span class="s2">&quot;_pp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span> <span class="o">=</span> <span class="s2">&quot;_cn&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span> <span class="o">=</span> <span class="s2">&quot;arr_org&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span> <span class="o">=</span> <span class="s2">&quot;arr_mlt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span> <span class="o">=</span> <span class="s2">&quot;bc_org&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_run_file</span> <span class="o">=</span> <span class="s2">&quot;forward_run.py&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span> <span class="o">=</span> <span class="n">remove_existing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span> <span class="o">=</span> <span class="n">external_tpl_in_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span> <span class="o">=</span> <span class="n">external_ins_out_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_external</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">arr_mult_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span> <span class="o">=</span> <span class="n">par_bounds_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span> <span class="o">=</span> <span class="n">pp_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="o">=</span> <span class="n">pp_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="o">=</span> <span class="n">pp_geostruct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span> <span class="o">=</span> <span class="n">use_pp_zones</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">const_props</span> <span class="o">=</span> <span class="n">const_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_props</span> <span class="o">=</span> <span class="n">bc_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_geostruct</span> <span class="o">=</span> <span class="n">bc_geostruct</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span> <span class="o">=</span> <span class="n">grid_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="o">=</span> <span class="n">grid_geostruct</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zone_props</span> <span class="o">=</span> <span class="n">zone_props</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="o">=</span> <span class="n">obssim_smp_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span> <span class="o">=</span> <span class="n">hds_kperk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_model</span><span class="p">(</span><span class="n">nam_file</span><span class="p">,</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">new_model_ws</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k_zone_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="n">k_zone_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;k_zone_dict layer index not in nlay:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;k_zone_dict arr for k </span><span class="si">{0}</span><span class="s2"> has wrong shape:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span> <span class="o">=</span> <span class="n">k_zone_dict</span>

        <span class="c1"># add any extra commands to the forward run lines</span>

        <span class="k">for</span> <span class="n">alist</span><span class="p">,</span><span class="n">ilist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">extra_pre_cmds</span><span class="p">,</span><span class="n">extra_model_cmds</span><span class="p">,</span><span class="n">extra_post_cmds</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">ilist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ilist</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">ilist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ilist</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">ilist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="n">alist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.run(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

        <span class="c1"># add the model call</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.helpers.run(&#39;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> 1&gt;</span><span class="si">{1}</span><span class="s2">.stdout 2&gt;</span><span class="si">{1}</span><span class="s2">.stderr&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">namefile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">out_files</span> <span class="o">=</span> <span class="p">[],[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_mult_dirs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_bc_pars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_array_pars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_observations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_pst</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_prior</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;saving intermediate _setup_&lt;&gt; dfs into </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;_setup_par_</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">.csv&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;_setup_obs_</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">.csv&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;saving intermediate _setup_&lt;&gt; dfs into </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;all done&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PstFromFlopyModel.setup_mult_dirs"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_mult_dirs">[docs]</a>    <span class="k">def</span> <span class="nf">setup_mult_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># setup dirs to hold the original and multiplier model input quantities</span>
        <span class="n">set_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#if len(self.pp_props) &gt; 0 or len(self.zone_props) &gt; 0 or \</span>
        <span class="c1">#                len(self.grid_props) &gt; 0:</span>
        <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">)</span>
        <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">set_dirs</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up &#39;</span><span class="si">{0}</span><span class="s2">&#39; dir&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;dir &#39;</span><span class="si">{0}</span><span class="s2">&#39; already exists&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up &#39;</span><span class="si">{0}</span><span class="s2">&#39; dir&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_model"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_model">[docs]</a>    <span class="k">def</span> <span class="nf">setup_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nam_file</span><span class="p">,</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">new_model_ws</span><span class="p">):</span>
        <span class="n">split_new_mws</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_new_mws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;new_model_ws can only be 1 folder-level deep:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split_new_mws</span><span class="p">))))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading flopy model&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">flopy</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;from_flopy_model() requires flopy&quot;</span><span class="p">)</span>
        <span class="c1"># prepare the flopy model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span> <span class="o">=</span> <span class="n">org_model_ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_model_ws</span> <span class="o">=</span> <span class="n">new_model_ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nam_file</span><span class="p">,</span><span class="n">model_ws</span><span class="o">=</span><span class="n">org_model_ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">array_free_format</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">free_format_input</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading flopy model&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;&#39;new_model_ws&#39; already exists&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;removing existing &#39;new_model_ws&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">change_model_ws</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">,</span><span class="n">reset_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing new modflow input files&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">write_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing new modflow input files&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.get_count"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.get_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#print(name,c)</span>
        <span class="k">return</span> <span class="n">c</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.prep_mlt_arrays"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.prep_mlt_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">prep_mlt_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">par_props</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">zone_props</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">const_props</span><span class="p">]</span>
        <span class="n">par_suffixs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">]</span>
        <span class="n">mlt_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">par_prop</span><span class="p">,</span><span class="n">suffix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">par_props</span><span class="p">,</span><span class="n">par_suffixs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_prop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_prop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">par_prop</span> <span class="o">=</span> <span class="p">[</span><span class="n">par_prop</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">pakattr</span><span class="p">,</span><span class="n">k_org</span> <span class="ow">in</span> <span class="n">par_prop</span><span class="p">:</span>
                <span class="n">attr_name</span> <span class="o">=</span> <span class="n">pakattr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pak</span><span class="p">,</span><span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pakattr</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
                <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Transient2d</span><span class="p">):</span>
                    <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nper</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">k_parse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_k</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span><span class="n">ks</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error parsing k </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">org</span><span class="p">,</span><span class="n">mlt</span><span class="p">,</span><span class="n">mod</span><span class="p">,</span><span class="n">layer</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
                <span class="n">mlt_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="n">mlt_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.dat</span><span class="si">{1}</span><span class="s2">&quot;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_prefix</span><span class="p">,</span><span class="n">suffix</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_parse</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Util2d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Util3d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Transient2d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">transient_2ds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#big assumption here</span>
                    <span class="n">mod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span><span class="p">,</span><span class="n">fname</span><span class="p">))</span>
                    <span class="n">mlt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlt_name</span><span class="p">)</span>
                    <span class="n">org</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">,</span><span class="n">fname</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;org_file&quot;</span><span class="p">:</span><span class="n">org</span><span class="p">,</span><span class="s2">&quot;mlt_file&quot;</span><span class="p">:</span><span class="n">mlt</span><span class="p">,</span><span class="s2">&quot;model_file&quot;</span><span class="p">:</span><span class="n">mod</span><span class="p">,</span><span class="s2">&quot;layer&quot;</span><span class="p">:</span><span class="n">layer</span><span class="p">})</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suffix</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlt_prefix</span>
                <span class="n">mlt_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlt_dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mlt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">mlt_dfs</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mlt_df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_u2d"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_u2d">[docs]</a>    <span class="k">def</span> <span class="nf">write_u2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u2d</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">u2d</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span>
                   <span class="n">u2d</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_const_tpl"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_const_tpl">[docs]</a>    <span class="k">def</span> <span class="nf">write_const_tpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">zn_array</span><span class="p">):</span>
        <span class="n">parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; 1.0  &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;zone pname too long:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                        <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; ~   </span><span class="si">{0}</span><span class="s2">    ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
        <span class="c1">#df.loc[:,&quot;pargp&quot;] = &quot;{0}{1}&quot;.format(self.cn_suffixname)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_grid_tpl"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_grid_tpl">[docs]</a>    <span class="k">def</span> <span class="nf">write_grid_tpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">zn_array</span><span class="p">):</span>
        <span class="n">parnme</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="p">[],[],[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39; 1.0 &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1:03d}{2:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;grid pname too long:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                        <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39; ~     </span><span class="si">{0}</span><span class="s1">   ~ &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_zone_tpl"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_zone_tpl">[docs]</a>    <span class="k">def</span> <span class="nf">write_zone_tpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">zn_array</span><span class="p">):</span>
        <span class="n">parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; 1.0  &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_zn</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;zone pname too long:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                        <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; ~   </span><span class="si">{0}</span><span class="s2">    ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.grid_prep"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.grid_prep">[docs]</a>    <span class="k">def</span> <span class="nf">grid_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;grid_geostruct is None,&quot;</span>\
                  <span class="s2">&quot; using ExpVario with contribution=1 and a=(max(delc,delr)*10&quot;</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.pp_prep"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.pp_prep">[docs]</a>    <span class="k">def</span> <span class="nf">pp_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mlt_df</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pp_space is None, using 10...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span><span class="o">=</span><span class="mi">10</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pp_geostruct is None,&quot;</span>\
                  <span class="s2">&quot; using ExpVario with contribution=1 and a=(pp_space*max(delr,delc))&quot;</span><span class="p">)</span>
            <span class="n">pp_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">pp_dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>


        <span class="n">pp_df</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">,:]</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">pp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">layer</span><span class="o">==</span><span class="n">l</span><span class="p">,</span><span class="s2">&quot;prefix&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">}</span>
        <span class="n">pp_array_file</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">m</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">pp_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pp_dict: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pp_dict</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling setup_pilot_point_grid()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span><span class="p">:</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)}</span>
        <span class="n">pp_df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_pilotpoints_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                                         <span class="n">ibound</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span>
                                         <span class="n">use_ibound_zones</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span><span class="p">,</span>
                                         <span class="n">prefix_dict</span><span class="o">=</span><span class="n">pp_dict</span><span class="p">,</span>
                                         <span class="n">every_n_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span><span class="p">,</span>
                                         <span class="n">pp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                         <span class="n">tpl_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                         <span class="n">shapename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;pp.shp&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> pilot point parameters created&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pilot point &#39;pargp&#39;:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling setup_pilot_point_grid()&quot;</span><span class="p">)</span>

        <span class="c1"># calc factors for each layer</span>
        <span class="n">pargp</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">pp_dfs_k</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fac_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="n">pargp</span><span class="p">:</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pg</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;something is wrong in fac calcs&quot;</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp_dfs_k</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calculating factors for k=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

                <span class="n">fac_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;pp_k</span><span class="si">{0}</span><span class="s2">.fac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="n">var_file</span> <span class="o">=</span> <span class="n">fac_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.fac&quot;</span><span class="p">,</span><span class="s2">&quot;.var.dat&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving krige variance file:</span><span class="si">{0}</span><span class="s2">&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving krige factors file:</span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fac_file</span><span class="p">))</span>
                <span class="n">pp_df_k</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pg</span><span class="p">]</span>
                <span class="n">ok_pp</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">OrdinaryKrige</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span><span class="p">,</span><span class="n">pp_df_k</span><span class="p">)</span>
                <span class="n">ok_pp</span><span class="o">.</span><span class="n">calc_factors_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span><span class="n">var_filename</span><span class="o">=</span><span class="n">var_file</span><span class="p">,</span>
                                        <span class="n">zone_array</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">ok_pp</span><span class="o">.</span><span class="n">to_grid_factors_file</span><span class="p">(</span><span class="n">fac_file</span><span class="p">)</span>
                <span class="n">fac_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calculating factors for k=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="n">pp_dfs_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df_k</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">fac_file</span> <span class="ow">in</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#pp_files = pp_df.pp_filename.unique()</span>
            <span class="n">fac_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fac_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pp_prefixes</span> <span class="o">=</span> <span class="n">pp_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pp_prefix</span> <span class="ow">in</span> <span class="n">pp_prefixes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing pp_prefix:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pp_prefix</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">pp_prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp_array_file</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not in self.pp_array_file.keys()&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span>
                                              <span class="n">join</span><span class="p">(</span><span class="n">pp_array_file</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>


                <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pp_array_file</span><span class="p">[</span><span class="n">pp_prefix</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">pp_files</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pp_filename</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pp_prefix</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span><span class="s2">&quot;pp_filename&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of pp_files found:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pp_files</span><span class="p">)))</span>
                <span class="n">pp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pp_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
                <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_file</span>
                <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_file</span>

        <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;pp_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span>
                    <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">)),</span><span class="s2">&quot;mlt_file&quot;</span><span class="p">]</span>
        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="k">for</span> <span class="n">out_file</span> <span class="ow">in</span> <span class="n">out_files</span><span class="p">:</span>
            <span class="n">pp_df_pf</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">out_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,:]</span>
            <span class="n">fac_files</span> <span class="o">=</span> <span class="n">pp_df_pf</span><span class="o">.</span><span class="n">fac_file</span>
            <span class="k">if</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of fac files:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fac_files</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
            <span class="n">fac_file</span> <span class="o">=</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pp_files</span> <span class="o">=</span> <span class="n">pp_df_pf</span><span class="o">.</span><span class="n">pp_file</span>
            <span class="k">if</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of pp files:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
            <span class="n">pp_file</span> <span class="o">=</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_array_pars"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_array_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_array_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mlt_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_mlt_arrays</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mlt_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)</span>
        <span class="n">mlt_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1">#for suffix,tpl_file,layer,name in zip(self.mlt_df.suffix,</span>
        <span class="c1">#                                 self.mlt_df.tpl,self.mlt_df.layer,</span>
        <span class="c1">#                                     self.mlt_df.prefix):</span>
        <span class="n">par_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mlt_file</span> <span class="ow">in</span> <span class="n">mlt_files</span><span class="p">:</span>
            <span class="n">suffixes</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of suffixes for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">tpl_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of tpl_files for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">layers</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of layers for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">names</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of names for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing const tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_const_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">ib</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing const tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing grid tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_grid_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">ib</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing grid tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing zone tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_zone_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">ib</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing zone tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par_dfs</span><span class="p">:</span>
                <span class="n">par_dfs</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">par_dfs</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">suf</span><span class="p">,</span><span class="n">dfs</span> <span class="ow">in</span> <span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="n">suf</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up pilot point process&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_prep</span><span class="p">(</span><span class="n">mlt_df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up pilot point process&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up grid process&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_prep</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up grid process&quot;</span><span class="p">)</span>

        <span class="n">mlt_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;arr_pars.csv&quot;</span><span class="p">))</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">mlt_file</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;save test mlt array </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">mlt_file</span><span class="p">),</span>
                       <span class="n">ones</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;save test mlt array </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apply_array_pars</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error test running apply_array_pars():</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.helpers.apply_array_pars()</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_observations"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_observations">[docs]</a>    <span class="k">def</span> <span class="nf">setup_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obs_methods</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_water_budget_obs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_hyd</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">setup_smp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_hob</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_hds</span><span class="p">]</span>
        <span class="n">obs_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mflist water budget obs&quot;</span><span class="p">,</span><span class="s2">&quot;hyd file&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;external obs-sim smp files&quot;</span><span class="p">,</span><span class="s2">&quot;hob&quot;</span><span class="p">,</span><span class="s2">&quot;hds&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">obs_method</span><span class="p">,</span> <span class="n">obs_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_methods</span><span class="p">,</span><span class="n">obs_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing obs type </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_type</span><span class="p">))</span>
            <span class="n">obs_method</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing obs type </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_type</span><span class="p">))</span></div>


<div class="viewcode-block" id="PstFromFlopyModel.build_prior"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.build_prior">[docs]</a>    <span class="k">def</span> <span class="nf">build_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building prior covariance matrix&quot;</span><span class="p">)</span>
        <span class="n">struct_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">]</span>
            <span class="n">pp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">pp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#pp_dfs = [pp_df.loc[pp_df.pargp==pargp,:].copy() for pargp in pp_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_dfs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">gr_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">]</span>
            <span class="n">gr_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">gr_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#gr_dfs = [gr_df.loc[gr_df.pargp==pargp,:].copy() for pargp in gr_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;bc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;bc&quot;</span><span class="p">]</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">timedelta</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#bc_dfs = [bc_df.loc[bc_df.pargp==pargp,:].copy() for pargp in bc_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">geostatistical_prior_builder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span>
                                                         <span class="n">struct_dict</span><span class="o">=</span><span class="n">struct_dict</span><span class="p">,</span>
                                                         <span class="n">sigma_range</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">cov</span><span class="o">.</span><span class="n">to_ascii</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="o">+</span><span class="s2">&quot;.prior.cov&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building prior covariance matrix&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.build_pst"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.build_pst">[docs]</a>    <span class="k">def</span> <span class="nf">build_pst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;changing dir in to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)]</span>
            <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">]</span>
            <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">)]</span>
            <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tpl_file</span><span class="p">,</span><span class="n">in_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tpl_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
            <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="o">.</span><span class="n">from_io_files</span><span class="p">(</span><span class="n">tpl_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">,</span>
                                          <span class="n">in_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span>
                                          <span class="n">ins_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">,</span>
                                          <span class="n">out_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_files</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error build Pst:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
        <span class="c1"># more customization here</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;parnme&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span>
        <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span>
        <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,[</span><span class="n">lw</span><span class="p">,</span><span class="n">up</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wildass_guess_par_bounds_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span>
            <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lw</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,[</span><span class="n">lw</span><span class="p">,</span><span class="n">up</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span>
                <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lw</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">observation_data</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;obsnme&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_pest.pst&quot;</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">model_command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;python forward_run.py&quot;</span><span class="p">]</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">noptmax</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing forward_run.py&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_forward_run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing forward_run.py&quot;</span><span class="p">)</span>

        <span class="n">pst_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;writing pst </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pst_path</span><span class="p">))</span>

        <span class="n">pst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pst_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pst</span> <span class="o">=</span> <span class="n">pst</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;running pestchek on </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="s2">&quot;pestchek </span><span class="si">{0}</span><span class="s2"> &gt;pestchek.stdout&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;error running pestchek:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;pestchek.stdout&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pestcheck:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;running pestchek on </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.add_external"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.add_external">[docs]</a>    <span class="k">def</span> <span class="nf">add_external</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">external_tpl_in_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tpl_file</span><span class="p">,</span><span class="n">in_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find external tpl file:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                       <span class="nb">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;external tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">in_file</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_file</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">external_ins_out_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ins_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find external ins file:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                       <span class="nb">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;external ins:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_file</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;obs listed in </span><span class="si">{0}</span><span class="s2"> will have values listed in </span><span class="si">{1}</span><span class="s2">&quot;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;obs listed in </span><span class="si">{0}</span><span class="s2"> will have generic values&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_forward_run"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_forward_run">[docs]</a>    <span class="k">def</span> <span class="nf">write_forward_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_run_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;import os</span><span class="se">\n</span><span class="s2">import numpy as np</span><span class="se">\n</span><span class="s2">import pandas as pd</span><span class="se">\n</span><span class="s2">import flopy</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;import pyemu</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.parse_k"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.parse_k">[docs]</a>    <span class="k">def</span> <span class="nf">parse_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">vals</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">,</span><span class="s2">&quot;k </span><span class="si">{0}</span><span class="s2"> not in vals&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error slicing vals with </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">k_vals</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.parse_pakattr"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.parse_pakattr">[docs]</a>    <span class="k">def</span> <span class="nf">parse_pakattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pakattr</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">pakattr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;pakattr is wrong:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pakattr</span><span class="p">))</span>
        <span class="n">pakname</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">attrname</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="n">pakname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pak</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;pak </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pakname</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="n">attrname</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="n">attrname</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pak</span><span class="p">,</span><span class="n">attr</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="s2">&quot;stress_period_data&quot;</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">stress_period_data</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">if</span> <span class="n">attrname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;attr </span><span class="si">{0}</span><span class="s2"> not found in dtype.names for </span><span class="si">{1}</span><span class="s2">.stress_period_data&quot;</span><span class="o">.</span>\
                                  <span class="nb">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span><span class="n">pakname</span><span class="p">))</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">stress_period_data</span>
            <span class="k">return</span> <span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">attrname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized attr:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">))</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_bc_pars"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_bc_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_bc_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing bc_props&quot;</span><span class="p">)</span>
        <span class="c1"># if not isinstance(self.bc_prop_dict,dict):</span>
        <span class="c1">#     self.logger.lraise(&quot;bc_prop_dict must be &#39;dict&#39;, not {0}&quot;.</span>
        <span class="c1">#                        format(str(type(self.bc_prop_dict))))</span>
        <span class="n">bc_filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_pak</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_dtype_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_props</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bc_props</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_props</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pakattr</span><span class="p">,</span><span class="n">k_org</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_props</span><span class="p">:</span>
            <span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pakattr</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
            <span class="n">k_parse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_k</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nper</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_parse</span><span class="p">:</span>
                <span class="n">bc_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_helper</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>
                <span class="n">bc_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">pak_name</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">bc_pak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pak_name</span><span class="p">)</span>
                <span class="n">bc_k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">bc_dtype_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>

                <span class="n">bc_parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">_</span><span class="si">{2:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak_name</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing bc_prop_dict&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">bc_filenames</span><span class="p">,</span><span class="s2">&quot;col&quot;</span><span class="p">:</span><span class="n">bc_cols</span><span class="p">,</span>
                           <span class="s2">&quot;kper&quot;</span><span class="p">:</span><span class="n">bc_k</span><span class="p">,</span><span class="s2">&quot;pak&quot;</span><span class="p">:</span><span class="n">bc_pak</span><span class="p">,</span>
                           <span class="s2">&quot;dtype_names&quot;</span><span class="p">:</span><span class="n">bc_dtype_names</span><span class="p">,</span>
                          <span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">bc_parnme</span><span class="p">})</span>
        <span class="n">tds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">perlen</span><span class="o">.</span><span class="n">array</span><span class="p">),</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">dts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">_start_datetime</span><span class="p">)</span> <span class="o">+</span> <span class="n">tds</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dts</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;timedelta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tds</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1">#df.loc[:,&quot;kper&quot;] = df.kper.apply(np.int)</span>
        <span class="c1">#df.loc[:,&quot;parnme&quot;] = df.apply(lambda x: &quot;{0}{1}_{2:03d}&quot;.format(x.pak,x.col,x.kper),axis=1)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;~   </span><span class="si">{0}</span><span class="s2">   ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;bc_org&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;model_ext_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span><span class="s2">&quot;dtype_names&quot;</span><span class="p">,</span><span class="s2">&quot;bc_org&quot;</span><span class="p">,</span><span class="s2">&quot;model_ext_path&quot;</span><span class="p">,</span><span class="s2">&quot;col&quot;</span><span class="p">,</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span><span class="s2">&quot;pak&quot;</span><span class="p">,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">names</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;bc_pars.dat&quot;</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tpl_str</span>
        <span class="n">tpl_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s1">&#39;bc_pars.dat.tpl&#39;</span><span class="p">)</span>
        <span class="n">f_tpl</span> <span class="o">=</span>  <span class="nb">open</span><span class="p">(</span><span class="n">tpl_name</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f_tpl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f_tpl</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">names</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f_tpl</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;bc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apply_bc_pars</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error test running apply_bc_pars():</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.helpers.apply_bc_pars()</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mf">180.0</span><span class="p">)</span> <span class="c1"># 180 correlation length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bc_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.bc_helper"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.bc_helper">[docs]</a>    <span class="k">def</span> <span class="nf">bc_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">col</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">filename_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">filename_model</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filename_model</span></div>


<div class="viewcode-block" id="PstFromFlopyModel.setup_hds"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_hds">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">.gw_utils</span> <span class="k">import</span> <span class="n">setup_hds_obs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">]</span>
        <span class="n">oc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="s2">&quot;OC&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;can&#39;t find OC package in model to setup hds grid obs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">oc</span><span class="o">.</span><span class="n">savehead</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;OC not saving hds, can&#39;t setup grid obs&quot;</span><span class="p">)</span>
        <span class="n">hds_unit</span> <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">iuhead</span>
        <span class="n">hds_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">hds_unit</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">)),</span>\
        <span class="s2">&quot;couldn&#39;t find existing hds file </span><span class="si">{0}</span><span class="s2"> in org_model_ws&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">))</span>
        <span class="n">inact</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lpf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lpf</span><span class="o">.</span><span class="n">hdry</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">upw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">upw</span><span class="o">.</span><span class="n">hdry</span>
        <span class="k">if</span> <span class="n">inact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">hnoflo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">hnoflo</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">==</span> <span class="n">inact</span>
        <span class="n">setup_hds_obs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">),</span>
                      <span class="n">kperk_pairs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">,</span><span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_smp"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_smp">[docs]</a>    <span class="k">def</span> <span class="nf">setup_smp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">obs_smp</span><span class="p">,</span><span class="n">sim_smp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> smp files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">,</span><span class="n">sim_smp</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find obs smp: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find sim smp: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">))</span>
            <span class="n">new_obs_smp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">,</span><span class="n">new_obs_smp</span><span class="p">)</span>
            <span class="n">new_sim_smp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">,</span><span class="n">new_sim_smp</span><span class="p">)</span>
            <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">smp_to_ins</span><span class="p">(</span><span class="n">new_sim_smp</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_hob"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_hob">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hob</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">hob_out_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hob</span><span class="o">.</span><span class="n">iuhobsv</span>
        <span class="n">hob_out_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_output_attribute</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">hob_out_unit</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;could not find hob out file: </span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">hob_df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">modflow_hob_to_instruction_file</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;hob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hob_df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_hyd"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_hyd">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hyd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hyd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">org_hyd_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.hyd.bin&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;can&#39;t find existing hyd out file:</span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">new_hyd_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">,</span><span class="n">new_hyd_out</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">modflow_hydmod_to_instruction_file</span><span class="p">(</span><span class="n">new_hyd_out</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.modflow_read_hydmod_file(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_hyd_out</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;hyd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_water_budget_obs"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_water_budget_obs">[docs]</a>    <span class="k">def</span> <span class="nf">setup_water_budget_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">org_listfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_model_ws</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.list&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;can&#39;t find existing list file:</span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">list_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.list&quot;</span><span class="p">)</span>
        <span class="n">flx_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;flux.dat&quot;</span><span class="p">)</span>
        <span class="n">vol_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;vol.dat&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_mflist_budget_obs</span><span class="p">(</span><span class="n">list_file</span><span class="p">,</span>
                                                            <span class="n">flx_filename</span><span class="o">=</span><span class="n">flx_file</span><span class="p">,</span>
                                                            <span class="n">vol_filename</span><span class="o">=</span><span class="n">vol_file</span><span class="p">,</span>
                                                            <span class="n">start_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;wb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;try:</span><span class="se">\n</span><span class="s2">    os.remove(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">except:</span><span class="se">\n</span><span class="s2">    pass&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">list_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.apply_mflist_budget_obs(&#39;</span><span class="si">{0}</span><span class="s2">&#39;,flx_filename=&#39;</span><span class="si">{1}</span><span class="s2">&#39;,vol_filename=&#39;</span><span class="si">{2}</span><span class="s2">&#39;,start_datetime=&#39;</span><span class="si">{3}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">list_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">flx_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vol_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="apply_array_pars"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.apply_array_pars">[docs]</a><span class="k">def</span> <span class="nf">apply_array_pars</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;arr_pars.csv&quot;</span><span class="p">)</span>
    <span class="c1"># for fname in df.model_file:</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         os.remove(fname)</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         print(&quot;error removing mult array:{0}&quot;.format(fname))</span>
    <span class="k">if</span> <span class="s2">&quot;pp_file&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pp_file</span><span class="p">,</span><span class="n">fac_file</span><span class="p">,</span><span class="n">mlt_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pp_file</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">fac_file</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">pp_file</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">fac2real</span><span class="p">(</span><span class="n">pp_file</span><span class="o">=</span><span class="n">pp_file</span><span class="p">,</span><span class="n">factors_file</span><span class="o">=</span><span class="n">fac_file</span><span class="p">,</span>
                                    <span class="n">out_file</span><span class="o">=</span><span class="n">mlt_file</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">model_file</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">model_file</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="c1"># find all mults that need to be applied to this array</span>
        <span class="n">df_mf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">model_file</span><span class="o">==</span><span class="n">model_file</span><span class="p">,:]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">org_file</span> <span class="o">=</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">org_file</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">org_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;wrong number of org_files for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                            <span class="nb">format</span><span class="p">(</span><span class="n">model_file</span><span class="p">))</span>
        <span class="n">org_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">org_file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">mlt</span> <span class="ow">in</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">:</span>
            <span class="n">org_arr</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span><span class="n">org_arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="apply_bc_pars"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.helpers.apply_bc_pars">[docs]</a><span class="k">def</span> <span class="nf">apply_bc_pars</span><span class="p">():</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;bc_pars.dat&quot;</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">df_fname</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">filename</span><span class="o">==</span><span class="n">fname</span><span class="p">,:]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">df_fname</span><span class="o">.</span><span class="n">dtype_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">bc_org</span> <span class="o">=</span> <span class="n">df_fname</span><span class="o">.</span><span class="n">bc_org</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">model_ext_path</span> <span class="o">=</span> <span class="n">df_fname</span><span class="o">.</span><span class="n">model_ext_path</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bc_org</span><span class="p">,</span><span class="n">fname</span><span class="p">),</span>
                              <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df_fname</span><span class="o">.</span><span class="n">col</span><span class="p">,</span><span class="n">df_fname</span><span class="o">.</span><span class="n">val</span><span class="p">):</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">val</span>
        <span class="n">fmts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="s2">&quot;j&quot;</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="s2">&quot;inode&quot;</span><span class="p">]:</span>
                <span class="n">fmts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">IFMT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">FFMT</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ext_path</span><span class="p">,</span><span class="n">fname</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">df_list</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">formatters</span><span class="o">=</span><span class="n">fmts</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>
            <span class="c1">#df_list.to_csv(os.path.join(model_ext_path,fname),index=False,header=False)</span>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Jeremy White.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>
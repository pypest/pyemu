
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyemu.utils.helpers &#8212; pyEMU 0.3 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyemu.utils.helpers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; module with high-level functions to help</span>
<span class="sd">perform complex tasks</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_colwidth</span> <span class="o">=</span> <span class="mi">100</span>
<span class="kn">from</span> <span class="nn">..pyemu_warnings</span> <span class="k">import</span> <span class="n">PyemuWarning</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">flopy</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">pyemu</span>
<span class="kn">from</span> <span class="nn">pyemu.utils.os_utils</span> <span class="k">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">start_slaves</span>

<div class="viewcode-block" id="remove_readonly"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.remove_readonly">[docs]</a><span class="k">def</span> <span class="nf">remove_readonly</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">excinfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;remove readonly dirs, apparently only a windows issue</span>
<span class="sd">    add to all rmtree calls: shutil.rmtree(*,onerror=remove_readonly), wk</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        func : object</span>
<span class="sd">            func</span>
<span class="sd">        path : str</span>
<span class="sd">            path</span>
<span class="sd">        excinfo : object</span>
<span class="sd">            info</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span> <span class="c1">#stat.S_IWRITE==128==normal</span>
    <span class="n">func</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span><span class="n">cwd</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; an OS agnostic function to execute command</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmd_str : str</span>
<span class="sd">        the str to execute with os.system()</span>

<span class="sd">    cwd : str</span>
<span class="sd">        the directory to execute the command in</span>

<span class="sd">    verbose : bool</span>
<span class="sd">        flag to echo to stdout complete cmd str</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    uses platform to detect OS and adds .exe or ./ as appropriate</span>

<span class="sd">    for Windows, if os.system returns non-zero, raises exception</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;pyemu.helpers.run(&quot;pestpp pest.pst&quot;)``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;run() has moved to pyemu.os_utils&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="n">pyemu</span><span class="o">.</span><span class="n">os_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_str</span><span class="o">=</span><span class="n">cmd_str</span><span class="p">,</span><span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="geostatistical_draws"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.geostatistical_draws">[docs]</a><span class="k">def</span> <span class="nf">geostatistical_draws</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">struct_dict</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a helper function to construct a parameter ensenble from a full prior covariance matrix</span>
<span class="sd">    implied by the geostatistical structure(s) in struct_dict.  This function is much more efficient</span>
<span class="sd">    for problems with lots of pars (&gt;200K).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pst : pyemu.Pst</span>
<span class="sd">        a control file (or the name of control file)</span>
<span class="sd">    struct_dict : dict</span>
<span class="sd">        a python dict of GeoStruct (or structure file), and list of pp tpl files pairs</span>
<span class="sd">        If the values in the dict are pd.DataFrames, then they must have an</span>
<span class="sd">        &#39;x&#39;,&#39;y&#39;, and &#39;parnme&#39; column.  If the filename ends in &#39;.csv&#39;,</span>
<span class="sd">        then a pd.DataFrame is loaded, otherwise a pilot points file is loaded.</span>
<span class="sd">    num_reals : int</span>
<span class="sd">        number of realizations to draw.  Default is 100</span>
<span class="sd">    sigma_range : float</span>
<span class="sd">        a float representing the number of standard deviations implied by parameter bounds.</span>
<span class="sd">        Default is 4.0, which implies 95% confidence parameter bounds.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        flag for stdout.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    par_ens : pyemu.ParameterEnsemble</span>


<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;pst = pyemu.Pst(&quot;pest.pst&quot;)``</span>

<span class="sd">    ``&gt;&gt;&gt;sd = {&quot;struct.dat&quot;:[&quot;hkpp.dat.tpl&quot;,&quot;vka.dat.tpl&quot;]}``</span>

<span class="sd">    ``&gt;&gt;&gt;pe = pyemu.helpers.geostatistical_draws(pst,struct_dict=sd,num_reals=100)``</span>

<span class="sd">    ``&gt;&gt;&gt;pe.to_csv(&quot;par_ensemble.csv&quot;)``</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">),</span><span class="s2">&quot;pst arg must be a Pst instance, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
        <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pst</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;building diagonal cov&quot;</span><span class="p">)</span>

    <span class="n">full_cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>
    <span class="n">full_cov_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">col_names</span><span class="p">,</span> <span class="n">full_cov</span><span class="o">.</span><span class="n">x</span><span class="p">)}</span>

    <span class="n">par_org</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">copy</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="n">par_ens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pars_in_cov</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">gs</span><span class="p">,</span><span class="n">items</span> <span class="ow">in</span> <span class="n">struct_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing &quot;</span><span class="p">,</span><span class="n">gs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">gss</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gss</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using first geostat structure in file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="n">gs</span><span class="p">),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">pp_tpl_to_dataframe</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;pargp&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;working on pargroups </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;parnme&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not in the columns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="p">),</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the following parameters are not &quot;</span> <span class="o">+</span> \
                              <span class="s2">&quot;in the control file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s2">&quot;zone&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">zones</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
                <span class="n">df_zone</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">zone</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_zone</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;build cov matrix&quot;</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">df_zone</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting diag var cov&quot;</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#tpl_var = np.diag(full_cov.get(list(df_zone.parnme)).x).max()</span>
                <span class="n">tpl_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">full_cov_dict</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span> <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scaling full cov by diag var cov&quot;</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">*=</span> <span class="n">tpl_var</span>
                <span class="c1"># no fixed values here</span>
                <span class="n">pe</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">ParameterEnsemble</span><span class="o">.</span><span class="n">from_gaussian_draw</span><span class="p">(</span><span class="n">pst</span><span class="o">=</span><span class="n">pst</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="n">num_reals</span><span class="p">,</span>
                                                                <span class="n">group_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fill_fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1">#df = pe.iloc[:,:]</span>
                <span class="n">par_ens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pe</span><span class="p">))</span>
                <span class="n">pars_in_cov</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;adding remaining parameters to diagonal&quot;</span><span class="p">)</span>
    <span class="n">fset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fset</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">pars_in_cov</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">)}</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">full_cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">name_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">]))</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span><span class="n">isdiagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#cov = full_cov.get(diff,diff)</span>
        <span class="c1"># here we fill in the fixed values</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">ParameterEnsemble</span><span class="o">.</span><span class="n">from_gaussian_draw</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="n">num_reals</span><span class="p">,</span>
                                                        <span class="n">fill_fixed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">par_ens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pe</span><span class="p">))</span>
    <span class="n">par_ens</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">par_ens</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">par_ens</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">ParameterEnsemble</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">par_ens</span><span class="p">,</span><span class="n">pst</span><span class="o">=</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">par_ens</span></div>


<div class="viewcode-block" id="pilotpoint_prior_builder"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.pilotpoint_prior_builder">[docs]</a><span class="k">def</span> <span class="nf">pilotpoint_prior_builder</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">struct_dict</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;pilotpoint_prior_builder&#39; has been renamed to &quot;</span><span class="o">+</span>\
                  <span class="s2">&quot;&#39;geostatistical_prior_builder&#39;&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">geostatistical_prior_builder</span><span class="p">(</span><span class="n">pst</span><span class="o">=</span><span class="n">pst</span><span class="p">,</span><span class="n">struct_dict</span><span class="o">=</span><span class="n">struct_dict</span><span class="p">,</span>
                                        <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span></div>

<div class="viewcode-block" id="sparse_geostatistical_prior_builder"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.sparse_geostatistical_prior_builder">[docs]</a><span class="k">def</span> <span class="nf">sparse_geostatistical_prior_builder</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">struct_dict</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a helper function to construct a full prior covariance matrix using</span>
<span class="sd">    a mixture of geostastical structures and parameter bounds information.</span>
<span class="sd">    The covariance of parameters associated with geostatistical structures is defined</span>
<span class="sd">    as a mixture of GeoStruct and bounds.  That is, the GeoStruct is used to construct a</span>
<span class="sd">    pyemu.Cov, then the entire pyemu.Cov is scaled by the uncertainty implied by the bounds and</span>
<span class="sd">    sigma_range. Sounds complicated...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pst : pyemu.Pst</span>
<span class="sd">        a control file (or the name of control file)</span>
<span class="sd">    struct_dict : dict</span>
<span class="sd">        a python dict of GeoStruct (or structure file), and list of pp tpl files pairs</span>
<span class="sd">        If the values in the dict are pd.DataFrames, then they must have an</span>
<span class="sd">        &#39;x&#39;,&#39;y&#39;, and &#39;parnme&#39; column.  If the filename ends in &#39;.csv&#39;,</span>
<span class="sd">        then a pd.DataFrame is loaded, otherwise a pilot points file is loaded.</span>
<span class="sd">    sigma_range : float</span>
<span class="sd">        a float representing the number of standard deviations implied by parameter bounds.</span>
<span class="sd">        Default is 4.0, which implies 95% confidence parameter bounds.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        flag for stdout.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Cov : pyemu.SparseMatrix</span>
<span class="sd">        a sparse covariance matrix that includes all adjustable parameters in the control</span>
<span class="sd">        file.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;pst = pyemu.Pst(&quot;pest.pst&quot;)``</span>

<span class="sd">    ``&gt;&gt;&gt;sd = {&quot;struct.dat&quot;:[&quot;hkpp.dat.tpl&quot;,&quot;vka.dat.tpl&quot;]}``</span>

<span class="sd">    ``&gt;&gt;&gt;cov = pyemu.helpers.sparse_geostatistical_prior_builder(pst,struct_dict=sd)``</span>

<span class="sd">    ``&gt;&gt;&gt;cov.to_coo(&quot;prior.jcb&quot;)``</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">),</span><span class="s2">&quot;pst arg must be a Pst instance, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
        <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pst</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;building diagonal cov&quot;</span><span class="p">)</span>
    <span class="n">full_cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>

    <span class="n">full_cov_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">col_names</span><span class="p">,</span><span class="n">full_cov</span><span class="o">.</span><span class="n">x</span><span class="p">)}</span>

    <span class="n">full_cov</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="k">for</span> <span class="n">gs</span><span class="p">,</span><span class="n">items</span> <span class="ow">in</span> <span class="n">struct_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing &quot;</span><span class="p">,</span><span class="n">gs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">gss</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gss</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using first geostat structure in file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="n">gs</span><span class="p">),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">pp_tpl_to_dataframe</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;parnme&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not in the columns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="p">),</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the following parameters are not &quot;</span> <span class="o">+</span> \
                              <span class="s2">&quot;in the control file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s2">&quot;zone&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">zones</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
                <span class="n">df_zone</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">zone</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_zone</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;build cov matrix&quot;</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">sparse_covariance_matrix</span><span class="p">(</span><span class="n">df_zone</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting diag var cov&quot;</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#tpl_var = np.diag(full_cov.get(list(df_zone.parnme)).x).max()</span>
                <span class="n">tpl_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">full_cov_dict</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span> <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scaling full cov by diag var cov&quot;</span><span class="p">)</span>
                <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">data</span> <span class="o">*=</span> <span class="n">tpl_var</span>

                <span class="k">if</span> <span class="n">full_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">full_cov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extending SparseMatix&quot;</span><span class="p">)</span>
                    <span class="n">full_cov</span><span class="o">.</span><span class="n">block_extend_ip</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;adding remaining parameters to diagonal&quot;</span><span class="p">)</span>
    <span class="n">fset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">)</span>
    <span class="n">pset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">par_names</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pset</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">fset</span><span class="p">))</span>
    <span class="n">diff</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">full_cov_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">])</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">coo</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">vals</span><span class="p">,(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)),</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">SparseMatrix</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">coo</span><span class="p">,</span><span class="n">row_names</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span><span class="n">col_names</span><span class="o">=</span><span class="n">diff</span><span class="p">)</span>
    <span class="n">full_cov</span><span class="o">.</span><span class="n">block_extend_ip</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">full_cov</span></div>

<div class="viewcode-block" id="geostatistical_prior_builder"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.geostatistical_prior_builder">[docs]</a><span class="k">def</span> <span class="nf">geostatistical_prior_builder</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">struct_dict</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                 <span class="n">par_knowledge_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a helper function to construct a full prior covariance matrix using</span>
<span class="sd">    a mixture of geostastical structures and parameter bounds information.</span>
<span class="sd">    The covariance of parameters associated with geostatistical structures is defined</span>
<span class="sd">    as a mixture of GeoStruct and bounds.  That is, the GeoStruct is used to construct a</span>
<span class="sd">    pyemu.Cov, then the entire pyemu.Cov is scaled by the uncertainty implied by the bounds and</span>
<span class="sd">    sigma_range. Sounds complicated...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pst : pyemu.Pst</span>
<span class="sd">        a control file (or the name of control file)</span>
<span class="sd">    struct_dict : dict</span>
<span class="sd">        a python dict of GeoStruct (or structure file), and list of pp tpl files pairs</span>
<span class="sd">        If the values in the dict are pd.DataFrames, then they must have an</span>
<span class="sd">        &#39;x&#39;,&#39;y&#39;, and &#39;parnme&#39; column.  If the filename ends in &#39;.csv&#39;,</span>
<span class="sd">        then a pd.DataFrame is loaded, otherwise a pilot points file is loaded.</span>
<span class="sd">    sigma_range : float</span>
<span class="sd">        a float representing the number of standard deviations implied by parameter bounds.</span>
<span class="sd">        Default is 4.0, which implies 95% confidence parameter bounds.</span>
<span class="sd">    par_knowledge_dict : dict</span>
<span class="sd">        used to condition on existing knowledge about parameters.  This functionality is</span>
<span class="sd">        currently in dev - don&#39;t use it.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        stdout flag</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Cov : pyemu.Cov</span>
<span class="sd">        a covariance matrix that includes all adjustable parameters in the control</span>
<span class="sd">        file.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;pst = pyemu.Pst(&quot;pest.pst&quot;)``</span>

<span class="sd">    ``&gt;&gt;&gt;sd = {&quot;struct.dat&quot;:[&quot;hkpp.dat.tpl&quot;,&quot;vka.dat.tpl&quot;]}``</span>

<span class="sd">    ``&gt;&gt;&gt;cov = pyemu.helpers.geostatistical_prior_builder(pst,struct_dict=sd)``</span>

<span class="sd">    ``&gt;&gt;&gt;cov.to_ascii(&quot;prior.cov&quot;)``</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">),</span><span class="s2">&quot;pst arg must be a Pst instance, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
        <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pst</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;building diagonal cov&quot;</span><span class="p">)</span>
    <span class="n">full_cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>

    <span class="n">full_cov_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">col_names</span><span class="p">,</span><span class="n">full_cov</span><span class="o">.</span><span class="n">x</span><span class="p">)}</span>
    <span class="c1">#full_cov = None</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="k">for</span> <span class="n">gs</span><span class="p">,</span><span class="n">items</span> <span class="ow">in</span> <span class="n">struct_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing &quot;</span><span class="p">,</span><span class="n">gs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">gss</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gss</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using first geostat structure in file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="n">gs</span><span class="p">),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">pp_tpl_to_dataframe</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;parnme&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not in the columns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="p">),</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the following parameters are not &quot;</span> <span class="o">+</span> \
                              <span class="s2">&quot;in the control file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s2">&quot;zone&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">zones</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
                <span class="n">df_zone</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">zone</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_zone</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;build cov matrix&quot;</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">df_zone</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
                <span class="c1"># find the variance in the diagonal cov</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting diag var cov&quot;</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#tpl_var = np.diag(full_cov.get(list(df_zone.parnme)).x).max()</span>
                <span class="n">tpl_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">full_cov_dict</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span> <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">])</span>
                <span class="c1">#if np.std(tpl_var) &gt; 1.0e-6:</span>
                <span class="c1">#    warnings.warn(&quot;pars have different ranges&quot; +\</span>
                <span class="c1">#                  &quot; , using max range as variance for all pars&quot;)</span>
                <span class="c1">#tpl_var = tpl_var.max()</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scaling full cov by diag var cov&quot;</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">*=</span> <span class="n">tpl_var</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test for inversion&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ci</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">inv</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">df_zone</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;prior_builder_crash.csv&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error inverting cov </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>

                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;replace in full cov&#39;</span><span class="p">)</span>
                <span class="n">full_cov</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
                <span class="c1"># d = np.diag(full_cov.x)</span>
                <span class="c1"># idx = np.argwhere(d==0.0)</span>
                <span class="c1"># for i in idx:</span>
                <span class="c1">#     print(full_cov.names[i])</span>

    <span class="k">if</span> <span class="n">par_knowledge_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">full_cov</span> <span class="o">=</span> <span class="n">condition_on_par_knowledge</span><span class="p">(</span><span class="n">full_cov</span><span class="p">,</span>
                    <span class="n">par_knowledge_dict</span><span class="o">=</span><span class="n">par_knowledge_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">full_cov</span></div>



<div class="viewcode-block" id="condition_on_par_knowledge"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.condition_on_par_knowledge">[docs]</a><span class="k">def</span> <span class="nf">condition_on_par_knowledge</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span><span class="n">par_knowledge_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  experimental function to include conditional prior information</span>
<span class="sd">    for one or more parameters in a full covariance matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">parnme</span> <span class="ow">in</span> <span class="n">par_knowledge_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">parnme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parnme</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;par knowledge dict parameters not found: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                        <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>
    <span class="c1"># build the selection matrix and sigma epsilon</span>
    <span class="c1">#sel = cov.zero2d</span>
    <span class="c1">#sel = pyemu.Matrix(x=np.zeros((cov.shape[0],1)),row_names=cov.row_names,col_names=[&#39;sel&#39;])</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">zero2d</span>
    <span class="n">sigma_ep</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">zero2d</span>
    <span class="k">for</span> <span class="n">parnme</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="n">par_knowledge_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parnme</span><span class="p">)</span>
        <span class="c1">#sel.x[idx,:] = 1.0</span>
        <span class="n">sel</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">sigma_ep</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
    <span class="c1">#print(sigma_ep.x)</span>
    <span class="c1">#q = sigma_ep.inv</span>
    <span class="c1">#cov_inv = cov.inv</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">sel</span> <span class="o">*</span> <span class="n">cov</span> <span class="o">*</span> <span class="n">sel</span><span class="o">.</span><span class="n">T</span>
    <span class="c1">#term2 += sigma_ep</span>
    <span class="c1">#term2 = cov</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">term2</span><span class="p">)</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">term2</span><span class="o">.</span><span class="n">inv</span>
    <span class="n">term2</span> <span class="o">*=</span> <span class="n">sel</span>
    <span class="n">term2</span> <span class="o">*=</span> <span class="n">cov</span>

    <span class="n">new_cov</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">-</span> <span class="n">term2</span>

    <span class="k">return</span> <span class="n">new_cov</span></div>



<div class="viewcode-block" id="kl_setup"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.kl_setup">[docs]</a><span class="k">def</span> <span class="nf">kl_setup</span><span class="p">(</span><span class="n">num_eig</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="n">struct</span><span class="p">,</span><span class="n">prefixes</span><span class="p">,</span>
             <span class="n">factors_file</span><span class="o">=</span><span class="s2">&quot;kl_factors.dat&quot;</span><span class="p">,</span><span class="n">islog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">basis_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">tpl_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup a karhuenen-Loeve based parameterization for a given</span>
<span class="sd">    geostatistical structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_eig : int</span>
<span class="sd">        number of basis vectors to retain in the reduced basis</span>
<span class="sd">    sr : flopy.reference.SpatialReference</span>

<span class="sd">    struct : str or pyemu.geostats.Geostruct</span>
<span class="sd">        geostatistical structure (or file containing one)</span>

<span class="sd">    array_dict : dict</span>
<span class="sd">        a dict of arrays to setup as KL-based parameters.  The key becomes the</span>
<span class="sd">        parameter name prefix. The total number of parameters is</span>
<span class="sd">        len(array_dict) * num_eig</span>

<span class="sd">    basis_file : str</span>
<span class="sd">        the name of the PEST-format binary file where the reduced basis will be saved</span>

<span class="sd">    tpl_file : str</span>
<span class="sd">        the name of the template file to make.  The template</span>
<span class="sd">        file is a csv file with the parameter names, the</span>
<span class="sd">        original factor values,and the template entries.</span>
<span class="sd">        The original values can be used to set the parval1</span>
<span class="sd">        entries in the control file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    back_array_dict : dict</span>
<span class="sd">        a dictionary of back transformed arrays.  This is useful to see</span>
<span class="sd">        how much &quot;smoothing&quot; is taking place compared to the original</span>
<span class="sd">        arrays.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    requires flopy</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import flopy``</span>

<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;m = flopy.modflow.Modflow.load(&quot;mymodel.nam&quot;)``</span>

<span class="sd">    ``&gt;&gt;&gt;a_dict = {&quot;hk&quot;:m.lpf.hk[0].array}``</span>

<span class="sd">    ``&gt;&gt;&gt;ba_dict = pyemu.helpers.kl_setup(10,m.sr,&quot;struct.dat&quot;,a_dict)``</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error import flopy: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">)</span>
    <span class="c1"># for name,array in array_dict.items():</span>
    <span class="c1">#     assert isinstance(array,np.ndarray)</span>
    <span class="c1">#     assert array.shape[0] == sr.nrow</span>
    <span class="c1">#     assert array.shape[1] == sr.ncol</span>
    <span class="c1">#     assert len(name) + len(str(num_eig)) &lt;= 12,&quot;name too long:{0}&quot;.\</span>
    <span class="c1">#         format(name)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">struct</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
        <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;i</span><span class="si">{0:04d}</span><span class="s2">j</span><span class="si">{1:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">ncol</span><span class="p">)])</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                               <span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                               <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>

    <span class="n">eig_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;eig_</span><span class="si">{0:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">trunc_basis</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">u</span>
    <span class="n">trunc_basis</span><span class="o">.</span><span class="n">col_names</span> <span class="o">=</span> <span class="n">eig_names</span>
    <span class="c1">#trunc_basis.col_names = [&quot;&quot;]</span>
    <span class="k">if</span> <span class="n">basis_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trunc_basis</span><span class="o">.</span><span class="n">to_binary</span><span class="p">(</span><span class="n">basis_file</span><span class="p">)</span>
    <span class="n">trunc_basis</span> <span class="o">=</span> <span class="n">trunc_basis</span><span class="p">[:,:</span><span class="n">num_eig</span><span class="p">]</span>
    <span class="n">eig_names</span> <span class="o">=</span> <span class="n">eig_names</span><span class="p">[:</span><span class="n">num_eig</span><span class="p">]</span>

    <span class="n">pp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">eig_names</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">eig_names</span><span class="p">)</span>
    <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">sr</span><span class="o">.</span><span class="n">ncol</span>
    <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">sr</span><span class="o">.</span><span class="n">nrow</span>
    <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parval1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">write_pp_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;temp.dat&quot;</span><span class="p">),</span><span class="n">pp_df</span><span class="p">)</span>


    <span class="n">eigen_basis_to_factor_file</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="n">sr</span><span class="o">.</span><span class="n">ncol</span><span class="p">,</span><span class="n">trunc_basis</span><span class="p">,</span><span class="n">factors_file</span><span class="o">=</span><span class="n">factors_file</span><span class="p">,</span><span class="n">islog</span><span class="o">=</span><span class="n">islog</span><span class="p">)</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefixes</span><span class="p">:</span>
        <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpl_dir</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.dat_kl.tpl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">pilot_points_to_tpl</span><span class="p">(</span><span class="s2">&quot;temp.dat&quot;</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s2">&quot;temp.dat&quot;</span><span class="p">,</span><span class="n">tpl_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;in_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;kl_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1">#arr = pyemu.geostats.fac2real(df,factors_file=factors_file,out_file=None)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span></div>

    <span class="c1"># back_array_dict = {}</span>
    <span class="c1"># f = open(tpl_file,&#39;w&#39;)</span>
    <span class="c1"># f.write(&quot;ptf ~\n&quot;)</span>
    <span class="c1"># f.write(&quot;name,org_val,new_val\n&quot;)</span>
    <span class="c1"># for name,array in array_dict.items():</span>
    <span class="c1">#     mname = name+&quot;mean&quot;</span>
    <span class="c1">#     f.write(&quot;{0},{1:20.8E},~   {2}    ~\n&quot;.format(mname,0.0,mname))</span>
    <span class="c1">#     #array -= array.mean()</span>
    <span class="c1">#     array_flat = pyemu.Matrix(x=np.atleast_2d(array.flatten()).transpose()</span>
    <span class="c1">#                               ,col_names=[&quot;flat&quot;],row_names=names,</span>
    <span class="c1">#                               isdiagonal=False)</span>
    <span class="c1">#     factors = trunc_basis * array_flat</span>
    <span class="c1">#     enames = [&quot;{0}{1:04d}&quot;.format(name,i) for i in range(num_eig)]</span>
    <span class="c1">#     for n,val in zip(enames,factors.x):</span>
    <span class="c1">#        f.write(&quot;{0},{1:20.8E},~    {0}    ~\n&quot;.format(n,val[0]))</span>
    <span class="c1">#     back_array_dict[name] = (factors.T * trunc_basis).x.reshape(array.shape)</span>
    <span class="c1">#     print(array_back)</span>
    <span class="c1">#     print(factors.shape)</span>
    <span class="c1">#</span>
    <span class="c1"># return back_array_dict</span>


<div class="viewcode-block" id="eigen_basis_to_factor_file"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.eigen_basis_to_factor_file">[docs]</a><span class="k">def</span> <span class="nf">eigen_basis_to_factor_file</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span><span class="p">,</span><span class="n">basis</span><span class="p">,</span><span class="n">factors_file</span><span class="p">,</span><span class="n">islog</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">==</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">factors_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;junk.dat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;junk.zone.dat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ncol</span><span class="p">,</span><span class="n">nrow</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">basis</span><span class="o">.</span><span class="n">col_names</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">islog</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{3:8.5e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.0</span><span class="p">))</span>
            <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1:12.8g}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,:])]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="kl_apply"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.kl_apply">[docs]</a><span class="k">def</span> <span class="nf">kl_apply</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="n">basis_file</span><span class="p">,</span><span class="n">par_to_file_dict</span><span class="p">,</span><span class="n">arr_shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Applies a KL parameterization transform from basis factors to model</span>
<span class="sd">    input arrays.  Companion function to kl_setup()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par_file : str</span>
<span class="sd">        the csv file to get factor values from.  Must contain</span>
<span class="sd">        the following columns: name, new_val, org_val</span>
<span class="sd">    basis_file : str</span>
<span class="sd">        the binary file that contains the reduced basis</span>

<span class="sd">    par_to_file_dict : dict</span>
<span class="sd">        a mapping from KL parameter prefixes to array file names.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This is the companion function to kl_setup.</span>

<span class="sd">    This function should be called during the forward run</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;pyemu.helpers.kl_apply(&quot;kl.dat&quot;,&quot;basis.dat&quot;,{&quot;hk&quot;:&quot;hk_layer_1.dat&quot;,(100,100))``</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">assert</span> <span class="s2">&quot;org_val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">assert</span> <span class="s2">&quot;new_val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">par_to_file_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="s2">&quot;missing prefix:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_binary</span><span class="p">(</span><span class="n">basis_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">arr_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">arr_min</span> <span class="o">=</span> <span class="mf">1.0e-10</span> <span class="c1"># a temp hack</span>

    <span class="c1">#means = df.loc[df.name.apply(lambda x: x.endswith(&quot;mean&quot;)),:]</span>
    <span class="c1">#print(means)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)),:]</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="n">par_to_file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,[</span><span class="s2">&quot;new_val&quot;</span><span class="p">]])</span>
        <span class="n">factors</span><span class="o">.</span><span class="n">autoalign</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">basis_prefix</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[:</span><span class="n">factors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">basis_prefix</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arr_shape</span><span class="p">)</span>
        <span class="c1">#arr += means.loc[means.prefix==prefix,&quot;new_val&quot;].values</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">arr</span><span class="o">&lt;</span><span class="n">arr_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_min</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%20.8E</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="zero_order_tikhonov"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.zero_order_tikhonov">[docs]</a><span class="k">def</span> <span class="nf">zero_order_tikhonov</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">parbounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">par_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup preferred-value regularization</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pst : pyemu.Pst</span>
<span class="sd">        the control file instance</span>
<span class="sd">    parbounds : bool</span>
<span class="sd">        flag to weight the prior information equations according</span>
<span class="sd">        to parameter bound width - approx the KL transform. Default</span>
<span class="sd">        is True</span>
<span class="sd">    par_groups : list</span>
<span class="sd">        parameter groups to build PI equations for.  If None, all</span>
<span class="sd">        adjustable parameters are used. Default is None</span>

<span class="sd">    reset : bool</span>
<span class="sd">        flag to reset the prior_information attribute of the pst</span>
<span class="sd">        instance.  Default is True</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;pst = pyemu.Pst(&quot;pest.pst&quot;)``</span>

<span class="sd">    ``&gt;&gt;&gt;pyemu.helpers.zero_order_tikhonov(pst)``</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">par_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">par_groups</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">par_groups</span>

    <span class="n">pilbl</span><span class="p">,</span> <span class="n">obgnme</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">equation</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;partrans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tied&quot;</span><span class="p">,</span> <span class="s2">&quot;fixed&quot;</span><span class="p">]</span> <span class="ow">and</span>\
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">par_groups</span><span class="p">:</span>
            <span class="n">pilbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;parnme&quot;</span><span class="p">])</span>
            <span class="n">weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ogp_name</span> <span class="o">=</span> <span class="s2">&quot;regul&quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span>
            <span class="n">obgnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ogp_name</span><span class="p">[:</span><span class="mi">12</span><span class="p">])</span>
            <span class="n">parnme</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="n">parval1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parval1&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pt</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">parnme</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span> <span class="o">+</span> <span class="n">parnme</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">parval1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">parval1</span><span class="p">)</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="s2">&quot;1.0 * &quot;</span> <span class="o">+</span> <span class="n">parnme</span> <span class="o">+</span> <span class="s2">&quot; =</span><span class="si">{0:15.6E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parval1</span><span class="p">)</span>
            <span class="n">equation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pilbl&quot;</span><span class="p">:</span> <span class="n">pilbl</span><span class="p">,</span>
                                               <span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="n">equation</span><span class="p">,</span>
                                               <span class="s2">&quot;obgnme&quot;</span><span class="p">:</span> <span class="n">obgnme</span><span class="p">,</span>
                                               <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pilbl&quot;</span><span class="p">:</span> <span class="n">pilbl</span><span class="p">,</span>
                          <span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="n">equation</span><span class="p">,</span>
                          <span class="s2">&quot;obgnme&quot;</span><span class="p">:</span> <span class="n">obgnme</span><span class="p">,</span>
                          <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parbounds</span><span class="p">:</span>
        <span class="n">regweight_from_parbound</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">pestmode</span> <span class="o">==</span> <span class="s2">&quot;estimation&quot;</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">pestmode</span> <span class="o">=</span> <span class="s2">&quot;regularization&quot;</span></div>


<div class="viewcode-block" id="regweight_from_parbound"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.regweight_from_parbound">[docs]</a><span class="k">def</span> <span class="nf">regweight_from_parbound</span><span class="p">(</span><span class="n">pst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;sets regularization weights from parameter bounds</span>
<span class="sd">    which approximates the KL expansion.  Called by</span>
<span class="sd">    zero_order_tikhonov().</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pst : pyemu.Pst</span>
<span class="sd">        a control file instance</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">parnme</span>
    <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">pilbl</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">parnme</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">pilbl</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parnme</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parnme</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">lbnd</span><span class="p">,</span><span class="n">ubnd</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;partrans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ubnd</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lbnd</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">ubnd</span> <span class="o">-</span> <span class="n">lbnd</span><span class="p">)</span>
            <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parnme</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;prior information name does not correspond&quot;</span> <span class="o">+</span>\
                  <span class="s2">&quot; to a parameter: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">parnme</span><span class="p">))</span></div>


<div class="viewcode-block" id="first_order_pearson_tikhonov"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.first_order_pearson_tikhonov">[docs]</a><span class="k">def</span> <span class="nf">first_order_pearson_tikhonov</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">abs_drop_tol</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup preferred-difference regularization from a covariance matrix.</span>
<span class="sd">    The weights on the prior information equations are the Pearson</span>
<span class="sd">    correlation coefficients implied by covariance matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pst : pyemu.Pst</span>
<span class="sd">        pst instance</span>
<span class="sd">    cov : pyemu.Cov</span>
<span class="sd">        covariance matrix instance</span>
<span class="sd">    reset : bool</span>
<span class="sd">        drop all other pi equations.  If False, append to</span>
<span class="sd">        existing pi equations</span>
<span class="sd">    abs_drop_tol : float</span>
<span class="sd">        tolerance to control how many pi equations are written.</span>
<span class="sd">        If the Pearson C is less than abs_drop_tol, the prior information</span>
<span class="sd">        equation will not be included in the control file</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;pst = pyemu.Pst(&quot;pest.pst&quot;)``</span>

<span class="sd">    ``&gt;&gt;&gt;cov = pyemu.Cov.from_ascii(&quot;prior.cov&quot;)``</span>

<span class="sd">    ``&gt;&gt;&gt;pyemu.helpers.first_order_pearson_tikhonov(pst,cov,abs_drop_tol=0.25)``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="p">)</span>
    <span class="n">cc_mat</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">to_pearson</span><span class="p">()</span>
    <span class="c1">#print(pst.parameter_data.dtypes)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ptrans</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ptrans</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">pi_num</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">pilbl</span><span class="p">,</span> <span class="n">obgnme</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">equation</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">iname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cc_mat</span><span class="o">.</span><span class="n">row_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">jname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cc_mat</span><span class="o">.</span><span class="n">row_names</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="n">jname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1">#print(i,iname,i+j+1,jname)</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">cc_mat</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="n">abs_drop_tol</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">pilbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pcc_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pi_num</span><span class="p">))</span>
            <span class="n">iiname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptrans</span><span class="p">[</span><span class="n">iname</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">iiname</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span><span class="o">+</span><span class="n">iname</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
            <span class="n">jjname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptrans</span><span class="p">[</span><span class="n">jname</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">jjname</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span><span class="o">+</span><span class="n">jname</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
            <span class="n">equation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;1.0 * </span><span class="si">{0}</span><span class="s2"> - 1.0 * </span><span class="si">{1}</span><span class="s2"> = 0.0&quot;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="n">iiname</span><span class="p">,</span><span class="n">jjname</span><span class="p">))</span>
            <span class="n">weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="n">obgnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;regul_cc&quot;</span><span class="p">)</span>
            <span class="n">pi_num</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pilbl&quot;</span><span class="p">:</span> <span class="n">pilbl</span><span class="p">,</span><span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="n">equation</span><span class="p">,</span>
                       <span class="s2">&quot;obgnme&quot;</span><span class="p">:</span> <span class="n">obgnme</span><span class="p">,</span><span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pilbl</span>
    <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">pestmode</span> <span class="o">==</span> <span class="s2">&quot;estimation&quot;</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">pestmode</span> <span class="o">=</span> <span class="s2">&quot;regularization&quot;</span></div>

<div class="viewcode-block" id="simple_tpl_from_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.simple_tpl_from_pars">[docs]</a><span class="k">def</span> <span class="nf">simple_tpl_from_pars</span><span class="p">(</span><span class="n">parnames</span><span class="p">,</span> <span class="n">tplfilename</span><span class="o">=</span><span class="s1">&#39;model.input.tpl&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a template file just assuming a list of parameter names the values of which should be</span>
<span class="sd">    listed in order in a model input file</span>
<span class="sd">    Args:</span>
<span class="sd">        parnames: list of names from which to make a template file</span>
<span class="sd">        tplfilename: filename for TPL file (default: model.input.tpl)</span>

<span class="sd">    Returns:</span>
<span class="sd">        writes a file &lt;tplfilename&gt; with each parameter name on a line</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tplfilename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ptf ~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;~</span><span class="si">{0:^12}</span><span class="s1">~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cname</span><span class="p">))</span> <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="n">parnames</span><span class="p">]</span></div>


<div class="viewcode-block" id="simple_ins_from_obs"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.simple_ins_from_obs">[docs]</a><span class="k">def</span> <span class="nf">simple_ins_from_obs</span><span class="p">(</span><span class="n">obsnames</span><span class="p">,</span> <span class="n">insfilename</span><span class="o">=</span><span class="s1">&#39;model.output.ins&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    writes an instruction file that assumes wanting to read the values names in obsnames in order</span>
<span class="sd">    one per line from a model output file</span>
<span class="sd">    Args:</span>
<span class="sd">        obsnames: list of obsnames to read in</span>
<span class="sd">        insfilename: filename for INS file (default: model.output.ins)</span>

<span class="sd">    Returns:</span>
<span class="sd">        writes a file &lt;insfilename&gt; with each observation read off a line</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">insfilename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pif ~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;!</span><span class="si">{0}</span><span class="s1">!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cob</span><span class="p">))</span> <span class="k">for</span> <span class="n">cob</span> <span class="ow">in</span> <span class="n">obsnames</span><span class="p">]</span></div>

<div class="viewcode-block" id="pst_from_parnames_obsnames"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.pst_from_parnames_obsnames">[docs]</a><span class="k">def</span> <span class="nf">pst_from_parnames_obsnames</span><span class="p">(</span><span class="n">parnames</span><span class="p">,</span> <span class="n">obsnames</span><span class="p">,</span>
                               <span class="n">tplfilename</span><span class="o">=</span><span class="s1">&#39;model.input.tpl&#39;</span><span class="p">,</span> <span class="n">insfilename</span><span class="o">=</span><span class="s1">&#39;model.output.ins&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a Pst object from a list of parameter names and a list of observation names.</span>
<span class="sd">    Default values are provided for the TPL and INS</span>
<span class="sd">    Args:</span>
<span class="sd">        parnames: list of names from which to make a template file</span>
<span class="sd">        obsnames: list of obsnames to read in</span>
<span class="sd">        tplfilename: filename for TPL file (default: model.input.tpl)</span>
<span class="sd">        insfilename: filename for INS file (default: model.output.ins)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Pst object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">simple_tpl_from_pars</span><span class="p">(</span><span class="n">parnames</span><span class="p">,</span> <span class="n">tplfilename</span><span class="p">)</span>
    <span class="n">simple_ins_from_obs</span><span class="p">(</span><span class="n">obsnames</span><span class="p">,</span> <span class="n">insfilename</span><span class="p">)</span>

    <span class="n">modelinputfilename</span> <span class="o">=</span> <span class="n">tplfilename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tpl&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">modeloutputfilename</span> <span class="o">=</span> <span class="n">insfilename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ins&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="o">.</span><span class="n">from_io_files</span><span class="p">(</span><span class="n">tplfilename</span><span class="p">,</span> <span class="n">modelinputfilename</span><span class="p">,</span> <span class="n">insfilename</span><span class="p">,</span> <span class="n">modeloutputfilename</span><span class="p">)</span></div>



<div class="viewcode-block" id="start_slaves"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.start_slaves">[docs]</a><span class="k">def</span> <span class="nf">start_slaves</span><span class="p">(</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">exe_rel_path</span><span class="p">,</span><span class="n">pst_rel_path</span><span class="p">,</span><span class="n">num_slaves</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">slave_root</span><span class="o">=</span><span class="s2">&quot;..&quot;</span><span class="p">,</span>
                 <span class="n">port</span><span class="o">=</span><span class="mi">4004</span><span class="p">,</span><span class="n">rel_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">master_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">silent_master</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; start a group of pest(++) slaves on the local machine</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    slave_dir :  str</span>
<span class="sd">        the path to a complete set of input files</span>
<span class="sd">    exe_rel_path : str</span>
<span class="sd">        the relative path to the pest(++) executable from within the slave_dir</span>
<span class="sd">    pst_rel_path : str</span>
<span class="sd">        the relative path to the pst file from within the slave_dir</span>
<span class="sd">    num_slaves : int</span>
<span class="sd">        number of slaves to start. defaults to number of cores</span>
<span class="sd">    slave_root : str</span>
<span class="sd">        the root to make the new slave directories in</span>
<span class="sd">    rel_path: str</span>
<span class="sd">        the relative path to where pest(++) should be run from within the</span>
<span class="sd">        slave_dir, defaults to the uppermost level of the slave dir</span>
<span class="sd">    local: bool</span>
<span class="sd">        flag for using &quot;localhost&quot; instead of hostname on slave command line</span>
<span class="sd">    cleanup: bool</span>
<span class="sd">        flag to remove slave directories once processes exit</span>
<span class="sd">    master_dir: str</span>
<span class="sd">        name of directory for master instance.  If master_dir</span>
<span class="sd">        exists, then it will be removed.  If master_dir is None,</span>
<span class="sd">        no master instance will be started</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        flag to echo useful information to stdout</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    if all slaves (and optionally master) exit gracefully, then the slave</span>
<span class="sd">    dirs will be removed unless cleanup is false</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    start 10 slaves using the directory &quot;template&quot; as the base case and</span>
<span class="sd">    also start a master instance in a directory &quot;master&quot;.</span>

<span class="sd">    ``&gt;&gt;&gt;pyemu.helpers.start_slaves(&quot;template&quot;,&quot;pestpp&quot;,&quot;pest.pst&quot;,10,master_dir=&quot;master&quot;)``</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;start_slaves has moved to pyemu.os_utils&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="n">pyemu</span><span class="o">.</span><span class="n">os_utils</span><span class="o">.</span><span class="n">start_slaves</span><span class="p">(</span><span class="n">slave_dir</span><span class="o">=</span><span class="n">slave_dir</span><span class="p">,</span><span class="n">exe_rel_path</span><span class="o">=</span><span class="n">exe_rel_path</span><span class="p">,</span><span class="n">pst_rel_path</span><span class="o">=</span><span class="n">pst_rel_path</span>
                      <span class="p">,</span><span class="n">num_slaves</span><span class="o">=</span><span class="n">num_slaves</span><span class="p">,</span><span class="n">slave_root</span><span class="o">=</span><span class="n">slave_root</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span><span class="n">rel_path</span><span class="o">=</span><span class="n">rel_path</span><span class="p">,</span>
                      <span class="n">local</span><span class="o">=</span><span class="n">local</span><span class="p">,</span><span class="n">cleanup</span><span class="o">=</span><span class="n">cleanup</span><span class="p">,</span><span class="n">master_dir</span><span class="o">=</span><span class="n">master_dir</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                      <span class="n">silent_master</span><span class="o">=</span><span class="n">silent_master</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_pestpp_runstorage"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.read_pestpp_runstorage">[docs]</a><span class="k">def</span> <span class="nf">read_pestpp_runstorage</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">irun</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read pars and obs from a specific run in a pest++ serialized run storage file into</span>
<span class="sd">    pandas.DataFrame(s)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        the name of the run storage file</span>
<span class="sd">    irun : int</span>
<span class="sd">        the run id to process.  Default is 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    par_df : pandas.DataFrame</span>
<span class="sd">        parameter information</span>
<span class="sd">    obs_df : pandas.DataFrame</span>
<span class="sd">        observation information</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">header_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s2">&quot;n_runs&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;run_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;p_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;o_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">header_dtype</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p_name_size</span><span class="p">,</span><span class="n">o_name_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;p_name_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;o_name_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">par_names</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_name_size</span><span class="p">),</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">p_name_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">obs_names</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_name_size</span><span class="p">),</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">o_name_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n_runs</span><span class="p">,</span><span class="n">run_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;n_runs&quot;</span><span class="p">],</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;run_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">irun</span> <span class="o">&lt;=</span> <span class="n">n_runs</span>
        <span class="n">run_start</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">run_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">irun</span> <span class="o">*</span> <span class="n">run_size</span><span class="p">))</span>
        <span class="n">r_status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">info_txt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;41s&quot;</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">41</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">par_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">obs_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_names</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">par_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">par_names</span><span class="p">,</span><span class="s2">&quot;parval1&quot;</span><span class="p">:</span><span class="n">par_vals</span><span class="p">})</span>

    <span class="n">par_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">par_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
    <span class="n">obs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;obsnme&quot;</span><span class="p">:</span><span class="n">obs_names</span><span class="p">,</span><span class="s2">&quot;obsval&quot;</span><span class="p">:</span><span class="n">obs_vals</span><span class="p">})</span>
    <span class="n">obs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;obsnme&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">par_df</span><span class="p">,</span><span class="n">obs_df</span></div>


<div class="viewcode-block" id="jco_from_pestpp_runstorage"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.jco_from_pestpp_runstorage">[docs]</a><span class="k">def</span> <span class="nf">jco_from_pestpp_runstorage</span><span class="p">(</span><span class="n">rnj_filename</span><span class="p">,</span><span class="n">pst_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; read pars and obs from a pest++ serialized run storage file (e.g., .rnj) and return </span>
<span class="sd">    pyemu.Jco.  This can then be passed to Jco.to_binary or Jco.to_coo, etc., to write jco file</span>
<span class="sd">    in a subsequent step to avoid memory resource issues associated with very large problems.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rnj_filename : str</span>
<span class="sd">        the name of the run storage file</span>
<span class="sd">    pst_filename : str</span>
<span class="sd">        the name of the pst file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    jco_cols : pyemu.Jco</span>


<span class="sd">    Notes</span>
<span class="sd">    -------</span>
<span class="sd">    TODO:</span>
<span class="sd">    0. Check rnj file contains transformed par vals (i.e., in model input space)</span>
<span class="sd">    1. Currently only returns pyemu.Jco; doesn&#39;t write jco file due to memory issues </span>
<span class="sd">       associated with very large problems</span>
<span class="sd">    3. Compare rnj and jco from Freyberg problem in autotests</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">header_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s2">&quot;n_runs&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;run_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;p_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;o_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)])</span>

    <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst_filename</span><span class="p">)</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="n">log_pars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">partrans</span><span class="o">==</span><span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rnj_filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">header_dtype</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base_par</span><span class="p">,</span><span class="n">base_obs</span> <span class="o">=</span>  <span class="n">read_pestpp_runstorage</span><span class="p">(</span><span class="n">rnj_filename</span><span class="p">,</span><span class="n">irun</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t get base run...&quot;</span><span class="p">)</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">base_par</span><span class="o">.</span><span class="n">index</span><span class="p">,:]</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">base_par</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;partrans&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">base_par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="n">jco_cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">irun</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;n_runs&quot;</span><span class="p">])):</span>
        <span class="n">par_df</span><span class="p">,</span><span class="n">obs_df</span> <span class="o">=</span> <span class="n">read_pestpp_runstorage</span><span class="p">(</span><span class="n">rnj_filename</span><span class="p">,</span><span class="n">irun</span><span class="o">=</span><span class="n">irun</span><span class="p">)</span>
        <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
        <span class="n">obs_diff</span> <span class="o">=</span> <span class="n">base_obs</span> <span class="o">-</span> <span class="n">obs_df</span>
        <span class="n">par_diff</span> <span class="o">=</span> <span class="n">base_par</span> <span class="o">-</span> <span class="n">par_df</span>
        <span class="c1"># check only one non-zero element per col(par)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_diff</span><span class="p">[</span><span class="n">par_diff</span><span class="o">.</span><span class="n">parval1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;more than one par diff - looks like the file wasn&#39;t created during jco filling...&quot;</span><span class="p">)</span>
        <span class="n">parnme</span> <span class="o">=</span> <span class="n">par_diff</span><span class="p">[</span><span class="n">par_diff</span><span class="o">.</span><span class="n">parval1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parval</span> <span class="o">=</span> <span class="n">par_diff</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parnme</span><span class="p">]</span>

        <span class="c1"># derivatives</span>
        <span class="n">jco_col</span> <span class="o">=</span> <span class="n">obs_diff</span> <span class="o">/</span> <span class="n">parval</span>
        <span class="c1"># some tracking, checks</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing par </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">irun</span><span class="p">,</span> <span class="n">parnme</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;%nzsens: </span><span class="si">{0}</span><span class="s2">%...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">jco_col</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">jco_col</span><span class="o">.</span><span class="n">obsval</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-8</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">jco_col</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">))</span>

        <span class="n">jco_cols</span><span class="p">[</span><span class="n">parnme</span><span class="p">]</span> <span class="o">=</span> <span class="n">jco_col</span><span class="o">.</span><span class="n">obsval</span>

    <span class="n">jco_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">jco_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">obs_diff</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="n">jco_cols</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Jco</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">jco_cols</span><span class="p">)</span>
    
    <span class="c1"># write # memory considerations important here for very large matrices - break into chunks...</span>
    <span class="c1">#jco_fnam = &quot;{0}&quot;.format(filename[:-4]+&quot;.jco&quot;)</span>
    <span class="c1">#jco_cols.to_binary(filename=jco_fnam, droptol=None, chunk=None)</span>

    <span class="k">return</span> <span class="n">jco_cols</span></div>


<div class="viewcode-block" id="parse_dir_for_io_files"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.parse_dir_for_io_files">[docs]</a><span class="k">def</span> <span class="nf">parse_dir_for_io_files</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a helper function to find template/input file pairs and</span>
<span class="sd">    instruction file/output file pairs.  the return values from this</span>
<span class="sd">    function can be passed straight to pyemu.Pst.from_io_files() classmethod</span>
<span class="sd">    constructor. Assumes the template file names are &lt;input_file&gt;.tpl and</span>
<span class="sd">    instruction file names are &lt;output_file&gt;.ins.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d : str</span>
<span class="sd">        directory to search for interface files</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tpl_files : list</span>
<span class="sd">        list of template files in d</span>
<span class="sd">    in_files : list</span>
<span class="sd">        list of input files in d</span>
<span class="sd">    ins_files : list</span>
<span class="sd">        list of instruction files in d</span>
<span class="sd">    out_files : list</span>
<span class="sd">        list of output files in d</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)]</span>
    <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">]</span>
    <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">)]</span>
    <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">,</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span></div>


<div class="viewcode-block" id="pst_from_io_files"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.pst_from_io_files">[docs]</a><span class="k">def</span> <span class="nf">pst_from_io_files</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">,</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span><span class="p">,</span><span class="n">pst_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;generate a Pst instance from the model io files.  If &#39;inschek&#39;</span>
<span class="sd">    is available (either in the current directory or registered</span>
<span class="sd">    with the system variables) and the model output files are available</span>
<span class="sd">    , then the observation values in the control file will be set to the</span>
<span class="sd">    values of the model-simulated equivalents to observations.  This can be</span>
<span class="sd">    useful for testing</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tpl_files : list</span>
<span class="sd">        list of pest template files</span>
<span class="sd">    in_files : list</span>
<span class="sd">        list of corresponding model input files</span>
<span class="sd">    ins_files : list</span>
<span class="sd">        list of pest instruction files</span>
<span class="sd">    out_files: list</span>
<span class="sd">        list of corresponding model output files</span>
<span class="sd">    pst_filename : str</span>
<span class="sd">        name of file to write the control file to.  If None,</span>
<span class="sd">        control file is not written.  Default is None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pst : pyemu.Pst</span>


<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    this will construct a new Pst instance from template and instruction files</span>
<span class="sd">    found in the current directory, assuming that the naming convention follows</span>
<span class="sd">    that listed in parse_dir_for_io_files()</span>

<span class="sd">    ``&gt;&gt;&gt;pst = pyemu.helpers.pst_from_io_files(*pyemu.helpers.parse_dir_for_io_files(&#39;.&#39;))``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">par_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">tpl_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_files</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">),</span><span class="s2">&quot;len(in_files) != len(tpl_files)&quot;</span>

    <span class="k">for</span> <span class="n">tpl_file</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">),</span><span class="s2">&quot;template file not found: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
        <span class="c1">#new_names = [name for name in pyemu.pst_utils.parse_tpl_file(tpl_file) if name not in par_names]</span>
        <span class="c1">#par_names.extend(new_names)</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">parse_tpl_file</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
        <span class="n">par_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ins_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">ins_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_files</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_files</span><span class="p">),</span><span class="s2">&quot;len(out_files) != len(out_files)&quot;</span>


    <span class="n">obs_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ins_file</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ins_file</span><span class="p">),</span><span class="s2">&quot;instruction file not found: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)</span>
        <span class="n">obs_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">parse_ins_file</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>

    <span class="n">new_pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">generic_pst</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">par_names</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">obs_names</span><span class="p">))</span>

    <span class="n">new_pst</span><span class="o">.</span><span class="n">template_files</span> <span class="o">=</span> <span class="n">tpl_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span> <span class="n">in_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">instruction_files</span> <span class="o">=</span> <span class="n">ins_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">output_files</span> <span class="o">=</span> <span class="n">out_files</span>

    <span class="c1">#try to run inschek to find the observtion values</span>
    <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">try_run_inschek</span><span class="p">(</span><span class="n">new_pst</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pst_filename</span><span class="p">:</span>
        <span class="n">new_pst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pst_filename</span><span class="p">,</span><span class="n">update_regul</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_pst</span></div>


<span class="n">wildass_guess_par_bounds_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hk&quot;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span><span class="s2">&quot;vka&quot;</span><span class="p">:[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">10.0</span><span class="p">],</span>
                                   <span class="s2">&quot;sy&quot;</span><span class="p">:[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.75</span><span class="p">],</span><span class="s2">&quot;ss&quot;</span><span class="p">:[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">10.0</span><span class="p">],</span>
                                   <span class="s2">&quot;cond&quot;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span><span class="s2">&quot;flux&quot;</span><span class="p">:[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.75</span><span class="p">],</span>
                                   <span class="s2">&quot;rech&quot;</span><span class="p">:[</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.1</span><span class="p">],</span><span class="s2">&quot;stage&quot;</span><span class="p">:[</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.1</span><span class="p">],</span>
                                   <span class="p">}</span>

<div class="viewcode-block" id="PstFromFlopyModel"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel">[docs]</a><span class="k">class</span> <span class="nc">PstFromFlopyModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a monster helper class to setup multiplier parameters for an</span>
<span class="sd">        existing MODFLOW model.  does all kinds of coolness like building a</span>
<span class="sd">        meaningful prior, assigning somewhat meaningful parameter groups and</span>
<span class="sd">        bounds, writes a forward_run.py script with all the calls need to</span>
<span class="sd">        implement multiplier parameters, run MODFLOW and post-process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : flopy.mbase</span>
<span class="sd">        a loaded flopy model instance. If model is an str, it is treated as a</span>
<span class="sd">        MODFLOW nam file (requires org_model_ws)</span>
<span class="sd">    new_model_ws : str</span>
<span class="sd">        a directory where the new version of MODFLOW input files and PEST(++)</span>
<span class="sd">        files will be written</span>
<span class="sd">    org_model_ws : str</span>
<span class="sd">        directory to existing MODFLOW model files.  Required if model argument</span>
<span class="sd">        is an str.  Default is None</span>
<span class="sd">    pp_props : list</span>
<span class="sd">        pilot point multiplier parameters for grid-based properties.</span>
<span class="sd">        A nested list of grid-scale model properties to parameterize using</span>
<span class="sd">        name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">        layer indices.  For example, [&quot;lpf.hk&quot;,[0,1,2,]] would setup pilot point multiplier</span>
<span class="sd">        parameters for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">        layers 1,2, and 3.  For time-varying properties (e.g. recharge), the</span>
<span class="sd">        iterable is for zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">        would setup pilot point multiplier parameters for recharge for stress</span>
<span class="sd">        period 1,5,11,and 16.</span>
<span class="sd">    const_props : list</span>
<span class="sd">        constant (uniform) multiplier parameters for grid-based properties.</span>
<span class="sd">        A nested list of grid-scale model properties to parameterize using</span>
<span class="sd">        name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">        layer indices.  For example, [&quot;lpf.hk&quot;,[0,1,2,]] would setup constant (uniform) multiplier</span>
<span class="sd">        parameters for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">        layers 1,2, and 3.  For time-varying properties (e.g. recharge), the</span>
<span class="sd">        iterable is for zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">        would setup constant (uniform) multiplier parameters for recharge for stress</span>
<span class="sd">        period 1,5,11,and 16.</span>
<span class="sd">    temporal_bc_props : list</span>
<span class="sd">        boundary condition stress-period level multiplier parameters.</span>
<span class="sd">        A nested list of boundary condition elements to parameterize using</span>
<span class="sd">        name, iterable pairs.  The iterable is zero-based stress-period indices.</span>
<span class="sd">        For example, to setup multipliers for WEL flux and for RIV conductance,</span>
<span class="sd">        bc_props = [[&quot;wel.flux&quot;,[0,1,2]],[&quot;riv.cond&quot;,None]] would setup</span>
<span class="sd">        multiplier parameters for well flux for stress periods 1,2 and 3 and</span>
<span class="sd">        would setup one single river conductance multiplier parameter that is applied</span>
<span class="sd">        to all stress periods</span>
<span class="sd">    spatial_bc_props : list</span>
<span class="sd">        boundary condition spatial multiplier parameters.</span>
<span class="sd">        A nested list of boundary condition elements to parameterize using</span>
<span class="sd">        names (e.g. [[&quot;riv.cond&quot;,0],[&quot;wel.flux&quot;,1] to setup up cell-based parameters for</span>
<span class="sd">        each boundary condition element listed.  These multipler parameters are applied across</span>
<span class="sd">        all stress periods.  For this to work, there must be the same number of entries</span>
<span class="sd">        for all stress periods.  If more than one BC of the same type is in a single</span>
<span class="sd">        cell, only one parameter is used to multiply all BCs in the same cell.</span>
<span class="sd">    grid_props : list</span>
<span class="sd">        grid-based (every active model cell) multiplier parameters.</span>
<span class="sd">        A nested list of grid-scale model properties to parameterize using</span>
<span class="sd">        name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">        layer indices (e.g., [&quot;lpf.hk&quot;,[0,1,2,]] would setup a multiplier</span>
<span class="sd">        parameter for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">        layers 1,2, and 3 in every active model cell).  For time-varying properties (e.g. recharge), the</span>
<span class="sd">        iterable is for zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">        would setup grid-based multiplier parameters in every active model cell</span>
<span class="sd">        for recharge for stress period 1,5,11,and 16.</span>
<span class="sd">    grid_geostruct : pyemu.geostats.GeoStruct</span>
<span class="sd">        the geostatistical structure to build the prior parameter covariance matrix</span>
<span class="sd">        elements for grid-based parameters.  If None, a generic GeoStruct is created</span>
<span class="sd">        using an &quot;a&quot; parameter that is 10 times the max cell size.  Default is None</span>
<span class="sd">    pp_space : int</span>
<span class="sd">        number of grid cells between pilot points.  If None, use the default</span>
<span class="sd">        in pyemu.pp_utils.setup_pilot_points_grid.  Default is None</span>
<span class="sd">    zone_props : list</span>
<span class="sd">        zone-based multiplier parameters.</span>
<span class="sd">        A nested list of grid-scale model properties to parameterize using</span>
<span class="sd">        name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">        layer indices (e.g., [&quot;lpf.hk&quot;,[0,1,2,]] would setup a multiplier</span>
<span class="sd">        parameter for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">        layers 1,2, and 3 for unique zone values in the ibound array.</span>
<span class="sd">        For time-varying properties (e.g. recharge), the iterable is for</span>
<span class="sd">        zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">        would setup zone-based multiplier parameters for recharge for stress</span>
<span class="sd">        period 1,5,11,and 16.</span>
<span class="sd">    pp_geostruct : pyemu.geostats.GeoStruct</span>
<span class="sd">        the geostatistical structure to use for building the prior parameter</span>
<span class="sd">        covariance matrix for pilot point parameters.  If None, a generic</span>
<span class="sd">        GeoStruct is created using pp_space and grid-spacing information.</span>
<span class="sd">        Default is None</span>
<span class="sd">    par_bounds_dict : dict</span>
<span class="sd">        a dictionary of model property/boundary condition name, upper-lower bound pairs.</span>
<span class="sd">        For example, par_bounds_dict = {&quot;hk&quot;:[0.01,100.0],&quot;flux&quot;:[0.5,2.0]} would</span>
<span class="sd">        set the bounds for horizontal hydraulic conductivity to</span>
<span class="sd">        0.001 and 100.0 and set the bounds for flux parameters to 0.5 and</span>
<span class="sd">        2.0.  For parameters not found in par_bounds_dict,</span>
<span class="sd">        pyemu.helpers.wildass_guess_par_bounds_dict is</span>
<span class="sd">        used to set somewhat meaningful bounds.  Default is None</span>
<span class="sd">    temporal_bc_geostruct : pyemu.geostats.GeoStruct</span>
<span class="sd">        the geostastical struture to build the prior parameter covariance matrix</span>
<span class="sd">        for time-varying boundary condition multiplier parameters.  This GeoStruct</span>
<span class="sd">        express the time correlation so that the &#39;a&#39; parameter is the length of</span>
<span class="sd">        time that boundary condition multiplier parameters are correlated across.</span>
<span class="sd">        If None, then a generic GeoStruct is created that uses an &#39;a&#39; parameter</span>
<span class="sd">        of 3 stress periods.  Default is None</span>
<span class="sd">    spatial_bc_geostruct : pyemu.geostats.GeoStruct</span>
<span class="sd">        the geostastical struture to build the prior parameter covariance matrix</span>
<span class="sd">        for spatially-varying boundary condition multiplier parameters.</span>
<span class="sd">        If None, a generic GeoStruct is created using an &quot;a&quot; parameter that</span>
<span class="sd">        is 10 times the max cell size.  Default is None.</span>
<span class="sd">    remove_existing : bool</span>
<span class="sd">        a flag to remove an existing new_model_ws directory.  If False and</span>
<span class="sd">        new_model_ws exists, an exception is raised.  If True and new_model_ws</span>
<span class="sd">        exists, the directory is destroyed - user beware! Default is False.</span>
<span class="sd">    k_zone_dict : dict</span>
<span class="sd">        a dictionary of zero-based layer index, zone array pairs.  Used to</span>
<span class="sd">        override using ibound zones for zone-based parameterization.  If None,</span>
<span class="sd">        use ibound values greater than zero as zones.</span>
<span class="sd">    use_pp_zones : bool</span>
<span class="sd">         a flag to use ibound zones (or k_zone_dict, see above) as pilot</span>
<span class="sd">         point zones.  If False, ibound values greater than zero are treated as</span>
<span class="sd">         a single zone for pilot points.  Default is False</span>
<span class="sd">    obssim_smp_pairs: list</span>
<span class="sd">        a list of observed-simulated PEST-type SMP file pairs to get observations</span>
<span class="sd">        from and include in the control file.  Default is []</span>
<span class="sd">    external_tpl_in_pairs : list</span>
<span class="sd">        a list of existing template file, model input file pairs to parse parameters</span>
<span class="sd">        from and include in the control file.  Default is []</span>
<span class="sd">    external_ins_out_pairs : list</span>
<span class="sd">        a list of existing instruction file, model output file pairs to parse</span>
<span class="sd">        observations from and include in the control file.  Default is []</span>
<span class="sd">    extra_pre_cmds : list</span>
<span class="sd">        a list of preprocessing commands to add to the forward_run.py script</span>
<span class="sd">        commands are executed with os.system() within forward_run.py. Default</span>
<span class="sd">        is None.</span>
<span class="sd">    redirect_forward_output : bool</span>
<span class="sd">        flag for whether to redirect forward model output to text files (True) or</span>
<span class="sd">        allow model output to be directed to the screen (False)</span>
<span class="sd">        Default is True</span>
<span class="sd">    extra_post_cmds : list</span>
<span class="sd">        a list of post-processing commands to add to the forward_run.py script.</span>
<span class="sd">        Commands are executed with os.system() within forward_run.py.</span>
<span class="sd">        Default is None.</span>
<span class="sd">    tmp_files : list</span>
<span class="sd">        a list of temporary files that should be removed at the start of the forward</span>
<span class="sd">        run script.  Default is [].</span>
<span class="sd">    model_exe_name : str</span>
<span class="sd">        binary name to run modflow.  If None, a default from flopy is used,</span>
<span class="sd">        which is dangerous because of the non-standard binary names</span>
<span class="sd">        (e.g. MODFLOW-NWT_x64, MODFLOWNWT, mfnwt, etc). Default is None.</span>
<span class="sd">    build_prior : bool</span>
<span class="sd">        flag to build prior covariance matrix. Default is True</span>
<span class="sd">    sfr_obs : bool</span>
<span class="sd">        flag to include observations of flow and aquifer exchange from</span>
<span class="sd">        the sfr ASCII output file</span>
<span class="sd">    all_wells : bool [DEPRECATED - now use spatial_bc_pars]</span>
<span class="sd">    hfb_pars : bool</span>
<span class="sd">        add HFB parameters.  uses pyemu.gw_utils.write_hfb_template().  the resulting</span>
<span class="sd">        HFB pars have parval1 equal to the values in the original file and use the</span>
<span class="sd">        spatial_bc_geostruct to build geostatistical covariates between parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PstFromFlopyModel : PstFromFlopyModel</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    pst : pyemu.Pst</span>


<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    works a lot better if TEMPCHEK, INSCHEK and PESTCHEK are available in the</span>
<span class="sd">    system path variable</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">new_model_ws</span><span class="p">,</span><span class="n">org_model_ws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pp_props</span><span class="o">=</span><span class="p">[],</span><span class="n">const_props</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">temporal_bc_props</span><span class="o">=</span><span class="p">[],</span><span class="n">grid_props</span><span class="o">=</span><span class="p">[],</span><span class="n">grid_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">zone_props</span><span class="o">=</span><span class="p">[],</span><span class="n">pp_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">par_bounds_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sfr_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">temporal_bc_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">remove_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">k_zone_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mflist_waterbudget</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mfhyd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">hds_kperk</span><span class="o">=</span><span class="p">[],</span><span class="n">use_pp_zones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">obssim_smp_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">external_tpl_in_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">external_ins_out_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">extra_pre_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">extra_model_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">extra_post_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">redirect_forward_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">tmp_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model_exe_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">build_prior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">sfr_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_wells</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bc_props</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">spatial_bc_props</span><span class="o">=</span><span class="p">[],</span><span class="n">spatial_bc_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">hfb_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kl_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kl_num_eig</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">kl_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;PstFromFlopyModel.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span> <span class="o">=</span> <span class="s2">&quot;_zn&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="o">=</span> <span class="s2">&quot;_gr&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="o">=</span> <span class="s2">&quot;_pp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span> <span class="o">=</span> <span class="s2">&quot;_cn&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span> <span class="o">=</span> <span class="s2">&quot;_kl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span> <span class="o">=</span> <span class="s2">&quot;arr_org&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span> <span class="o">=</span> <span class="s2">&quot;arr_mlt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span> <span class="o">=</span> <span class="s2">&quot;bc_org&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_mlt</span> <span class="o">=</span> <span class="s2">&quot;bc_mlt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_run_file</span> <span class="o">=</span> <span class="s2">&quot;forward_run.py&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span> <span class="o">=</span> <span class="n">remove_existing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span> <span class="o">=</span> <span class="n">external_tpl_in_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span> <span class="o">=</span> <span class="n">external_ins_out_pairs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">org_model_ws</span><span class="p">,</span> <span class="n">new_model_ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_external</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">arr_mult_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span> <span class="o">=</span> <span class="n">par_bounds_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span> <span class="o">=</span> <span class="n">pp_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="o">=</span> <span class="n">pp_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="o">=</span> <span class="n">pp_geostruct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span> <span class="o">=</span> <span class="n">use_pp_zones</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">const_props</span> <span class="o">=</span> <span class="n">const_props</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span> <span class="o">=</span> <span class="n">grid_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="o">=</span> <span class="n">grid_geostruct</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zone_props</span> <span class="o">=</span> <span class="n">zone_props</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kl_props</span> <span class="o">=</span> <span class="n">kl_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_geostruct</span> <span class="o">=</span> <span class="n">kl_geostruct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_num_eig</span> <span class="o">=</span> <span class="n">kl_num_eig</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bc_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temporal_bc_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;bc_props and temporal_bc_props. &quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;bc_props is deprecated and replaced by temporal_bc_props&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;bc_props is deprecated and replaced by temporal_bc_props&quot;</span><span class="p">)</span>
            <span class="n">temporal_bc_props</span> <span class="o">=</span> <span class="n">bc_props</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_props</span> <span class="o">=</span> <span class="n">temporal_bc_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_geostruct</span> <span class="o">=</span> <span class="n">temporal_bc_geostruct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span> <span class="o">=</span> <span class="n">spatial_bc_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_geostruct</span> <span class="o">=</span> <span class="n">spatial_bc_geostruct</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="o">=</span> <span class="n">obssim_smp_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span> <span class="o">=</span> <span class="n">hds_kperk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfr_obs</span> <span class="o">=</span> <span class="n">sfr_obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tmp_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">tmp_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">tmp_files</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tmp_files</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k_zone_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="n">k_zone_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;k_zone_dict layer index not in nlay:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;k_zone_dict arr for k </span><span class="si">{0}</span><span class="s2"> has wrong shape:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span> <span class="o">=</span> <span class="n">k_zone_dict</span>

        <span class="c1"># add any extra commands to the forward run lines</span>

        <span class="k">for</span> <span class="n">alist</span><span class="p">,</span><span class="n">ilist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">extra_pre_cmds</span><span class="p">,</span><span class="n">extra_model_cmds</span><span class="p">,</span><span class="n">extra_post_cmds</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">ilist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ilist</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">ilist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ilist</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">ilist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="n">alist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.os_utils.run(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

        <span class="c1"># add the model call</span>

        <span class="k">if</span> <span class="n">model_exe_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_exe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using flopy binary to execute the model:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">redirect_forward_output</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.os_utils.run(&#39;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> 1&gt;</span><span class="si">{1}</span><span class="s2">.stdout 2&gt;</span><span class="si">{1}</span><span class="s2">.stderr&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_exe_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">namefile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.os_utils.run(&#39;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> &#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_exe_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">namefile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">out_files</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_wells</span> <span class="o">=</span> <span class="n">all_wells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_mult_dirs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_wells</span><span class="p">:</span>
            <span class="c1">#self.setup_all_wells()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;all_wells has been deprecated and replaced with&quot;</span><span class="o">+</span>\
                               <span class="s2">&quot; spatial_bc_pars.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_bc_pars</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">setup_array_pars</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sfr_pars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_sfr_pars</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">hfb_pars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_hfb_pars</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mflist_waterbudget</span> <span class="o">=</span> <span class="n">mflist_waterbudget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_observations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_pst</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">build_prior</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_prior</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parcov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;saving intermediate _setup_&lt;&gt; dfs into </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;_setup_par_</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">.csv&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;_setup_obs_</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">.csv&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;saving intermediate _setup_&lt;&gt; dfs into </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;all done&quot;</span><span class="p">)</span>





<div class="viewcode-block" id="PstFromFlopyModel.setup_sfr_obs"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_sfr_obs">[docs]</a>    <span class="k">def</span> <span class="nf">setup_sfr_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup sfr ASCII observations&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfr_obs</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;no sfr package found...&quot;</span><span class="p">)</span>
        <span class="n">org_sfr_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.sfr.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_sfr_out_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;setup_sfr_obs() error: could not locate existing sfr out file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="n">org_sfr_out_file</span><span class="p">))</span>
        <span class="n">new_sfr_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">org_sfr_out_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_sfr_out_file</span><span class="p">,</span><span class="n">new_sfr_out_file</span><span class="p">)</span>
        <span class="n">seg_group_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfr_obs</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="n">seg_group_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfr_obs</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_sfr_obs</span><span class="p">(</span><span class="n">new_sfr_out_file</span><span class="p">,</span><span class="n">seg_group_dict</span><span class="o">=</span><span class="n">seg_group_dict</span><span class="p">,</span>
                                          <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="n">include_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.gw_utils.apply_sfr_obs()&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PstFromFlopyModel.setup_sfr_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_sfr_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_sfr_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup multiplier parameters for sfr segment data</span>
<span class="sd">        Adding support for reachinput (and isfropt = 1)&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span><span class="s2">&quot;can&#39;t find sfr package...&quot;</span>
        <span class="n">par_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_sfr_seg_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># self.m.namefile,self.m.model_ws) # now just pass model</span>
        <span class="c1"># self.par_dfs[&quot;sfr&quot;] = df</span>
        <span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span> <span class="c1"># may need df for both segs and reaches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_seg_pars.dat.tpl&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_seg_pars.dat&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">reachinput</span><span class="p">:</span> <span class="c1"># setup reaches</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_sfr_reach_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
            <span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_reach_pars.dat.tpl&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_reach_pars.dat&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.gw_utils.apply_sfr_parameters(reach_pars=True)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.gw_utils.apply_sfr_seg_parameters()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="PstFromFlopyModel.setup_hfb_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_hfb_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hfb_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup non-mult parameters for hfb (yuck!)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hfb6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find hfb pak&quot;</span><span class="p">)</span>
        <span class="n">tpl_file</span><span class="p">,</span><span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">write_hfb_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tpl_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;hfb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_mult_dirs"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_mult_dirs">[docs]</a>    <span class="k">def</span> <span class="nf">setup_mult_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup the directories to use for multiplier parameterization.  Directories</span>
<span class="sd">        are make within the PstFromFlopyModel.m.model_ws directory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># setup dirs to hold the original and multiplier model input quantities</span>
        <span class="n">set_dirs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#        if len(self.pp_props) &gt; 0 or len(self.zone_props) &gt; 0 or \</span>
<span class="c1">#                        len(self.grid_props) &gt; 0:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">zone_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">const_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">kl_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">)</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">)</span>
 <span class="c1">#       if len(self.bc_props) &gt; 0:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span><span class="p">):</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_mlt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">set_dirs</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up &#39;</span><span class="si">{0}</span><span class="s2">&#39; dir&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">onerror</span><span class="o">=</span><span class="n">remove_readonly</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;dir &#39;</span><span class="si">{0}</span><span class="s2">&#39; already exists&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up &#39;</span><span class="si">{0}</span><span class="s2">&#39; dir&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_model"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_model">[docs]</a>    <span class="k">def</span> <span class="nf">setup_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">new_model_ws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup the flopy.mbase instance for use with multipler parameters.</span>
<span class="sd">        Changes model_ws, sets external_path and writes new MODFLOW input</span>
<span class="sd">        files</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : flopy.mbase</span>
<span class="sd">            flopy model instance</span>
<span class="sd">        org_model_ws : str</span>
<span class="sd">            the orginal model working space</span>
<span class="sd">        new_model_ws : str</span>
<span class="sd">            the new model working space</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split_new_mws</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_new_mws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;new_model_ws can only be 1 folder-level deep:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">split_new_mws</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading flopy model&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">flopy</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;from_flopy_model() requires flopy&quot;</span><span class="p">)</span>
            <span class="c1"># prepare the flopy model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span> <span class="o">=</span> <span class="n">org_model_ws</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_model_ws</span> <span class="o">=</span> <span class="n">new_model_ws</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model_ws</span><span class="o">=</span><span class="n">org_model_ws</span><span class="p">,</span>
                                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">forgive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading flopy model&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_model_ws</span> <span class="o">=</span> <span class="n">new_model_ws</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;updating model attributes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">array_free_format</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">free_format_input</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;updating model attributes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;&#39;new_model_ws&#39; already exists&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;removing existing &#39;new_model_ws&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">,</span><span class="n">onerror</span><span class="o">=</span><span class="n">remove_readonly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">change_model_ws</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">,</span><span class="n">reset_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.exe&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing new modflow input files&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">write_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing new modflow input files&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.get_count"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.get_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the latest counter for a certain parameter type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            the parameter type</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        count : int</span>
<span class="sd">            the latest count for a parameter type</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        calling this function increments the counter for the passed</span>
<span class="sd">        parameter type</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#print(name,c)</span>
        <span class="k">return</span> <span class="n">c</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.prep_mlt_arrays"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.prep_mlt_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">prep_mlt_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  prepare multipler arrays.  Copies existing model input arrays and</span>
<span class="sd">        writes generic (ones) multiplier arrays</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">par_props</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">zone_props</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">const_props</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">kl_props</span><span class="p">]</span>
        <span class="n">par_suffixs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">]</span>

        <span class="c1"># Need to remove props and suffixes for which no info was provided (e.g. still None)</span>
        <span class="n">del_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">par_props</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">del_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">del_idx</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">del</span><span class="p">(</span><span class="n">par_props</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">del</span><span class="p">(</span><span class="n">par_suffixs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">mlt_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">par_prop</span><span class="p">,</span><span class="n">suffix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">par_props</span><span class="p">,</span><span class="n">par_suffixs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_prop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_prop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">par_prop</span> <span class="o">=</span> <span class="p">[</span><span class="n">par_prop</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_prop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">pakattr</span><span class="p">,</span><span class="n">k_org</span> <span class="ow">in</span> <span class="n">par_prop</span><span class="p">:</span>
                <span class="n">attr_name</span> <span class="o">=</span> <span class="n">pakattr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pak</span><span class="p">,</span><span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pakattr</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
                <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Transient2d</span><span class="p">):</span>
                    <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nper</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">k_parse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_k</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span><span class="n">ks</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error parsing k </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">org</span><span class="p">,</span><span class="n">mlt</span><span class="p">,</span><span class="n">mod</span><span class="p">,</span><span class="n">layer</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
                <span class="n">mlt_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="n">mlt_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.dat</span><span class="si">{1}</span><span class="s2">&quot;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_prefix</span><span class="p">,</span><span class="n">suffix</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_parse</span><span class="p">:</span>
                    <span class="c1"># horrible kludge to avoid passing int64 to flopy</span>
                    <span class="c1"># this gift may give again...</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Util2d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Util3d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Transient2d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">transient_2ds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#big assumption here</span>
                    <span class="n">mod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span><span class="p">,</span><span class="n">fname</span><span class="p">))</span>
                    <span class="n">mlt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlt_name</span><span class="p">)</span>
                    <span class="n">org</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">,</span><span class="n">fname</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;org_file&quot;</span><span class="p">:</span><span class="n">org</span><span class="p">,</span><span class="s2">&quot;mlt_file&quot;</span><span class="p">:</span><span class="n">mlt</span><span class="p">,</span><span class="s2">&quot;model_file&quot;</span><span class="p">:</span><span class="n">mod</span><span class="p">,</span><span class="s2">&quot;layer&quot;</span><span class="p">:</span><span class="n">layer</span><span class="p">})</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suffix</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlt_prefix</span>
                <span class="n">mlt_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlt_dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mlt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">mlt_dfs</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mlt_df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_u2d"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_u2d">[docs]</a>    <span class="k">def</span> <span class="nf">write_u2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u2d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a flopy.utils.Util2D instance to an ASCII text file using the</span>
<span class="sd">        Util2D filename</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        u2d : flopy.utils.Util2D</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        filename : str</span>
<span class="sd">            the name of the file written (without path)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">u2d</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span>
                   <span class="n">u2d</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_const_tpl"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_const_tpl">[docs]</a>    <span class="k">def</span> <span class="nf">write_const_tpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">zn_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a template file a for a constant (uniform) multiplier parameter</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            the base parameter name</span>
<span class="sd">        tpl_file : str</span>
<span class="sd">            the template file to write</span>
<span class="sd">        zn_array : numpy.ndarray</span>
<span class="sd">            an array used to skip inactive cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            a dataframe with parameter information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; 1.0  &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;zone pname too long:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                        <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; ~   </span><span class="si">{0}</span><span class="s2">    ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
        <span class="c1">#df.loc[:,&quot;pargp&quot;] = &quot;{0}{1}&quot;.format(self.cn_suffixname)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_grid_tpl"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_grid_tpl">[docs]</a>    <span class="k">def</span> <span class="nf">write_grid_tpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">zn_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a template file a for grid-based multiplier parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            the base parameter name</span>
<span class="sd">        tpl_file : str</span>
<span class="sd">            the template file to write</span>
<span class="sd">        zn_array : numpy.ndarray</span>
<span class="sd">            an array used to skip inactive cells</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            a dataframe with parameter information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parnme</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="p">[],[],[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39; 1.0 &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1:03d}{2:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;grid pname too long:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                        <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39; ~     </span><span class="si">{0}</span><span class="s1">   ~ &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="n">name</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_zone_tpl"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_zone_tpl">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">write_zone_tpl</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">,</span> <span class="n">zn_array</span><span class="p">,</span> <span class="n">zn_suffix</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a template file a for zone-based multiplier parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : flopy model object</span>
<span class="sd">            model from which to obtain workspace information, nrow, and ncol</span>
<span class="sd">        name : str</span>
<span class="sd">            the base parameter name</span>
<span class="sd">        tpl_file : str</span>
<span class="sd">            the template file to write</span>
<span class="sd">        zn_array : numpy.ndarray</span>
<span class="sd">            an array used to skip inactive cells</span>

<span class="sd">        logger : a logger object</span>
<span class="sd">            optional - a logger object to document errors, etc.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            a dataframe with parameter information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; 1.0  &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_zn</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;zone pname too long:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                        <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; ~   </span><span class="si">{0}</span><span class="s2">    ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zn_suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.grid_prep"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.grid_prep">[docs]</a>    <span class="k">def</span> <span class="nf">grid_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prepare grid-based parameterizations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;grid_geostruct is None,&quot;</span>\
                  <span class="s2">&quot; using ExpVario with contribution=1 and a=(max(delc,delr)*10&quot;</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.pp_prep"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.pp_prep">[docs]</a>    <span class="k">def</span> <span class="nf">pp_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mlt_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prepare pilot point based parameterizations</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mlt_df : pandas.DataFrame</span>
<span class="sd">            a dataframe with multiplier array information</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        calls pyemu.pp_utils.setup_pilot_points_grid()</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pp_space is None, using 10...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span><span class="o">=</span><span class="mi">10</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pp_geostruct is None,&quot;</span>\
                  <span class="s2">&quot; using ExpVario with contribution=1 and a=(pp_space*max(delr,delc))&quot;</span><span class="p">)</span>
            <span class="n">pp_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">pp_dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

        <span class="n">pp_df</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">,:]</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">pp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">layer</span><span class="o">==</span><span class="n">l</span><span class="p">,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">}</span>
        <span class="c1"># big assumption here - if prefix is listed more than once, use the lowest layer index</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pp_dict</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pp_dict</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">-</span> <span class="n">p</span>
                <span class="n">pp_dict</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>


        <span class="n">pp_array_file</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">m</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">pp_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pp_dict: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pp_dict</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling setup_pilot_point_grid()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span><span class="p">:</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)}</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="n">ib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">u</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">mx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0e+10</span>
                    <span class="n">imx</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">mx</span><span class="p">:</span>
                            <span class="n">mx</span> <span class="o">=</span> <span class="n">c</span>
                            <span class="n">imx</span> <span class="o">=</span> <span class="n">u</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;resetting negative ibound values for PP zone&quot;</span><span class="o">+</span> \
                                     <span class="s2">&quot;array in layer </span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
                    <span class="n">i</span><span class="p">[</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">pp_df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">setup_pilotpoints_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                                         <span class="n">ibound</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span>
                                         <span class="n">use_ibound_zones</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span><span class="p">,</span>
                                         <span class="n">prefix_dict</span><span class="o">=</span><span class="n">pp_dict</span><span class="p">,</span>
                                         <span class="n">every_n_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span><span class="p">,</span>
                                         <span class="n">pp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                         <span class="n">tpl_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                         <span class="n">shapename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;pp.shp&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> pilot point parameters created&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pilot point &#39;pargp&#39;:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling setup_pilot_point_grid()&quot;</span><span class="p">)</span>

        <span class="c1"># calc factors for each layer</span>
        <span class="n">pargp</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">pp_dfs_k</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fac_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="n">pargp</span><span class="p">:</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pg</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;something is wrong in fac calcs for par group </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pg</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                <span class="n">ib_k</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#self.logger.lraise(&quot;something is wrong in fac calcs for par group {0}&quot;.format(pg))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;multiple k values for </span><span class="si">{0}</span><span class="s2">,forming composite zone array...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pg</span><span class="p">))</span>
                <span class="n">ib_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ib_k</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp_dfs_k</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calculating factors for k=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

                <span class="n">fac_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;pp_k</span><span class="si">{0}</span><span class="s2">.fac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="n">var_file</span> <span class="o">=</span> <span class="n">fac_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.fac&quot;</span><span class="p">,</span><span class="s2">&quot;.var.dat&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving krige variance file:</span><span class="si">{0}</span><span class="s2">&quot;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving krige factors file:</span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fac_file</span><span class="p">))</span>
                <span class="n">pp_df_k</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pg</span><span class="p">]</span>
                <span class="n">ok_pp</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">OrdinaryKrige</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span><span class="p">,</span><span class="n">pp_df_k</span><span class="p">)</span>
                <span class="n">ok_pp</span><span class="o">.</span><span class="n">calc_factors_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span><span class="n">var_filename</span><span class="o">=</span><span class="n">var_file</span><span class="p">,</span>
                                        <span class="n">zone_array</span><span class="o">=</span><span class="n">ib_k</span><span class="p">)</span>
                <span class="n">ok_pp</span><span class="o">.</span><span class="n">to_grid_factors_file</span><span class="p">(</span><span class="n">fac_file</span><span class="p">)</span>
                <span class="n">fac_files</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calculating factors for k=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="n">pp_dfs_k</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df_k</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">fac_file</span> <span class="ow">in</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#pp_files = pp_df.pp_filename.unique()</span>
            <span class="n">fac_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fac_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pp_prefixes</span> <span class="o">=</span> <span class="n">pp_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pp_prefix</span> <span class="ow">in</span> <span class="n">pp_prefixes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing pp_prefix:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pp_prefix</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">pp_prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp_array_file</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not in self.pp_array_file.keys()&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span>
                                              <span class="n">join</span><span class="p">(</span><span class="n">pp_array_file</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>


                <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pp_array_file</span><span class="p">[</span><span class="n">pp_prefix</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">pp_files</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pp_filename</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pp_prefix</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span><span class="s2">&quot;pp_filename&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of pp_files found:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pp_files</span><span class="p">)))</span>
                <span class="n">pp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pp_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
                <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_file</span>
                <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_file</span>

        <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;pp_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span>
                    <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">)),</span><span class="s2">&quot;mlt_file&quot;</span><span class="p">]</span>
        <span class="c1">#mlt_df.loc[:,&quot;fac_file&quot;] = np.NaN</span>
        <span class="c1">#mlt_df.loc[:,&quot;pp_file&quot;] = np.NaN</span>
        <span class="k">for</span> <span class="n">out_file</span> <span class="ow">in</span> <span class="n">out_files</span><span class="p">:</span>
            <span class="n">pp_df_pf</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">out_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,:]</span>
            <span class="n">fac_files</span> <span class="o">=</span> <span class="n">pp_df_pf</span><span class="o">.</span><span class="n">fac_file</span>
            <span class="k">if</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of fac files:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fac_files</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
            <span class="n">fac_file</span> <span class="o">=</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pp_files</span> <span class="o">=</span> <span class="n">pp_df_pf</span><span class="o">.</span><span class="n">pp_file</span>
            <span class="k">if</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of pp files:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
            <span class="n">pp_file</span> <span class="o">=</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df</span>

        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span></div>


<div class="viewcode-block" id="PstFromFlopyModel.kl_prep"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.kl_prep">[docs]</a>    <span class="k">def</span> <span class="nf">kl_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mlt_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prepare KL based parameterizations</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mlt_df : pandas.DataFrame</span>
<span class="sd">            a dataframe with multiplier array information</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        calls pyemu.helpers.setup_kl()</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;kl_geostruct is None,&quot;</span>\
                  <span class="s2">&quot; using ExpVario with contribution=1 and a=(10.0*max(delr,delc))&quot;</span><span class="p">)</span>
            <span class="n">kl_dist</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">kl_dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kl_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>

        <span class="n">kl_df</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">,:]</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1">#kl_dict = {l:list(kl_df.loc[kl_df.layer==l,&quot;prefix&quot;].unique()) for l in layers}</span>
        <span class="c1"># big assumption here - if prefix is listed more than once, use the lowest layer index</span>
        <span class="c1">#for i,l in enumerate(layers):</span>
        <span class="c1">#    p = set(kl_dict[l])</span>
        <span class="c1">#    for ll in layers[i+1:]:</span>
        <span class="c1">#        pp = set(kl_dict[ll])</span>
        <span class="c1">#        d = pp - p</span>
        <span class="c1">#        kl_dict[ll] = list(d)</span>
        <span class="n">kl_prefix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kl_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">])</span>

        <span class="n">kl_array_file</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">m</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kl_df</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">kl_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;kl_prefix: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kl_prefix</span><span class="p">)))</span>

        <span class="n">fac_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;kl.fac&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling kl_setup() with factors file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fac_file</span><span class="p">))</span>

        <span class="n">kl_df</span> <span class="o">=</span> <span class="n">kl_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_num_eig</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_geostruct</span><span class="p">,</span><span class="n">kl_prefix</span><span class="p">,</span>
                         <span class="n">factors_file</span><span class="o">=</span><span class="n">fac_file</span><span class="p">,</span><span class="n">basis_file</span><span class="o">=</span><span class="n">fac_file</span><span class="o">+</span><span class="s2">&quot;.basis.jcb&quot;</span><span class="p">,</span>
                         <span class="n">tpl_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> kl parameters created&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="n">kl_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;kl &#39;pargp&#39;:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kl_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling kl_setup() with factors file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fac_file</span><span class="p">))</span>
        <span class="n">kl_mlt_df</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">prefix_df</span> <span class="o">=</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kl_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,:]</span>
            <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prefix_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;in_file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_file</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fac_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">kl_mlt_df</span><span class="p">)</span>
        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">,</span> <span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">kl_df</span></div>
        <span class="c1"># calc factors for each layer</span>


<div class="viewcode-block" id="PstFromFlopyModel.setup_array_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_array_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_array_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; main entry point for setting up array multipler parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mlt_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_mlt_arrays</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mlt_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)</span>
        <span class="c1">#mlt_df.loc[mlt_df.tpl_file.apply(lambda x:pd.notnull(x.pp_file)),&quot;tpl_file&quot;] = np.NaN</span>
        <span class="n">mlt_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1">#for suffix,tpl_file,layer,name in zip(self.mlt_df.suffix,</span>
        <span class="c1">#                                 self.mlt_df.tpl,self.mlt_df.layer,</span>
        <span class="c1">#                                     self.mlt_df.prefix):</span>
        <span class="n">par_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mlt_file</span> <span class="ow">in</span> <span class="n">mlt_files</span><span class="p">:</span>
            <span class="n">suffixes</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of suffixes for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">tpl_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of tpl_files for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span>
            <span class="c1">#if layers.unique().shape[0] != 1:</span>
            <span class="c1">#    self.logger.lraise(&quot;wrong number of layers for {0}&quot;\</span>
            <span class="c1">#                       .format(mlt_file))</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">names</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of names for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#ib = self.k_zone_dict[layer]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing const tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_const_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing const tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing grid tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_grid_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing grid tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing zone tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_zone_tpl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing zone tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par_dfs</span><span class="p">:</span>
                <span class="n">par_dfs</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">par_dfs</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">suf</span><span class="p">,</span><span class="n">dfs</span> <span class="ow">in</span> <span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="n">suf</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up pilot point process&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_prep</span><span class="p">(</span><span class="n">mlt_df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up pilot point process&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up grid process&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_prep</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up grid process&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up kl process&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kl_prep</span><span class="p">(</span><span class="n">mlt_df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up kl process&quot;</span><span class="p">)</span>

        <span class="n">mlt_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;arr_pars.csv&quot;</span><span class="p">))</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">mlt_file</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;save test mlt array </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">mlt_file</span><span class="p">),</span>
                       <span class="n">ones</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;save test mlt array </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">tpl_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span> <span class="o">==</span> <span class="n">mlt_file</span><span class="p">,</span> <span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of tpl_files for </span><span class="si">{0}</span><span class="s2">&quot;</span> \
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">)</span>

        <span class="c1"># for tpl_file,mlt_file in zip(mlt_df.tpl_file,mlt_df.mlt_file):</span>
        <span class="c1">#     if pd.isnull(tpl_file):</span>
        <span class="c1">#         continue</span>
        <span class="c1">#     self.tpl_files.append(tpl_file)</span>
        <span class="c1">#     self.in_files.append(mlt_file)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apply_array_pars</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error test running apply_array_pars():</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.helpers.apply_array_pars()</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_observations"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_observations">[docs]</a>    <span class="k">def</span> <span class="nf">setup_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; main entry point for setting up observations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs_methods</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_water_budget_obs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_hyd</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">setup_smp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_hob</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_hds</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">setup_sfr_obs</span><span class="p">]</span>
        <span class="n">obs_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mflist water budget obs&quot;</span><span class="p">,</span><span class="s2">&quot;hyd file&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;external obs-sim smp files&quot;</span><span class="p">,</span><span class="s2">&quot;hob&quot;</span><span class="p">,</span><span class="s2">&quot;hds&quot;</span><span class="p">,</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">obs_method</span><span class="p">,</span> <span class="n">obs_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_methods</span><span class="p">,</span><span class="n">obs_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing obs type </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_type</span><span class="p">))</span>
            <span class="n">obs_method</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing obs type </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_type</span><span class="p">))</span></div>



<div class="viewcode-block" id="PstFromFlopyModel.draw"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.draw">[docs]</a>    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_reals</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">sigma_range</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; draw like a boss!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            num_reals : int</span>
<span class="sd">                number of realizations to generate. Default is 100</span>
<span class="sd">            sigma_range : float</span>
<span class="sd">                number of standard deviations represented by the parameter bounds.  Default</span>
<span class="sd">                is 6.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            cov : pyemu.Cov</span>
<span class="sd">            a full covariance matrix</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;drawing realizations&quot;</span><span class="p">)</span>
        <span class="n">struct_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">]</span>
            <span class="n">pp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">pp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#pp_dfs = [pp_df.loc[pp_df.pargp==pargp,:].copy() for pargp in pp_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_dfs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">gr_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">]</span>
            <span class="n">gr_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">gr_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#gr_dfs = [gr_df.loc[gr_df.pargp==pargp,:].copy() for pargp in gr_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;temporal_bc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;temporal_bc&quot;</span><span class="p">]</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">timedelta</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#bc_dfs = [bc_df.loc[bc_df.pargp==pargp,:].copy() for pargp in bc_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;spatial_bc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;spatial_bc&quot;</span><span class="p">]</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="c1">#p_df = gp_df.drop_duplicates(subset=&quot;parnme&quot;)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gp_df</span><span class="p">)</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">geostatistical_draws</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span><span class="n">struct_dict</span><span class="o">=</span><span class="n">struct_dict</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="n">num_reals</span><span class="p">,</span>
                             <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;drawing realizations&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pe</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.build_prior"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.build_prior">[docs]</a>    <span class="k">def</span> <span class="nf">build_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">droptol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">sigma_range</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; build a prior parameter covariance matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            fmt : str</span>
<span class="sd">                the format to save the cov matrix.  Options are &quot;ascii&quot;,&quot;binary&quot;,&quot;uncfile&quot;, &quot;coo&quot;.</span>
<span class="sd">                default is &quot;ascii&quot;</span>
<span class="sd">            filename : str</span>
<span class="sd">                the filename to save the prior cov matrix to.  If None, the name is formed using</span>
<span class="sd">                model nam_file name.  Default is None.</span>
<span class="sd">            droptol : float</span>
<span class="sd">                tolerance for dropping near-zero values when writing compressed binary.</span>
<span class="sd">                Default is None</span>
<span class="sd">            chunk : int</span>
<span class="sd">                chunk size to write in a single pass - for binary only</span>
<span class="sd">            sparse : bool</span>
<span class="sd">                flag to build a pyemu.SparseMatrix format cov matrix.  Default is False</span>
<span class="sd">            sigma_range : float</span>
<span class="sd">                number of standard deviations represented by the parameter bounds.  Default</span>
<span class="sd">                is 6.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            cov : pyemu.Cov</span>
<span class="sd">            a full covariance matrix</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">acc_fmts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span><span class="s2">&quot;uncfile&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="s2">&quot;coo&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acc_fmts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized prior save &#39;fmt&#39;:</span><span class="si">{0}</span><span class="s2">, options are: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">acc_fmts</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building prior covariance matrix&quot;</span><span class="p">)</span>
        <span class="n">struct_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">]</span>
            <span class="n">pp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">pp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#pp_dfs = [pp_df.loc[pp_df.pargp==pargp,:].copy() for pargp in pp_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_dfs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">gr_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">]</span>
            <span class="n">gr_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">gr_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#gr_dfs = [gr_df.loc[gr_df.pargp==pargp,:].copy() for pargp in gr_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;temporal_bc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;temporal_bc&quot;</span><span class="p">]</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">timedelta</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#bc_dfs = [bc_df.loc[bc_df.pargp==pargp,:].copy() for pargp in bc_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;spatial_bc&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;spatial_bc&quot;</span><span class="p">]</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="c1">#p_df = gp_df.drop_duplicates(subset=&quot;parnme&quot;)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gp_df</span><span class="p">)</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;hfb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_geostruct</span> <span class="ow">in</span> <span class="n">struct_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_geostruct</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;hfb&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;hfb&quot;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">sparse_geostatistical_prior_builder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span>
                                                                        <span class="n">struct_dict</span><span class="o">=</span><span class="n">struct_dict</span><span class="p">,</span>
                                                                        <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">geostatistical_prior_builder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span>
                                                             <span class="n">struct_dict</span><span class="o">=</span><span class="n">struct_dict</span><span class="p">,</span>
                                                             <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="o">+</span><span class="s2">&quot;.prior.cov&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving prior covariance matrix to file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;ascii&#39;</span><span class="p">:</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">to_ascii</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">to_binary</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">droptol</span><span class="o">=</span><span class="n">droptol</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;uncfile&#39;</span><span class="p">:</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">to_uncfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;coo&#39;</span><span class="p">:</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">to_coo</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">droptol</span><span class="o">=</span><span class="n">droptol</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building prior covariance matrix&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.build_pst"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.build_pst">[docs]</a>    <span class="k">def</span> <span class="nf">build_pst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; build the pest control file using the parameterizations and</span>
<span class="sd">        observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            filename : str</span>
<span class="sd">                the filename to save the pst to.  If None, the name if formed from</span>
<span class="sd">                the model namfile name.  Default is None.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        calls pyemu.Pst.from_io_files</span>

<span class="sd">        calls PESTCHEK</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;changing dir in to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="n">tpl_files</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">)</span>
        <span class="n">in_files</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">new_tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">]</span>
            <span class="n">new_in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">new_tpl_files</span><span class="p">]</span>
            <span class="n">tpl_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_tpl_files</span><span class="p">)</span>
            <span class="n">in_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_in_files</span><span class="p">)</span>
            <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">)]</span>
            <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tpl_file</span><span class="p">,</span><span class="n">in_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tpl_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;instantiating control file from i/o files&quot;</span><span class="p">)</span>
            <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="o">.</span><span class="n">from_io_files</span><span class="p">(</span><span class="n">tpl_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">,</span>
                                          <span class="n">in_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span>
                                          <span class="n">ins_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">,</span>
                                          <span class="n">out_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_files</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;instantiating control file from i/o files&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error build Pst:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
        <span class="c1"># more customization here</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;parnme&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span>
        <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span>
        <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;parnme&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;parubnd&quot;</span><span class="p">,</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">tag</span><span class="p">,[</span><span class="n">lw</span><span class="p">,</span><span class="n">up</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wildass_guess_par_bounds_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span>
            <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lw</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,[</span><span class="n">lw</span><span class="p">,</span><span class="n">up</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span>
                <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lw</span>



        <span class="n">obs</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">observation_data</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;obsnme&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.pst&quot;</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">model_command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;python forward_run.py&quot;</span><span class="p">]</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">noptmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing forward_run.py&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_forward_run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing forward_run.py&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;writing pst </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">pst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pst</span> <span class="o">=</span> <span class="n">pst</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;running pestchek on </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="s2">&quot;pestchek </span><span class="si">{0}</span><span class="s2"> &gt;pestchek.stdout&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;error running pestchek:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;pestchek.stdout&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pestcheck:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;running pestchek on </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.add_external"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.add_external">[docs]</a>    <span class="k">def</span> <span class="nf">add_external</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; add external (existing) template files and instrution files to the</span>
<span class="sd">        Pst instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">external_tpl_in_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tpl_file</span><span class="p">,</span><span class="n">in_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find external tpl file:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                       <span class="nb">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;external tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">in_file</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">external_ins_out_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ins_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find external ins file:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                       <span class="nb">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;external ins:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;obs listed in </span><span class="si">{0}</span><span class="s2"> will have values listed in </span><span class="si">{1}</span><span class="s2">&quot;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;obs listed in </span><span class="si">{0}</span><span class="s2"> will have generic values&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.write_forward_run"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.write_forward_run">[docs]</a>    <span class="k">def</span> <span class="nf">write_forward_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write the forward run script forward_run.py</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_run_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;import os</span><span class="se">\n</span><span class="s2">import numpy as np</span><span class="se">\n</span><span class="s2">import pandas as pd</span><span class="se">\n</span><span class="s2">import flopy</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;import pyemu</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tmp_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;try:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   os.remove(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;except Exception as e:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   print(&#39;error removing tmp file:</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.parse_k"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.parse_k">[docs]</a>    <span class="k">def</span> <span class="nf">parse_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">vals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; parse the iterable from a property or boundary condition argument</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : int or iterable int</span>
<span class="sd">            the iterable</span>
<span class="sd">        vals : iterable of ints</span>
<span class="sd">            the acceptable values that k may contain</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        k_vals : iterable of int</span>
<span class="sd">            parsed k values</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">,</span><span class="s2">&quot;k </span><span class="si">{0}</span><span class="s2"> not in vals&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error slicing vals with </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">k_vals</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.parse_pakattr"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.parse_pakattr">[docs]</a>    <span class="k">def</span> <span class="nf">parse_pakattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pakattr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; parse package-iterable pairs from a property or boundary condition</span>
<span class="sd">        argument</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pakattr : iterable len 2</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pak : flopy.PakBase</span>
<span class="sd">            the flopy package from the model instance</span>
<span class="sd">        attr : (varies)</span>
<span class="sd">            the flopy attribute from pak.  Could be Util2D, Util3D,</span>
<span class="sd">            Transient2D, or MfList</span>
<span class="sd">        attrname : (str)</span>
<span class="sd">            the name of the attribute for MfList type.  Only returned if</span>
<span class="sd">            attr is MfList.  For example, if attr is MfList and pak is</span>
<span class="sd">            flopy.modflow.ModflowWel, then attrname can only be &quot;flux&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="n">pakattr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;pakattr is wrong:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pakattr</span><span class="p">))</span>
        <span class="n">pakname</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">attrname</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="n">pakname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pak</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pakname</span> <span class="o">==</span> <span class="s2">&quot;extra&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;&#39;extra&#39; pak detected:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pakattr</span><span class="p">))</span>
                <span class="n">ud</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Util3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">attrname</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;extra&quot;</span><span class="p">,</span><span class="n">ud</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;pak </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pakname</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="n">attrname</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="n">attrname</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pak</span><span class="p">,</span><span class="n">attr</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="s2">&quot;stress_period_data&quot;</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">stress_period_data</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">if</span> <span class="n">attrname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;attr </span><span class="si">{0}</span><span class="s2"> not found in dtype.names for </span><span class="si">{1}</span><span class="s2">.stress_period_data&quot;</span><span class="o">.</span>\
                                  <span class="nb">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span><span class="n">pakname</span><span class="p">))</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">stress_period_data</span>
            <span class="k">return</span> <span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">attrname</span>
        <span class="c1"># elif hasattr(pak,&#39;hfb_data&#39;):</span>
        <span class="c1">#     dtype = pak.hfb_data.dtype</span>
        <span class="c1">#     if attrname not in dtype.names:</span>
        <span class="c1">#         self.logger.lraise(&#39;attr {0} not found in dtypes.names for {1}.hfb_data. Thanks for playing.&#39;.\</span>
        <span class="c1">#                            format(attrname,pakname))</span>
        <span class="c1">#     attr = pak.hfb_data</span>
        <span class="c1">#     return pak, attr, attrname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized attr:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">))</span></div>


<div class="viewcode-block" id="PstFromFlopyModel.setup_bc_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_bc_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_bc_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_temporal_bc_pars</span><span class="p">()</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_spatial_bc_pars</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apply_bc_pars</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error test running apply_bc_pars():</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.helpers.apply_bc_pars()</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_temporal_bc_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_temporal_bc_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_temporal_bc_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; main entry point for setting up boundary condition multiplier</span>
<span class="sd">        parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing temporal_bc_props&quot;</span><span class="p">)</span>
        <span class="c1"># if not isinstance(self.bc_prop_dict,dict):</span>
        <span class="c1">#     self.logger.lraise(&quot;bc_prop_dict must be &#39;dict&#39;, not {0}&quot;.</span>
        <span class="c1">#                        format(str(type(self.bc_prop_dict))))</span>
        <span class="n">bc_filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_pak</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_dtype_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_props</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_props</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_props</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pakattr</span><span class="p">,</span><span class="n">k_org</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_props</span><span class="p">:</span>
            <span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pakattr</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
            <span class="n">k_parse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_k</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nper</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_count</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_parse</span><span class="p">:</span>
                <span class="n">bc_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_helper</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>
                <span class="n">bc_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">pak_name</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">bc_pak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pak_name</span><span class="p">)</span>
                <span class="n">bc_k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">bc_dtype_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>

                <span class="n">bc_parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">_</span><span class="si">{2:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak_name</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">bc_filenames</span><span class="p">,</span><span class="s2">&quot;col&quot;</span><span class="p">:</span><span class="n">bc_cols</span><span class="p">,</span>
                           <span class="s2">&quot;kper&quot;</span><span class="p">:</span><span class="n">bc_k</span><span class="p">,</span><span class="s2">&quot;pak&quot;</span><span class="p">:</span><span class="n">bc_pak</span><span class="p">,</span>
                           <span class="s2">&quot;dtype_names&quot;</span><span class="p">:</span><span class="n">bc_dtype_names</span><span class="p">,</span>
                          <span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">bc_parnme</span><span class="p">})</span>
        <span class="n">tds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">perlen</span><span class="o">.</span><span class="n">array</span><span class="p">),</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">dts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">_start_datetime</span><span class="p">)</span> <span class="o">+</span> <span class="n">tds</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dts</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;timedelta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tds</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1">#df.loc[:,&quot;kper&quot;] = df.kper.apply(np.int)</span>
        <span class="c1">#df.loc[:,&quot;parnme&quot;] = df.apply(lambda x: &quot;{0}{1}_{2:03d}&quot;.format(x.pak,x.col,x.kper),axis=1)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;~   </span><span class="si">{0}</span><span class="s2">   ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;bc_org&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;model_ext_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span><span class="s2">&quot;dtype_names&quot;</span><span class="p">,</span><span class="s2">&quot;bc_org&quot;</span><span class="p">,</span><span class="s2">&quot;model_ext_path&quot;</span><span class="p">,</span><span class="s2">&quot;col&quot;</span><span class="p">,</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span><span class="s2">&quot;pak&quot;</span><span class="p">,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">names</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;temporal_bc_pars.dat&quot;</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tpl_str</span>
        <span class="n">tpl_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s1">&#39;temporal_bc_pars.dat.tpl&#39;</span><span class="p">)</span>
        <span class="c1">#f_tpl =  open(tpl_name,&#39;w&#39;)</span>
        <span class="c1">#f_tpl.write(&quot;ptf ~\n&quot;)</span>
        <span class="c1">#f_tpl.flush()</span>
        <span class="c1"># df.loc[:,names].to_csv(f_tpl,sep=&#39; &#39;,quotechar=&#39; &#39;)</span>
        <span class="c1">#f_tpl.write(&quot;index &quot;)</span>
        <span class="c1">#f_tpl.write(df.loc[:,names].to_string(index_names=True))</span>
        <span class="c1">#f_tpl.close()</span>
        <span class="n">write_df_tpl</span><span class="p">(</span><span class="n">tpl_name</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">names</span><span class="p">],</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;temporal_bc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mf">180.0</span><span class="p">)</span> <span class="c1"># 180 correlation length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temporal_bc_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing temporal_bc_props&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_spatial_bc_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_spatial_bc_pars">[docs]</a>    <span class="k">def</span> <span class="nf">setup_spatial_bc_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;helper to setup crazy numbers of well flux multipliers&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing spatial_bc_props&quot;</span><span class="p">)</span>

        <span class="n">bc_filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_pak</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_dtype_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pakattr</span><span class="p">,</span> <span class="n">k_org</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_props</span><span class="p">:</span>
            <span class="n">pak</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pakattr</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
            <span class="n">k_parse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_k</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_parse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;spatial_bc_pars error: each set of spatial bc pars can only be applied &quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;to a single layer (e.g. [wel.flux,0].</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;You passed [</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">], implying broadcasting to layers </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">pakattr</span><span class="p">,</span><span class="n">k_org</span><span class="p">,</span><span class="n">k_parse</span><span class="p">))</span>
            <span class="c1"># # horrible special case for HFB since it cannot vary over time</span>
            <span class="c1">#if type(pak) != flopy.modflow.mfhfb.ModflowHfb:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nper</span><span class="p">):</span>
                <span class="n">bc_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_helper</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pak</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
                <span class="n">bc_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">pak_name</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">bc_pak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pak_name</span><span class="p">)</span>
                <span class="n">bc_k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_parse</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#bc_dtype_names.append(list(attr.dtype.names))</span>
                <span class="n">bc_dtype_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
            <span class="c1"># else:</span>
            <span class="c1"># bc_filenames.append(self.bc_helper(k, pak, attr, col))</span>
            <span class="c1"># bc_cols.append(col)</span>
            <span class="c1"># pak_name = pak.name[0].lower()</span>
            <span class="c1"># bc_pak.append(pak_name)</span>
            <span class="c1"># bc_k.append(k_parse[0])</span>
            <span class="c1"># bc_dtype_names.append(&#39;,&#39;.join(attr.dtype.names))</span>

        <span class="n">info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">bc_filenames</span><span class="p">,</span> <span class="s2">&quot;col&quot;</span><span class="p">:</span> <span class="n">bc_cols</span><span class="p">,</span>
                           <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">bc_k</span><span class="p">,</span> <span class="s2">&quot;pak&quot;</span><span class="p">:</span> <span class="n">bc_pak</span><span class="p">,</span>
                           <span class="s2">&quot;dtype_names&quot;</span><span class="p">:</span> <span class="n">bc_dtype_names</span><span class="p">})</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;bc_mlt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_mlt</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;bc_org&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;model_ext_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span>

        <span class="c1"># check that all files for a given package have the same number of entries</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;itmp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">pak_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pak</span> <span class="ow">in</span> <span class="n">info_df</span><span class="o">.</span><span class="n">pak</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">df_pak</span> <span class="o">=</span> <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">info_df</span><span class="o">.</span><span class="n">pak</span><span class="o">==</span><span class="n">pak</span><span class="p">,:]</span>
            <span class="n">itmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">df_pak</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">df_pak</span><span class="o">.</span><span class="n">dtype_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="c1">#mif pak != &#39;hfb6&#39;:</span>
                <span class="n">fdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                                  <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;j&#39;</span><span class="p">]:</span>
                    <span class="n">fdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="c1"># else:</span>
                <span class="c1">#     # need to navigate the HFB file to skip both comments and header line</span>
                <span class="c1">#     skiprows = sum(</span>
                <span class="c1">#         [1 if i.strip().startswith(&#39;#&#39;) else 0</span>
                <span class="c1">#          for i in open(os.path.join(self.m.model_ws, filename), &#39;r&#39;).readlines()]) + 1</span>
                <span class="c1">#     fdf = pd.read_csv(os.path.join(self.m.model_ws, filename),</span>
                <span class="c1">#                       delim_whitespace=True, header=None, names=names, skiprows=skiprows  ).dropna()</span>
                <span class="c1">#</span>
                <span class="c1">#     for c in [&#39;k&#39;, &#39;irow1&#39;,&#39;icol1&#39;,&#39;irow2&#39;,&#39;icol2&#39;]:</span>
                <span class="c1">#         fdf.loc[:, c] -= 1</span>

                <span class="n">itmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">pak_dfs</span><span class="p">[</span><span class="n">pak</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdf</span>
            <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">info_df</span><span class="o">.</span><span class="n">pak</span><span class="o">==</span><span class="n">pak</span><span class="p">,</span><span class="s2">&quot;itmp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">itmp</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">itmp</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">info_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;spatial_bc_trouble.csv&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;spatial_bc_pars() error: must have same number of &quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;entries for every stress period for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">))</span>

        <span class="c1"># make the pak dfs have unique model indices</span>
        <span class="k">for</span> <span class="n">pak</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">pak_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#if pak != &#39;hfb6&#39;:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:02.0f}{1:04.0f}{2:04.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     df.loc[:, &quot;idx&quot;] = df.apply(lambda x: &quot;{0:02.0f}{1:04.0f}{2:04.0f}{2:04.0f}{2:04.0f}&quot;.format(x.k, x.irow1, x.icol1,</span>
            <span class="c1">#                                                                                                  x.irow2, x.icol2), axis=1)</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;duplicate entries in bc pak </span><span class="si">{0}</span><span class="s2">...collapsing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">))</span>
                <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">idx</span>
            <span class="n">pak_dfs</span><span class="p">[</span><span class="n">pak</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># write template files - find which cols are parameterized...</span>
        <span class="n">par_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pak</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">pak_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pak_df</span> <span class="o">=</span> <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">info_df</span><span class="o">.</span><span class="n">pak</span><span class="o">==</span><span class="n">pak</span><span class="p">,:]</span>
            <span class="c1"># reset all non-index cols to 1.0</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;j&#39;</span><span class="p">,</span><span class="s1">&#39;inode&#39;</span><span class="p">,</span> <span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_mlt</span><span class="p">,</span><span class="n">pak</span><span class="o">+</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
            <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pak</span> <span class="o">+</span> <span class="s2">&quot;.csv.tpl&quot;</span><span class="p">)</span>
            <span class="c1"># save an all &quot;ones&quot; mult df for testing</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">in_file</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">parnme</span><span class="p">,</span><span class="n">pargp</span> <span class="o">=</span> <span class="p">[],[]</span>
            <span class="c1">#if pak != &#39;hfb6&#39;:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># else:</span>
            <span class="c1">#     # note -- for HFB6, only row and col for node 1</span>
            <span class="c1">#     x = df.apply(lambda x: self.m.sr.xcentergrid[int(x.irow1),int(x.icol1)],axis=1).values</span>
            <span class="c1">#     y = df.apply(lambda x: self.m.sr.ycentergrid[int(x.irow1),int(x.icol1)],axis=1).values</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pak_df</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">col_df</span> <span class="o">=</span> <span class="n">pak_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pak_df</span><span class="o">.</span><span class="n">col</span><span class="o">==</span><span class="n">col</span><span class="p">]</span>
                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">col_df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="n">npar</span> <span class="o">=</span> <span class="n">col_df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k_vals</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">npar</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}{1}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">))</span>

                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;~   </span><span class="si">{0}</span><span class="s2">   ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k_vals</span><span class="p">),</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">par_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">:</span><span class="n">df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">values</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
                <span class="n">par_df</span> <span class="o">=</span> <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par_df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k_vals</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">par_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;no parameters found for spatial bc k,pak,attr </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span><span class="n">pak</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>

                <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">_k</span><span class="si">{2:02.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="o">.</span><span class="n">values</span>
                <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
                <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;in_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_file</span>
                <span class="n">par_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_df</span><span class="p">)</span>


            <span class="c1">#with open(os.path.join(self.m.model_ws,tpl_file),&#39;w&#39;) as f:</span>
            <span class="c1">#    f.write(&quot;ptf ~\n&quot;)</span>
                <span class="c1">#f.flush()</span>
                <span class="c1">#df.to_csv(f)</span>
            <span class="c1">#    f.write(&quot;index &quot;)</span>
            <span class="c1">#    f.write(df.to_string(index_names=False)+&#39;\n&#39;)</span>
            <span class="n">write_df_tpl</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">),</span><span class="n">df</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>

        <span class="n">par_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">par_dfs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;spatial_bc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_df</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;spatial_bc_pars.dat&quot;</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_bc_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing spatial_bc_props&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="c1"># def setup_all_wells(self):</span>
    <span class="c1">#     &quot;&quot;&quot;helper to setup crazy numbers of well flux multipliers&quot;&quot;&quot;</span>
    <span class="c1">#     self.log(&quot;setup all wells parameterization&quot;)</span>
    <span class="c1">#     if self.m.wel is None:</span>
    <span class="c1">#         self.logger.lraise(&quot;setup_all_wells() requires a wel pak&quot;)</span>
    <span class="c1">#     pak, attr, col = self.parse_pakattr(&quot;wel.flux&quot;)</span>
    <span class="c1">#     k_parse = self.parse_k(np.arange(self.m.nper), np.arange(self.m.nper))</span>
    <span class="c1">#     bc_filenames = []</span>
    <span class="c1">#     for k in k_parse:</span>
    <span class="c1">#         bc_filenames.append(self.bc_helper(k, pak, attr, col))</span>
    <span class="c1">#     parnme = []</span>
    <span class="c1">#     for bc_filename in bc_filenames:</span>
    <span class="c1">#         bc_filename = os.path.split(bc_filename)[-1]</span>
    <span class="c1">#         kper = int(bc_filename.split(&#39;.&#39;)[0].split(&#39;_&#39;)[1])</span>
    <span class="c1">#         df = pd.read_csv(os.path.join(self.m.model_ws,self.bc_org,bc_filename),</span>
    <span class="c1">#                          delim_whitespace=True,header=None,names=[&#39;l&#39;,&#39;r&#39;,&#39;c&#39;,&#39;flux&#39;])</span>
    <span class="c1">#         mlt_file = os.path.join(self.m.model_ws, self.bc_mlt, bc_filename)</span>
    <span class="c1">#         df.loc[:,&quot;flux&quot;] = 1.0</span>
    <span class="c1">#         df.to_csv(mlt_file,sep=&#39; &#39;,index=False,header=False)</span>
    <span class="c1">#         df.loc[:,&quot;parnme&quot;] = [&quot;wf{0:04d}_{1:03d}&quot;.format(i,kper) for i in range(df.shape[0])]</span>
    <span class="c1">#         parnme.extend(list(df.parnme))</span>
    <span class="c1">#         df.loc[:,&quot;tpl_str&quot;] = df.parnme.apply(lambda x: &quot;~  {0}   ~&quot;.format(x))</span>
    <span class="c1">#         tpl_file = os.path.join(self.m.model_ws,bc_filename+&quot;.tpl&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#         self.logger.statement(&quot;writing tpl file &quot;+tpl_file)</span>
    <span class="c1">#         with open(tpl_file,&#39;w&#39;) as f:</span>
    <span class="c1">#             f.write(&quot;ptf ~\n&quot;)</span>
    <span class="c1">#             f.write(df.loc[:,[&#39;l&#39;,&#39;r&#39;,&#39;c&#39;,&#39;tpl_str&#39;]].to_string(index=False,header=False)+&#39;\n&#39;)</span>
    <span class="c1">#         self.tpl_files.append(os.path.split(tpl_file)[-1])</span>
    <span class="c1">#         self.in_files.append(os.path.join(self.bc_mlt, bc_filename))</span>
    <span class="c1">#</span>
    <span class="c1">#     df = pd.DataFrame({&quot;parnme&quot;:parnme}, index=parnme)</span>
    <span class="c1">#     df.loc[:,&quot;parubnd&quot;] = 1.2</span>
    <span class="c1">#     df.loc[:,&quot;parlbnd&quot;] = 0.8</span>
    <span class="c1">#     df.loc[:,&quot;pargp&quot;] = df.parnme.apply(lambda x: &quot;wflux_{0}&quot;.format(x.split(&#39;_&#39;)[-1]))</span>
    <span class="c1">#     self.par_dfs[&quot;wel_flux&quot;] = df</span>
    <span class="c1">#     self.frun_pre_lines.append(&quot;pyemu.helpers.apply_all_wells()&quot;)</span>
    <span class="c1">#     self.log(&quot;setup all wells parameterization&quot;)</span>


<div class="viewcode-block" id="PstFromFlopyModel.bc_helper"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.bc_helper">[docs]</a>    <span class="k">def</span> <span class="nf">bc_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; helper to setup boundary condition multiplier parameters for a given</span>
<span class="sd">        k, pak, attr set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : int or iterable of int</span>
<span class="sd">            the zero-based stress period indices</span>
<span class="sd">        pak : flopy.PakBase=</span>
<span class="sd">            the MODFLOW package</span>
<span class="sd">        attr : MfList</span>
<span class="sd">            the MfList instance</span>
<span class="sd">        col : str</span>
<span class="sd">            the column name in the MfList recarray to parameterize</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># special case for horrible HFB6 exception</span>
        <span class="c1"># if type(pak) == flopy.modflow.mfhfb.ModflowHfb:</span>
        <span class="c1">#     filename = pak.file_name[0]</span>
        <span class="c1"># else:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">filename_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">filename_model</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_org</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filename_model</span></div>


<div class="viewcode-block" id="PstFromFlopyModel.setup_hds"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_hds">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup modflow head save file observations for given kper (zero-based</span>
<span class="sd">        stress period index) and k (zero-based layer index) pairs using the</span>
<span class="sd">        kperk argument.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">            this can setup a shit-ton of observations</span>

<span class="sd">            this is useful for dataworth analyses or for monitoring</span>
<span class="sd">            water levels as forecasts</span>



<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">.gw_utils</span> <span class="k">import</span> <span class="n">setup_hds_obs</span>
        <span class="c1"># if len(self.hds_kperk) == 2:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         if len(self.hds_kperk[0] == 2):</span>
        <span class="c1">#             pass</span>
        <span class="c1">#     except:</span>
        <span class="c1">#         self.hds_kperk = [self.hds_kperk]</span>
        <span class="n">oc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="s2">&quot;OC&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;can&#39;t find OC package in model to setup hds grid obs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">oc</span><span class="o">.</span><span class="n">savehead</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;OC not saving hds, can&#39;t setup grid obs&quot;</span><span class="p">)</span>
        <span class="n">hds_unit</span> <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">iuhead</span>
        <span class="n">hds_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">hds_unit</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">)),</span>\
        <span class="s2">&quot;couldn&#39;t find existing hds file </span><span class="si">{0}</span><span class="s2"> in org_model_ws&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">))</span>
        <span class="n">inact</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lpf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lpf</span><span class="o">.</span><span class="n">hdry</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">upw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">upw</span><span class="o">.</span><span class="n">hdry</span>
        <span class="k">if</span> <span class="n">inact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">hnoflo</span> <span class="k">else</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">hnoflo</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">==</span> <span class="n">inact</span> <span class="k">else</span> <span class="n">x</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">)</span>
        <span class="n">frun_line</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">setup_hds_obs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">),</span>
                      <span class="n">kperk_pairs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">,</span><span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;hds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.gw_utils.apply_hds_obs(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hds_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_smp"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_smp">[docs]</a>    <span class="k">def</span> <span class="nf">setup_smp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup observations from PEST-style SMP file pairs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">obs_smp</span><span class="p">,</span><span class="n">sim_smp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> smp files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">,</span><span class="n">sim_smp</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find obs smp: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find sim smp: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">))</span>
            <span class="n">new_obs_smp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">,</span><span class="n">new_obs_smp</span><span class="p">)</span>
            <span class="n">new_sim_smp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">,</span><span class="n">new_sim_smp</span><span class="p">)</span>
            <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">smp_to_ins</span><span class="p">(</span><span class="n">new_sim_smp</span><span class="p">)</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_hob"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_hob">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup observations from the MODFLOW HOB package</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hob</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">hob_out_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hob</span><span class="o">.</span><span class="n">iuhobsv</span>
        <span class="c1">#hob_out_fname = os.path.join(self.m.model_ws,self.m.get_output_attribute(unit=hob_out_unit))</span>
        <span class="n">hob_out_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_output_attribute</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">hob_out_unit</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;could not find hob out file: </span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">hob_df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">modflow_hob_to_instruction_file</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;hob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hob_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">))</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_hyd"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_hyd">[docs]</a>    <span class="k">def</span> <span class="nf">setup_hyd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup observations from the MODFLOW HYDMOD package</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hyd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">org_hyd_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.hyd.bin&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;can&#39;t find existing hyd out file:</span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">new_hyd_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">,</span><span class="n">new_hyd_out</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">modflow_hydmod_to_instruction_file</span><span class="p">(</span><span class="n">new_hyd_out</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.modflow_read_hydmod_file(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_hyd_out</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;hyd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_hyd_out</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.setup_water_budget_obs"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.PstFromFlopyModel.setup_water_budget_obs">[docs]</a>    <span class="k">def</span> <span class="nf">setup_water_budget_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup observations from the MODFLOW list file for</span>
<span class="sd">        volume and flux water buget information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mflist_waterbudget</span><span class="p">:</span>
            <span class="n">org_listfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;can&#39;t find existing list file:</span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="n">list_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">flx_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;flux.dat&quot;</span><span class="p">)</span>
            <span class="n">vol_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;vol.dat&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_mflist_budget_obs</span><span class="p">(</span><span class="n">list_file</span><span class="p">,</span>
                                                                <span class="n">flx_filename</span><span class="o">=</span><span class="n">flx_file</span><span class="p">,</span>
                                                                <span class="n">vol_filename</span><span class="o">=</span><span class="n">vol_file</span><span class="p">,</span>
                                                                <span class="n">start_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;wb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="c1">#line = &quot;try:\n    os.remove(&#39;{0}&#39;)\nexcept:\n    pass&quot;.format(os.path.split(list_file)[-1])</span>
            <span class="c1">#self.logger.statement(&quot;forward_run line:{0}&quot;.format(line))</span>
            <span class="c1">#self.frun_pre_lines.append(line)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">list_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.apply_mflist_budget_obs(&#39;</span><span class="si">{0}</span><span class="s2">&#39;,flx_filename=&#39;</span><span class="si">{1}</span><span class="s2">&#39;,vol_filename=&#39;</span><span class="si">{2}</span><span class="s2">&#39;,start_datetime=&#39;</span><span class="si">{3}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">list_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">flx_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vol_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="apply_array_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.apply_array_pars">[docs]</a><span class="k">def</span> <span class="nf">apply_array_pars</span><span class="p">(</span><span class="n">arr_par_file</span><span class="o">=</span><span class="s2">&quot;arr_pars.csv&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a function to apply array-based multipler parameters.  Used to implement</span>
<span class="sd">    the parameterization constructed by PstFromFlopyModel during a forward run</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr_par_file : str</span>
<span class="sd">    path to csv file detailing parameter array multipliers</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    &quot;arr_pars.csv&quot; - is written by PstFromFlopy</span>

<span class="sd">    the function should be added to the forward_run.py script but can be called on any correctly formatted csv</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">arr_par_file</span><span class="p">)</span>
    <span class="c1"># for fname in df.model_file:</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         os.remove(fname)</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         print(&quot;error removing mult array:{0}&quot;.format(fname))</span>

    <span class="k">if</span> <span class="s1">&#39;pp_file&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pp_file</span><span class="p">,</span><span class="n">fac_file</span><span class="p">,</span><span class="n">mlt_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pp_file</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">fac_file</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">pp_file</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">fac2real</span><span class="p">(</span><span class="n">pp_file</span><span class="o">=</span><span class="n">pp_file</span><span class="p">,</span><span class="n">factors_file</span><span class="o">=</span><span class="n">fac_file</span><span class="p">,</span>
                                    <span class="n">out_file</span><span class="o">=</span><span class="n">mlt_file</span><span class="p">,</span><span class="n">lower_lim</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">model_file</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">model_file</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="c1"># find all mults that need to be applied to this array</span>
        <span class="n">df_mf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">model_file</span><span class="o">==</span><span class="n">model_file</span><span class="p">,:]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">org_file</span> <span class="o">=</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">org_file</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">org_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;wrong number of org_files for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                            <span class="nb">format</span><span class="p">(</span><span class="n">model_file</span><span class="p">))</span>
        <span class="n">org_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">org_file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">mlt</span> <span class="ow">in</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">:</span>
            <span class="n">org_arr</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;upper_bound&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">ub_vals</span> <span class="o">=</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">upper_bound</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ub_vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ub_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;different upper bound values for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">org_file</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ub_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">org_arr</span><span class="p">[</span><span class="n">org_arr</span><span class="o">&gt;</span><span class="n">ub</span><span class="p">]</span> <span class="o">=</span> <span class="n">ub</span>
        <span class="k">if</span> <span class="s2">&quot;lower_bound&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">lb_vals</span> <span class="o">=</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">lower_bound</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lb_vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lb_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;different lower bound values for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">org_file</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lb_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">org_arr</span><span class="p">[</span><span class="n">org_arr</span> <span class="o">&lt;</span> <span class="n">lb</span><span class="p">]</span> <span class="o">=</span> <span class="n">lb</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span><span class="n">org_arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="apply_bc_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.apply_bc_pars">[docs]</a><span class="k">def</span> <span class="nf">apply_bc_pars</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; a function to apply boundary condition multiplier parameters.  Used to implement</span>
<span class="sd">    the parameterization constructed by PstFromFlopyModel during a forward run</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    requires &quot;bc_pars.csv&quot;</span>

<span class="sd">    should be added to the forward_run.py script</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_file</span> <span class="o">=</span> <span class="s2">&quot;temporal_bc_pars.dat&quot;</span>
    <span class="n">spat_file</span> <span class="o">=</span> <span class="s2">&quot;spatial_bc_pars.dat&quot;</span>

    <span class="n">temp_df</span><span class="p">,</span><span class="n">spat_df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_file</span><span class="p">):</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;split_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">org_dir</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">bc_org</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">model_ext_path</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">model_ext_path</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">spat_file</span><span class="p">):</span>
        <span class="n">spat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">spat_file</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spat_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;split_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mlt_dir</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">bc_mlt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">org_dir</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">bc_org</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">model_ext_path</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">model_ext_path</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">temp_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spat_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;apply_bc_pars() - no key dfs found, nothing to do...&quot;</span><span class="p">)</span>
    <span class="c1"># load the spatial mult dfs</span>
    <span class="n">sp_mlts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">spat_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mlt_dir</span><span class="p">):</span>
            <span class="n">pak</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mlt_dir</span><span class="p">,</span><span class="n">f</span><span class="p">),</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#if pak != &#39;hfb6&#39;:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:02.0f}{1:04.0f}{2:04.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     df.index = df.apply(lambda x: &quot;{0:02.0f}{1:04.0f}{2:04.0f}{2:04.0f}{2:04.0f}&quot;.format(x.k, x.irow1, x.icol1,</span>
            <span class="c1">#                                                                      x.irow2, x.icol2), axis = 1)</span>
            <span class="k">if</span> <span class="n">pak</span> <span class="ow">in</span> <span class="n">sp_mlts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;duplicate multplier csv for pak </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;empty dataframe for spatial bc file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">sp_mlts</span><span class="p">[</span><span class="n">pak</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">org_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">org_dir</span><span class="p">)</span>
    <span class="c1">#for fname in df.filename.unique():</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">org_files</span><span class="p">:</span>
        <span class="c1"># need to get the PAK name to handle stupid horrible expceptions for HFB...</span>
        <span class="c1"># try:</span>
        <span class="c1">#     pakspat = sum([True if fname in i else False for i in spat_df.filename])</span>
        <span class="c1">#     if pakspat:</span>
        <span class="c1">#         pak = spat_df.loc[spat_df.filename.str.contains(fname)].pak.values[0]</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         pak = &#39;notHFB&#39;</span>
        <span class="c1"># except:</span>
        <span class="c1">#     pak = &quot;notHFB&quot;</span>

        <span class="n">names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">temp_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">split_filename</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">temp_df_fname</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temp_df</span><span class="o">.</span><span class="n">split_filename</span><span class="o">==</span><span class="n">fname</span><span class="p">,:]</span>
            <span class="k">if</span> <span class="n">temp_df_fname</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">temp_df_fname</span><span class="o">.</span><span class="n">dtype_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spat_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">split_filename</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">spat_df_fname</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spat_df</span><span class="o">.</span><span class="n">split_filename</span> <span class="o">==</span> <span class="n">fname</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">spat_df_fname</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">spat_df_fname</span><span class="o">.</span><span class="n">dtype_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># if pak == &#39;hfb6&#39;:</span>
            <span class="c1">#     # ugh - need to yank out the header rows if HFB6</span>
            <span class="c1">#     tmpfn = spat_df.loc[spat_df.pak == pak, :].filename.values[0]</span>
            <span class="c1">#     skiprows = sum(</span>
            <span class="c1">#         [1 if i.strip().startswith(&#39;#&#39;) else 0</span>
            <span class="c1">#          for i in open(os.path.join(org_dir, tmpfn), &#39;r&#39;).readlines()]) + 1</span>
            <span class="c1">#     headrows = [&#39;{}\n&#39;.format(i.strip()) for i in open(os.path.join(org_dir, tmpfn), &#39;r&#39;).readlines()[:skiprows]]</span>
            <span class="c1">#     df_list = pd.read_csv(os.path.join(org_dir, fname),</span>
            <span class="c1">#                           delim_whitespace=True, header=None, names=names, skiprows=skiprows).dropna()</span>
            <span class="c1">#     df_list.loc[:, &quot;idx&quot;] = df_list.apply(</span>
            <span class="c1">#         lambda x: &quot;{0:02.0f}{1:04.0f}{2:04.0f}{2:04.0f}{2:04.0f}&quot;.format(x.k, x.irow1, x.icol1,</span>
            <span class="c1">#                                                                          x.irow2, x.icol2), axis=1)</span>
            <span class="c1">#     footrows = &#39;{}\n&#39;.format(open(os.path.join(org_dir, fname), &#39;r&#39;).readlines()[-1].strip())</span>
            <span class="c1"># else:</span>
            <span class="n">df_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">org_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                                  <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:02.0f}{1:04.0f}{2:04.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


            <span class="n">df_list</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">idx</span>
            <span class="n">pak_name</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pak_name</span> <span class="ow">in</span> <span class="n">sp_mlts</span><span class="p">:</span>
                <span class="n">mlt_df</span> <span class="o">=</span> <span class="n">sp_mlts</span><span class="p">[</span><span class="n">pak_name</span><span class="p">]</span>
                <span class="n">mlt_df_ri</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_list</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_list</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="s2">&quot;j&quot;</span><span class="p">,</span><span class="s2">&quot;inode&quot;</span><span class="p">,</span><span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">,</span><span class="s1">&#39;idx&#39;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                       <span class="c1"># print(mlt_df.loc[mlt_df.index.duplicated(),:])</span>
                       <span class="c1"># print(df_list.loc[df_list.index.duplicated(),:])</span>
                        <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mlt_df_ri</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">if</span> <span class="n">temp_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">split_filename</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">temp_df_fname</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temp_df</span><span class="o">.</span><span class="n">split_filename</span> <span class="o">==</span> <span class="n">fname</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">temp_df_fname</span><span class="o">.</span><span class="n">col</span><span class="p">,</span><span class="n">temp_df_fname</span><span class="o">.</span><span class="n">val</span><span class="p">):</span>
                     <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">val</span>
            <span class="c1">#fmts = {}</span>
            <span class="n">fmts</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="s2">&quot;j&quot;</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="s2">&quot;inode&quot;</span><span class="p">,</span><span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">]:</span>
                    <span class="c1">#fmts[name] = pyemu.pst_utils.IFMT</span>
                    <span class="c1">#fmts[name] = lambda x: &quot; {0:&gt;9.0f}&quot;.format(x)</span>
                    <span class="n">fmts</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%9d</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#fmts[name] = pyemu.pst_utils.FFMT</span>
                    <span class="c1">#fmts[name] = lambda x: &quot; {0:&gt;9G}&quot;.format(x)</span>
                    <span class="n">fmts</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%9G</span><span class="s2">&quot;</span>
        <span class="c1"># if pak == &#39;hfb6&#39;:</span>
        <span class="c1">#     np.savetxt(os.path.join(model_ext_path, fname), df_list.loc[:, names].as_matrix(), fmt=fmts,</span>
        <span class="c1">#                header=&#39;&#39;.join(headrows), footer=footrows)</span>
        <span class="c1"># else:</span>
        <span class="c1">#np.savetxt(os.path.join(model_ext_path, fname), df_list.loc[:, names].as_matrix(), fmt=fmts)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ext_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmts</span><span class="p">)</span></div>
            <span class="c1">#with open(os.path.join(model_ext_path,fname),&#39;w&#39;) as f:</span>
        <span class="c1">#    f.write(df_list.loc[:,names].to_string(header=False,index=False,formatters=fmts)+&#39;\n&#39;)</span>
            <span class="c1">#df_list.to_csv(os.path.join(model_ext_path,fname),index=False,header=False)</span>

<span class="c1"># def apply_all_wells():</span>
<span class="c1">#</span>
<span class="c1">#     mlt_dir = &quot;bc_mlt&quot;</span>
<span class="c1">#     org_dir = &quot;bc_org&quot;</span>
<span class="c1">#     names = [&quot;l&quot;,&quot;r&quot;,&quot;c&quot;,&quot;flux&quot;]</span>
<span class="c1">#     fmt = {&quot;flux&quot;: pyemu.pst_utils.FFMT}</span>
<span class="c1">#     for c in names[:-1]:</span>
<span class="c1">#         fmt[c] = pyemu.pst_utils.IFMT</span>
<span class="c1">#     if not os.path.exists(mlt_dir) or not os.path.exists(org_dir):</span>
<span class="c1">#         return</span>
<span class="c1">#     mlt_files = os.listdir(mlt_dir)</span>
<span class="c1">#     for f in mlt_files:</span>
<span class="c1">#         if not &quot;wel&quot; in f.lower():</span>
<span class="c1">#             continue</span>
<span class="c1">#         org_file = os.path.join(org_dir,f)</span>
<span class="c1">#         mlt_file = os.path.join(mlt_dir,f)</span>
<span class="c1">#         df_org = pd.read_csv(org_file,header=None,delim_whitespace=True,names=names)</span>
<span class="c1">#         df_mlt = pd.read_csv(mlt_file,header=None,delim_whitespace=True,names=names)</span>
<span class="c1">#         assert df_org.shape == df_mlt.shape</span>
<span class="c1">#         df_org.iloc[:,-1] *= df_mlt.iloc[:,-1]</span>
<span class="c1">#         with open(f,&#39;w&#39;) as fi:</span>
<span class="c1">#             fi.write(df_org.to_string(index=False,header=False,formatters=fmt)+&#39;\n&#39;)</span>

<div class="viewcode-block" id="apply_hfb_pars"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.apply_hfb_pars">[docs]</a><span class="k">def</span> <span class="nf">apply_hfb_pars</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; a function to apply HFB multiplier parameters.  Used to implement</span>
<span class="sd">    the parameterization constructed by write_hfb_zone_multipliers_template()</span>

<span class="sd">    This is to account for the horrible HFB6 format that differs from other BCs making this a special case</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    requires &quot;hfb_pars.csv&quot;</span>

<span class="sd">    should be added to the forward_run.py script</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hfb_pars</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;hfb6_pars.csv&#39;</span><span class="p">)</span>

    <span class="n">hfb_mults_contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">hfb_pars</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">skiprows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hfb_mults_contents</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hfb_mults_contents</span><span class="p">[:</span><span class="n">skiprows</span><span class="p">]</span>

    <span class="c1"># read in the multipliers</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span> <span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">,</span> <span class="s1">&#39;hydchr&#39;</span><span class="p">]</span>
    <span class="n">hfb_mults</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">hfb_pars</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">skiprows</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">hfb_mults</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="o">=</span> <span class="n">hfb_mults</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="c1"># read in the original file</span>
    <span class="n">hfb_org</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">hfb_pars</span><span class="o">.</span><span class="n">org_file</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">skiprows</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># multiply it out</span>
    <span class="n">hfb_org</span><span class="o">.</span><span class="n">hydchr</span> <span class="o">*=</span> <span class="n">hfb_mults</span><span class="o">.</span><span class="n">hydchr</span>

    <span class="c1"># write the results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hfb_pars</span><span class="o">.</span><span class="n">model_file</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="p">[</span><span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>

        <span class="n">hfb_org</span><span class="p">[[</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span> <span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">,</span> <span class="s1">&#39;hydchr&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ofp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_flopy_par_ensemble"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.plot_flopy_par_ensemble">[docs]</a><span class="k">def</span> <span class="nf">plot_flopy_par_ensemble</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">pe</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fig_axes_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">pcolormesh_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;function to plot ensemble of parameter values for a flopy/modflow model.  Assumes</span>
<span class="sd">    the FlopytoPst helper was used to setup the model and the forward run.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        pst : Pst instance</span>

<span class="sd">        pe : ParameterEnsemble instance</span>

<span class="sd">        num_reals : int</span>
<span class="sd">            number of realizations to process.  If None, all realizations are processed.</span>
<span class="sd">            default is None</span>
<span class="sd">        model : flopy.mbase</span>
<span class="sd">            model instance used for masking inactive areas and also geo-locating plots.  If None,</span>
<span class="sd">            generic plots are made.  Default is None.</span>
<span class="sd">        fig_axes_generator : function</span>
<span class="sd">            a function that returns a pyplot.figure and list of pyplot.axes instances for plots.</span>
<span class="sd">            If None, a generic 8.5inX11in figure with 3 rows and 2 cols is used.</span>
<span class="sd">        pcolormesh_transform : cartopy.csr.CRS</span>
<span class="sd">            transform to map pcolormesh plot into correct location.  Requires model arg</span>


<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">        Needs &quot;arr_pars.csv&quot; to run</span>

<span class="sd">    Todo</span>
<span class="sd">    ----</span>
<span class="sd">        add better support for log vs nonlog- currently just logging everything</span>
<span class="sd">        add support for cartopy basemap and stamen tiles</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error import matplotlib: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="k">import</span> <span class="n">PdfPages</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;arr_pars.csv&quot;</span><span class="p">),</span><span class="s2">&quot;couldn&#39;t find arr_pars.csv, can&#39;t continue&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;arr_pars.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_reals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_reals</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">arr_dict</span><span class="p">,</span><span class="n">arr_mx</span><span class="p">,</span><span class="n">arr_mn</span> <span class="o">=</span> <span class="p">{},{},{}</span>

    <span class="n">islog</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">ib</span><span class="p">,</span><span class="n">sr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">load_only</span><span class="o">=</span><span class="p">[],</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">bas6</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">nlay</span><span class="p">)}</span>
            <span class="n">sr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sr</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">btn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_reals</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span><span class="s2">&quot;processing realization number </span><span class="si">{0}</span><span class="s2"> of </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">num_reals</span><span class="p">))</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="s2">&quot;parval1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">write_input_files</span><span class="p">()</span>
        <span class="n">apply_array_pars</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">model_file</span><span class="p">,</span><span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">model_file</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">layer</span><span class="p">):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">islog</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="n">arr</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">arr_dict</span><span class="p">[</span><span class="n">model_file</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">arr_mx</span><span class="p">[</span><span class="n">model_file</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0e+10</span>
                <span class="n">arr_mn</span><span class="p">[</span><span class="n">model_file</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e+10</span>
            <span class="n">arr_mx</span><span class="p">[</span><span class="n">model_file</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arr_mx</span><span class="p">[</span><span class="n">model_file</span><span class="p">],</span><span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">arr_mn</span><span class="p">[</span><span class="n">model_file</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">arr_mn</span><span class="p">[</span><span class="n">model_file</span><span class="p">],</span><span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

            <span class="n">arr_dict</span><span class="p">[</span><span class="n">model_file</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>




    <span class="k">def</span> <span class="nf">_get_fig_and_axes</span><span class="p">():</span>
        <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">8.5</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
        <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span><span class="n">axes</span>

    <span class="k">if</span> <span class="n">fig_axes_generator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig_axes_generator</span> <span class="o">=</span> <span class="n">_get_fig_and_axes</span>

    <span class="k">for</span> <span class="n">model_file</span><span class="p">,</span><span class="n">arrs</span> <span class="ow">in</span> <span class="n">arr_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">model_file</span><span class="o">==</span><span class="n">model_file</span><span class="p">,</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;plotting arrays for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_file</span><span class="p">))</span>
        <span class="n">mx</span><span class="p">,</span><span class="n">mn</span> <span class="o">=</span> <span class="n">arr_mx</span><span class="p">[</span><span class="n">model_file</span><span class="p">],</span><span class="n">arr_mn</span><span class="p">[</span><span class="n">model_file</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">model_file</span><span class="o">+</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">axes</span> <span class="o">=</span> <span class="n">fig_axes_generator</span><span class="p">()</span>
            <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrs</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">ax_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>

                    <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">fig_axes_generator</span><span class="p">()</span>
                    <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1">#ax = plt.subplot(111)</span>
                <span class="k">if</span> <span class="n">sr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">,</span><span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">mx</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span>
                                                  <span class="n">transform</span><span class="o">=</span><span class="n">pcolormesh_transform</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">mx</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">mn</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">islog</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">arr</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;real index:</span><span class="si">{0}</span><span class="s2">, max:</span><span class="si">{1:5.2E}</span><span class="s2">, min:</span><span class="si">{2:5.2E}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                         <span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

                <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arrs</span><span class="p">)</span>
            <span class="n">arr_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">lab</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span><span class="s2">&quot;std&quot;</span><span class="p">],[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]):</span>
                <span class="k">if</span> <span class="n">ib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="n">arr</span><span class="p">)</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
                <span class="n">arr_dict</span><span class="p">[</span><span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
                <span class="k">if</span> <span class="n">ax_count</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>

                    <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">fig_axes_generator</span><span class="p">()</span>
                    <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">sr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">,</span><span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span>
                                                  <span class="n">transform</span><span class="o">=</span><span class="n">pcolormesh_transform</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">, max:</span><span class="si">{1:5.2E}</span><span class="s2">, min:</span><span class="si">{2:5.2E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span><span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
                <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrs</span><span class="p">):</span>
                    <span class="n">arr_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">arr</span>
                <span class="n">flopy</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">shapefile_utils</span><span class="o">.</span><span class="n">write_grid_shapefile</span><span class="p">(</span><span class="n">model_file</span><span class="o">+</span><span class="s2">&quot;.shp&quot;</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="n">array_dict</span><span class="o">=</span><span class="n">arr_dict</span><span class="p">)</span>

    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_istextfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="mi">512</span><span class="p">):</span>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function found from:</span>
<span class="sd">        https://eli.thegreenplace.net/2011/10/19/perls-guess-if-file-is-text-or-binary-implemented-in-python</span>

<span class="sd">        Returns True if file is most likely a text file</span>
<span class="sd">        Returns False if file is most likely a binary file</span>

<span class="sd">        Uses heuristics to guess whether the given file is text or binary,</span>
<span class="sd">        by reading a single block of bytes from the file.</span>
<span class="sd">        If more than 30% of the chars in the block are non-text, or there</span>
<span class="sd">        are NUL (&#39;\x00&#39;) bytes in the block, assume this is a binary file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">PY3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="c1"># A function that takes an integer in the 8-bit range and returns</span>
    <span class="c1"># a single-character byte object in py3 / a single-character string</span>
    <span class="c1"># in py2.</span>
    <span class="c1">#</span>
    <span class="n">int2byte</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">((</span><span class="n">x</span><span class="p">,)))</span> <span class="k">if</span> <span class="n">PY3</span> <span class="k">else</span> <span class="nb">chr</span>

    <span class="n">_text_characters</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">int2byte</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">127</span><span class="p">))</span> <span class="o">+</span>
        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n\r\t\f\b</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
        <span class="c1"># Files with null bytes are binary</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">block</span><span class="p">:</span>
        <span class="c1"># An empty file is considered a valid text file</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Use translate&#39;s &#39;deletechars&#39; argument to efficiently remove all</span>
    <span class="c1"># occurrences of _text_characters from the block</span>
    <span class="n">nontext</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">_text_characters</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nontext</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.30</span>



<div class="viewcode-block" id="plot_summary_distributions"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.plot_summary_distributions">[docs]</a><span class="k">def</span> <span class="nf">plot_summary_distributions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">label_post</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">label_prior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">subplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mf">8.5</span><span class="p">),</span><span class="n">pt_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper function to plot gaussian distrbutions from prior and posterior</span>
<span class="sd">    means and standard deviations</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        a dataframe and csv file.  Must have columns named:</span>
<span class="sd">        &#39;prior_mean&#39;,&#39;prior_stdev&#39;,&#39;post_mean&#39;,&#39;post_stdev&#39;.  If loaded</span>
<span class="sd">        from a csv file, column 0 is assumed to tbe the index</span>
<span class="sd">    ax: matplotlib.pyplot.axis</span>
<span class="sd">        If None, and not subplots, then one is created</span>
<span class="sd">        and all distributions are plotted on a single plot</span>
<span class="sd">    label_post: bool</span>
<span class="sd">        flag to add text labels to the peak of the posterior</span>
<span class="sd">    label_prior: bool</span>
<span class="sd">        flag to add text labels to the peak of the prior</span>
<span class="sd">    subplots: (boolean)</span>
<span class="sd">        flag to use subplots.  If True, then 6 axes per page</span>
<span class="sd">        are used and a single prior and posterior is plotted on each</span>
<span class="sd">    figsize: tuple</span>
<span class="sd">        matplotlib figure size</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    figs : list</span>
<span class="sd">        list of figures</span>
<span class="sd">    axes : list</span>
<span class="sd">        list of axes</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This is useful for demystifying FOSM results</span>

<span class="sd">    if subplots is False, a single axis is returned</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    ``&gt;&gt;&gt;import matplotlib.pyplot as plt``</span>

<span class="sd">    ``&gt;&gt;&gt;import pyemu``</span>

<span class="sd">    ``&gt;&gt;&gt;pyemu.helpers.plot_summary_distributions(&quot;pest.par.usum.csv&quot;)``</span>

<span class="sd">    ``&gt;&gt;&gt;plt.show()``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pyemu.helpers.plot_summary_distributions() has moved to plot_utils&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">pyemu</span> <span class="k">import</span> <span class="n">plot_utils</span>
    <span class="k">return</span> <span class="n">plot_utils</span><span class="o">.</span><span class="n">plot_summary_distributions</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">label_post</span><span class="o">=</span><span class="n">label_post</span><span class="p">,</span>
                                                 <span class="n">label_prior</span><span class="o">=</span><span class="n">label_prior</span><span class="p">,</span><span class="n">subplots</span><span class="o">=</span><span class="n">subplots</span><span class="p">,</span>
                                                 <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span><span class="n">pt_color</span><span class="o">=</span><span class="n">pt_color</span><span class="p">)</span></div>


<div class="viewcode-block" id="gaussian_distribution"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.gaussian_distribution">[docs]</a><span class="k">def</span> <span class="nf">gaussian_distribution</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">num_pts</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; get an x and y numpy.ndarray that spans the +/- 4</span>
<span class="sd">    standard deviation range of a gaussian distribution with</span>
<span class="sd">    a given mean and standard deviation. useful for plotting</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : float</span>
<span class="sd">        the mean of the distribution</span>
<span class="sd">    stdev : float</span>
<span class="sd">        the standard deviation of the distribution</span>
<span class="sd">    num_pts : int</span>
<span class="sd">        the number of points in the returned ndarrays.</span>
<span class="sd">        Default is 50</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x : numpy.ndarray</span>
<span class="sd">        the x-values of the distribution</span>
<span class="sd">    y : numpy.ndarray</span>
<span class="sd">        the y-values of the distribution</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pyemu.helpers.gaussian_distribution() has moved to plot_utils&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">pyemu</span> <span class="k">import</span> <span class="n">plot_utils</span>
    <span class="k">return</span> <span class="n">plot_utils</span><span class="o">.</span><span class="n">gaussian_distribution</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span><span class="n">stdev</span><span class="o">=</span><span class="n">stdev</span><span class="p">,</span><span class="n">num_pts</span><span class="o">=</span><span class="n">num_pts</span><span class="p">)</span></div>


<div class="viewcode-block" id="build_jac_test_csv"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.build_jac_test_csv">[docs]</a><span class="k">def</span> <span class="nf">build_jac_test_csv</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">num_steps</span><span class="p">,</span><span class="n">par_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; build a dataframe of jactest inputs for use with sweep</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pst : pyemu.Pst</span>

<span class="sd">    num_steps : int</span>
<span class="sd">        number of pertubation steps for each parameter</span>
<span class="sd">    par_names : list</span>
<span class="sd">        names of pars to test.  If None, all adjustable pars are used</span>
<span class="sd">        Default is None</span>
<span class="sd">    forward : bool</span>
<span class="sd">        flag to start with forward pertubations.  Default is True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        the index of the dataframe is par name and the parval used.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="c1">#pst.add_transform_columns()</span>
    <span class="n">pst</span><span class="o">.</span><span class="n">build_increments</span><span class="p">()</span>
    <span class="n">incr</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">irow</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="k">if</span> <span class="n">par_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">par_names</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span>
    <span class="n">total_runs</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">:</span>
        <span class="n">idx</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pst</span><span class="o">.</span><span class="n">par_names</span><span class="p">)</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">partrans</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span>
    <span class="n">lbnd</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parlbnd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ubnd</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parubnd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">lbnd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbnd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="n">ubnd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">ubnd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="n">lbnd</span> <span class="o">=</span> <span class="n">lbnd</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">ubnd</span> <span class="o">=</span> <span class="n">ubnd</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="n">org_vals</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">org_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">org_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">forward</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="c1"># base case goes in as first row, no perturbations</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">,</span><span class="n">pst</span><span class="o">.</span><span class="n">par_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">irow</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">full_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">jcol</span><span class="p">,</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">par_names</span><span class="p">):</span>
        <span class="n">org_val</span> <span class="o">=</span> <span class="n">org_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span>
        <span class="n">last_val</span> <span class="o">=</span> <span class="n">org_val</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">org_vals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">incr</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span>


            <span class="n">val</span> <span class="o">=</span> <span class="n">last_val</span> <span class="o">+</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">incr</span><span class="p">[</span><span class="n">par_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">ubnd</span><span class="p">[</span><span class="n">par_name</span><span class="p">]:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">org_val</span> <span class="o">+</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">incr</span><span class="p">[</span><span class="n">par_name</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">lbnd</span><span class="p">[</span><span class="n">par_name</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;parameter </span><span class="si">{0}</span><span class="s2"> went out of bounds&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">par_name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">lbnd</span><span class="p">[</span><span class="n">par_name</span><span class="p">]:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">org_val</span> <span class="o">+</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">incr</span><span class="p">[</span><span class="n">par_name</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">ubnd</span><span class="p">[</span><span class="n">par_name</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;parameter </span><span class="si">{0}</span><span class="s2"> went out of bounds&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">par_name</span><span class="p">))</span>

            <span class="n">vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">irow</span><span class="p">],</span><span class="n">pst</span><span class="o">.</span><span class="n">par_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
            <span class="n">full_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1:&lt;15.6E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span><span class="n">vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par_name</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">irow</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">last_val</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">full_names</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="write_df_tpl"><a class="viewcode-back" href="../../../source/pyemu.utils.html#pyemu.utils.helpers.write_df_tpl">[docs]</a><span class="k">def</span> <span class="nf">write_df_tpl</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">tpl_marker</span><span class="o">=</span><span class="s1">&#39;~&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;function write a pandas dataframe to a template file.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        template filename</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        dataframe to write</span>
<span class="sd">    sep : char</span>
<span class="sd">        separate to pass to df.to_csv(). default is &#39;,&#39;</span>
<span class="sd">    tpl_marker : char</span>
<span class="sd">        template file marker.  default is &#39;~&#39;</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        additional keyword args to pass to df.to_csv()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    If you don&#39;t use this function, make sure that you flush the</span>
<span class="sd">    file handle before df.to_csv() and you pass mode=&#39;a&#39; to to_csv()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_marker</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>









</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Jeremy White, Mike Fienen, John Doherty.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>